<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Funkin Launcher</title>
        <link rel="icon" type="image/x-icon" href="https://codehs.com/uploads/b5948a303d5f9ea18da1c1dfbe772696"/>
    </head>

    <body style="background-color:black;">
        <script type="module">
            import * as Phaser from 'https://cdn.jsdelivr.net/npm/phaser/dist/phaser.esm.min.js';
            // import * as WebFontLoader from 'https://cdn.jsdelivr.net/npm/phaser3-rex-plugins/dist/rexwebfontloaderplugin.min.js';

            class Constants
            {
                static TITLE = "Friday Night Funkin'";
                static VERSION = '0.4.1';

                static SCREEN_WIDTH = 1280;
                static SCREEN_HEIGHT = 720;

                static COLOR_HEALTH_BAR_RED = 0xffff0000;
                static COLOR_HEALTH_BAR_GREEN = 0xff66ff33;

                static DEFAULT_DIFFICULTY = 'normal';
                static DEFAULT_DIFFICULTY_LIST = ['easy', 'normal', 'hard'];
                static DEFAULT_DIFFICULTY_LIST_FULL = ['easy', 'normal', 'hard', 'erect', 'nightmare'];
                static DEFAULT_DIFFICULTY_LIST_ERECT = ['erect', 'nightmare'];

                static DEFAULT_CHARACTER = 'bf';
                static DEFAULT_HEALTH_ICON = 'face';
                static DEFAULT_STAGE = 'Main Stage';
                static DEFAULT_SONG = 'tutorial';
                static DEFAULT_VARIATION = 'default';
                static DEFAULT_VARIATION_LIST = ['default', 'erect', 'pico'];

                static DEFAULT_BOP_INTENSITY = 1.015;
                static DEFAULT_ZOOM_RATE = 4;
                static DEFAULT_BPM = 100;

                static PIXELS_PER_MS = 0.45;
                static HIT_WINDOW_MS = 160;

                static HEALTH_MAX = 2;
                static HEALTH_STARTING = Constants.HEALTH_MAX / 2;
                static HEALTH_MIN = 0;

                static HEALTH_SICK_BONUS = 1.5 / 100.0 * Constants.HEALTH_MAX;
                static HEALTH_GOOD_BONUS = 0.75 / 100.0 * Constants.HEALTH_MAX;
                static HEALTH_BAD_BONUS = 0.0 / 100.0 * Constants.HEALTH_MAX;
                static HEALTH_SHIT_BONUS = -1.0 / 100.0 * Constants.HEALTH_MAX;
                static HEALTH_HOLD_BONUS_PER_SECOND = 7.5 / 100.0 * Constants.HEALTH_MAX;

                static HEALTH_MISS_PENALTY = 4.0 / 100.0 * Constants.HEALTH_MAX;
                static HEALTH_GHOST_MISS_PENALTY = 2.0 / 100.0 * Constants.HEALTH_MAX;
                static HEALTH_HOLD_DROP_PENALTY = 0.0;

                static SCORE_HOLD_BONUS_PER_SECOND = 250.0;

                static JUDGEMENT_SICK_COMBO_BREAK = false;
                static JUDGEMENT_GOOD_COMBO_BREAK = false;
                static JUDGEMENT_BAD_COMBO_BREAK = true;
                static JUDGEMENT_SHIT_COMBO_BREAK = true;

                // % Sick
                static RANK_PERFECT_PLAT_THRESHOLD = 1.0;
                static RANK_PERFECT_GOLD_THRESHOLD = 0.85;

                // % Hit
                static RANK_PERFECT_THRESHOLD = 1.00;
                static RANK_EXCELLENT_THRESHOLD = 0.90;
                static RANK_GREAT_THRESHOLD = 0.80;
                static RANK_GOOD_THRESHOLD = 0.60;

                static DOWN_SCROLL = false;
                static MIDDLE_SCROLL = false;
                static GHOST_TAPPING = false;
                static CAMERA_ZOOMING = true;
                
                static PIXEL_ART_SCALE = 6;
                static COUNTDOWN_VOLUME = 0.6;

                static STRUMLINE_X_OFFSET = 48;
                static STRUMLINE_Y_OFFSET = 24;
                
                static DEFAULT_CAMERA_FOLLOW_RATE = 0.04;
            }

            class TSMath
            {
                static baseLerp(current, target, precision)
                {
                    return current + precision * (target - current);
                }

                static lerp(current, target, precision)
                {
                    if (current == target) return target;

                    var result = TSMath.baseLerp(current, target, precision);
                    if (Math.abs(result - target) < (precision * target)) result = target;

                    return result;
                }

                static fpsLerp(a, b, ratio, elapsed = 1 / 60)
                {
                    return TSMath.baseLerp(a, b, ratio * (elapsed / (1 / 60)));
                }

                static remapToRange(value, low1, high1, low2, high2)
                {
                    return low2 + ((high2 - low2) * (value - low1)) / (high1 - low1);
                }
            }

            class CharacterRegistry
            {
                static characters = [];

                static initialize()
                {
                    CharacterRegistry.characters.push(new CharacterRegistry('bf', 'https://codehs.com/uploads/447fe09de793f7342abf803dcf34aa5f', 'https://codehs.com/uploads/b1fd607beaf5aa68392ade01249d49d4'));
                    CharacterRegistry.characters.push(new CharacterRegistry('gf', 'https://codehs.com/uploads/870a783464be986a9cdd2d751988e3df', 'https://codehs.com/uploads/341665976ca6158907951d4409104adb'));
                    CharacterRegistry.characters.push(new CharacterRegistry('dad', 'https://codehs.com/uploads/e010efb81c8a9e7ab599f2b482109cfe', 'https://codehs.com/uploads/1fb6a36297a1fc3dd0583ea8df069865'));

                    CharacterRegistry.characters.push(new CharacterRegistry('spooky', 'https://codehs.com/uploads/6afdbfc142313941f3e89d57ea8102c5', 'https://codehs.com/uploads/0ba5968f3bb1a21ee4e1c8ea34ca31f0'));
                    CharacterRegistry.characters.push(new CharacterRegistry('monster', 'https://codehs.com/uploads/8d3be70635cc14edaf86558a86ba8225', 'https://codehs.com/uploads/e26aa3605b89e1254dacc92ecd6eea52'));

                    CharacterRegistry.characters.push(new CharacterRegistry('pico', 'https://codehs.com/uploads/c3b093445be70ab2002febd41e84bb11', 'https://codehs.com/uploads/e9c746320fc3ad1d37f279aca269044b'));

                    CharacterRegistry.characters.push(new CharacterRegistry('bf-car', 'https://codehs.com/uploads/c29803362359b51ddb68e0c94cb02382', 'https://codehs.com/uploads/d2e66e3d50b906bd609edcb831919b80'));
                    CharacterRegistry.characters.push(new CharacterRegistry('gf-car', 'https://codehs.com/uploads/f0f3a4f614261670a40575f96d52a67f', 'https://codehs.com/uploads/35635b192deafd01a7dcbf243f6c3200'));
                    CharacterRegistry.characters.push(new CharacterRegistry('mom-car', 'https://codehs.com/uploads/c5d88c41e3ffc115ecabd24f38ed0869', 'https://codehs.com/uploads/047e3887b62af798f314044e869ce8b3'));

                    CharacterRegistry.characters.push(new CharacterRegistry('bf-christmas', 'https://codehs.com/uploads/a23fc1e917b777c8a8bd03b689ee8c22', 'https://codehs.com/uploads/d505cf72f5e14158ed67ae6656e5474c'));
                    CharacterRegistry.characters.push(new CharacterRegistry('gf-christmas', 'https://codehs.com/uploads/5aca2e3d8c3b8a77f96f1476409b9b3a', 'https://codehs.com/uploads/a016fa54ee9a4c455cf881eca39b64ac'));
                    CharacterRegistry.characters.push(new CharacterRegistry('parents-christmas', 'https://codehs.com/uploads/f4ce30de86fc1db9225cb7d417f68ab5', 'https://codehs.com/uploads/95c32662dc374e1179a7c1ee4d1d9897'));
                    CharacterRegistry.characters.push(new CharacterRegistry('monster-christmas', 'https://codehs.com/uploads/6660dc6ec64eb80ecf1ca65bd716fbb2', 'https://codehs.com/uploads/2b1546611d92f57db74fdfb306a48d10'));

                    CharacterRegistry.characters.push(new CharacterRegistry('bf-pixel', 'https://codehs.com/uploads/e9bef203c1f26b7bd4598f920ad843c4', 'https://codehs.com/uploads/7c9cc5604fb89886d152383f05ac19cc'));
                    CharacterRegistry.characters.push(new CharacterRegistry('gf-pixel', 'https://codehs.com/uploads/dedadf92824d689859d4b3faca772f35', 'https://codehs.com/uploads/b69d7f703a2aa7d398d797ed1e0693f9'));
                    CharacterRegistry.characters.push(new CharacterRegistry('senpai', 'https://codehs.com/uploads/d41858355bd23db4c5ef658124b73ba9', 'https://codehs.com/uploads/68051ccc0d817dcc6921f72e742fbbfa'));
                    CharacterRegistry.characters.push(new CharacterRegistry('spirit', 'https://codehs.com/uploads/640c5e848c043d4c3d619cc54d6a1d8c', 'https://codehs.com/uploads/a964937b819c9974e7cdbd151dab0ff5'));

                    CharacterRegistry.characters.push(new CharacterRegistry('bf-holding-gf', 'https://codehs.com/uploads/e41ad03f540ce3e9cb39946adc3b58a3', 'https://codehs.com/uploads/c36c25f951ed4662f414b9963332040b'));
                    CharacterRegistry.characters.push(new CharacterRegistry('gf-tankmen', 'https://codehs.com/uploads/4499f9e571d3a13cfd33b12996cdea07', 'https://codehs.com/uploads/242a7934e698ffa89e909d5db7b98230'));
                    CharacterRegistry.characters.push(new CharacterRegistry('pico-speaker', 'https://codehs.com/uploads/ac2a43a1d5de38453e88c8185c8a0568', 'https://codehs.com/uploads/99898c38394e59d36e4f8daf5f95d0e6'));
                    CharacterRegistry.characters.push(new CharacterRegistry('tankman', 'https://codehs.com/uploads/726b747474d6535c8c4e10eb2dc204fa', 'https://codehs.com/uploads/d6244bd8bf56621c9c3cc62185ccf899'));

                    CharacterRegistry.characters.push(new CharacterRegistry('pico-playable', 'https://codehs.com/uploads/3e6f9da4a5a7f432e45c4a90c9fe634e', 'https://codehs.com/uploads/5ba98d920be5b32069b7714265abce11'));
                    CharacterRegistry.characters.push(new CharacterRegistry('nene', 'https://codehs.com/uploads/f60d60dafc23517b6255b5ff3addc870', 'https://codehs.com/uploads/5d936427b353f0879eb4038eb566285a'));
                    CharacterRegistry.characters.push(new CharacterRegistry('darnell', 'https://codehs.com/uploads/4a00ff7de8fef0abe3765d25990deb11', 'https://codehs.com/uploads/9f778511dfcf7063aff777f875c72fe1'));
                }

                name;
                png;
                xml;

                constructor(name, png, xml)
                {
                    this.name = name ?? '';
                    this.png = png ?? '';
                    this.xml = xml ?? '';
                }
            }

            class ChartRegistry
            {
                static charts = [];

                static initialize()
                {
                    ChartRegistry.charts.push(new ChartRegistry('tutorial', 'https://codehs.com/uploads/a3830d12879fd5e3a857e3c9cb223b0e', 'https://codehs.com/uploads/4839c27470398cec01ca3572e0d6bfeb', ChartType.VANILLA));

                    ChartRegistry.charts.push(new ChartRegistry('bopeebo', 'https://codehs.com/uploads/70eb53e4ea15c47232e5f421645064b0', 'https://codehs.com/uploads/1dc5a66ddf1d460360a7c57dc3f5d598', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('fresh', 'https://codehs.com/uploads/7daf9a2b3a549a0a68ab00a5ea9e6259', 'https://codehs.com/uploads/71a4e770b679a359682a6343f2626804', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('dadbattle', 'https://codehs.com/uploads/4257be03f1d02493ef762664b72584db', 'https://codehs.com/uploads/951805459d4f03ae97dbda581fc8f747', ChartType.VANILLA));
                    
                    ChartRegistry.charts.push(new ChartRegistry('spookeez', 'https://codehs.com/uploads/850ea17910912ad022d50f252060c724', 'https://codehs.com/uploads/16dca39cc17be3e5ee5cac7b8b93f557', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('south', 'https://codehs.com/uploads/5a9847c30ff778b1a34a2930bfba0697', 'https://codehs.com/uploads/3837b12499cd32fcc0d9796333900d91', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('monster', 'https://codehs.com/uploads/fbb95c5ea7a720a21ba4973a754babe3', 'https://codehs.com/uploads/ef81ceca5778634df285b25ba842fcec', ChartType.VANILLA));
                    
                    ChartRegistry.charts.push(new ChartRegistry('pico', 'https://codehs.com/uploads/336acfa59ee098eabb3ce3204f7816d2', 'https://codehs.com/uploads/a39d3de7259383b4f0a6187a39d3eae4', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('philly-nice', 'https://codehs.com/uploads/9c391fd9329b2922661b53da3a7ed1e4', 'https://codehs.com/uploads/805dace67a0c7f9bd8beeec81596acec', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('blammed', 'https://codehs.com/uploads/43527f0e76d12449068bd7b18143661e', 'https://codehs.com/uploads/59ccadce83c4bff5a43721778ab0e430', ChartType.VANILLA));
                    
                    ChartRegistry.charts.push(new ChartRegistry('satin-panties', 'https://codehs.com/uploads/297f65dd8876d952acee9137b6f0e5fc', 'https://codehs.com/uploads/68733ce6a6b16f862b1c6e47549cc981', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('high', 'https://codehs.com/uploads/d0de1bd2ecf53d1a71b284b6133fa82a', 'https://codehs.com/uploads/3b4599398ac28a4ac8014d5bd0c09df8', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('milf', 'https://codehs.com/uploads/c7f217ec4a4b31b2b3f9eb22dfc2f24a', 'https://codehs.com/uploads/1d570101c6256d2ed7087015b1cc321d', ChartType.VANILLA));

                    ChartRegistry.charts.push(new ChartRegistry('cocoa', 'https://codehs.com/uploads/68f2c1fdbba64c8e6700ea45e394e0f8', 'https://codehs.com/uploads/ca9e321d16f5691b93b8b3e3a3ceebe6', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('eggnog', 'https://codehs.com/uploads/2eeece50c96a4185e240719f4b5a40a0', 'https://codehs.com/uploads/94661d2836d4a39f778ce826670d4a19', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('winter-horrorland', 'https://codehs.com/uploads/0c1e7ee96fc1938657cbf3d9548f0f6e', 'https://codehs.com/uploads/8621603fcefd535ff08c125ad730d09c', ChartType.VANILLA));

                    ChartRegistry.charts.push(new ChartRegistry('senpai', 'https://codehs.com/uploads/1da5b44e30bfc43c3ed109a633be05d7', 'https://codehs.com/uploads/26ebe61acb15847188b65d3f718836b4', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('roses', 'https://codehs.com/uploads/bb898368a24d9702ecbe8198738b740f', 'https://codehs.com/uploads/19540b48fe80067b108458996ecbdc68', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('thorns', 'https://codehs.com/uploads/edff7113800abe9f476a9851618d5d79', 'https://codehs.com/uploads/cf0a9feb98d863aebb85f357dddb5a92', ChartType.VANILLA));

                    ChartRegistry.charts.push(new ChartRegistry('ugh', 'https://codehs.com/uploads/72a334351978bfdafe9291b217afe5d8', 'https://codehs.com/uploads/32b3f52ab0f6c90e3adba4a700d13951', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('guns', 'https://codehs.com/uploads/f991980e01466dc2098e538ae28b4b13', 'https://codehs.com/uploads/82783803cfb7d7c71f2f72e179913ff1', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('stress', 'https://codehs.com/uploads/ada79bbfa2bcb90309b608e953c4b914', 'https://codehs.com/uploads/763750dd66d20a17fd045be26aa6c11d', ChartType.VANILLA));
                    
                    ChartRegistry.charts.push(new ChartRegistry('darnell', 'https://codehs.com/uploads/5ae4977c30cbea06c3b885086c414168', 'https://codehs.com/uploads/ae0b745a29ed0f0825b3387df89ff19f', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('lit-up', 'https://codehs.com/uploads/01fda5475fdc09166658a51c6ae149cb', 'https://codehs.com/uploads/c70a84541ed74490fcc386331a70698e', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('2hot', 'https://codehs.com/uploads/642a49ac69579383e47b2600ec577b08', 'https://codehs.com/uploads/912790ec2f3150027218de57b216a5d1', ChartType.VANILLA));
                    
                    ChartRegistry.charts.push(new ChartRegistry('bopeebo-erect', 'https://codehs.com/uploads/5fdad05beb2c25f3aa9727bc6f1662e6', 'https://codehs.com/uploads/6cd3d4f5790fea15835c3d2ae752a983', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('fresh-erect', 'https://codehs.com/uploads/90d38669ee370c34640c17dd6eec4b81', 'https://codehs.com/uploads/fa207a6fd42de8e7b27d134a0836a538', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('dadbattle-erect', 'https://codehs.com/uploads/07bf58bb796cabd5405df73aaeca95ad', 'https://codehs.com/uploads/0d571cd744a4a2d46d98168d408c8f6e', ChartType.VANILLA));

                    ChartRegistry.charts.push(new ChartRegistry('spookeez-erect', 'https://codehs.com/uploads/4ff5e8368d1304381fd6704492c7e275', 'https://codehs.com/uploads/460b4685a3d2d4e5032b70edc80538f4', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('south-erect', 'https://codehs.com/uploads/a0566cb478e8f71e3daf0d91aced003e', 'https://codehs.com/uploads/e194dcbf1cbd78840b93b6d63082f2f1', ChartType.VANILLA));

                    ChartRegistry.charts.push(new ChartRegistry('pico-erect', 'https://codehs.com/uploads/5d80f41b4171095736164d106d8ab32b', 'https://codehs.com/uploads/7d5d64123289773582c386b657352204', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('philly-nice-erect', 'https://codehs.com/uploads/4697208d85cae1829f718a7fd6189325', 'https://codehs.com/uploads/6758dd84d0e1bb770a3cf3d3a3e12b20', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('blammed-erect', 'https://codehs.com/uploads/c69499b59817985d920d95b4f2b19fe9', 'https://codehs.com/uploads/4c76bd2aca5a0aecec3a8bcb44a3846f', ChartType.VANILLA));

                    ChartRegistry.charts.push(new ChartRegistry('satin-panties-erect', 'https://codehs.com/uploads/ae87459108bd11b85f5478f081291427', 'https://codehs.com/uploads/35f68811b86dbec493cb87865e002673', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('high-erect', 'https://codehs.com/uploads/f3b4dce70d53e8113488e8b357907447', 'https://codehs.com/uploads/284c02de389c4fc4d91875a390749931', ChartType.VANILLA));

                    ChartRegistry.charts.push(new ChartRegistry('eggnog-erect', 'https://codehs.com/uploads/bf3eec868b5ffda3c6f4b3649e4d75fc', 'https://codehs.com/uploads/31dd9adff49f762ca08a19baec203dcc', ChartType.VANILLA));

                    ChartRegistry.charts.push(new ChartRegistry('senpai-erect', 'https://codehs.com/uploads/f8c9288a9fb71a0ee69ed61d3bc78c57', 'https://codehs.com/uploads/06a43c24cf2d86a0d469002a51a67581', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('roses-erect', 'https://codehs.com/uploads/c7ad4509d849660d8ba5b1b76e60a7e8', 'https://codehs.com/uploads/413ffc758494852e04179706b15617ee', ChartType.VANILLA));
                    ChartRegistry.charts.push(new ChartRegistry('thorns-erect', 'https://codehs.com/uploads/65221fd3e4dd2372327a63829c382f4f', 'https://codehs.com/uploads/7fc9aaec6858575c16f6e84ed5ee3ebb', ChartType.VANILLA));

                    ChartRegistry.charts.push(new ChartRegistry('null-and-void', 'https://codehs.com/uploads/3f9a17b619018b3d427943cc9ea5f4c2', '', ChartType.LEGACY));
                }

                name;
                data;
                metadata;
                type;

                constructor(name, data, metadata, type)
                {
                    this.name = name ?? '';
                    this.data = data ?? '';
                    this.metadata = metadata ?? '';
                    this.type = type ?? ChartType.VANILLA;
                }
            }

            class HealthIconRegistry
            {
                static icons = [];

                static initialize()
                {
                    HealthIconRegistry.icons.push(new HealthIconRegistry('face', 'https://codehs.com/uploads/9936ef93dedf14f725753b5f4b1b0232'));
                    HealthIconRegistry.icons.push(new HealthIconRegistry('gf', 'https://codehs.com/uploads/6a3bf74af1113b0c1b78396bb156e236'));
                    HealthIconRegistry.icons.push(new HealthIconRegistry('bf', 'https://codehs.com/uploads/0b5b1fecded012aa9578f84f18e0e3e9'));
                    HealthIconRegistry.icons.push(new HealthIconRegistry('bf-old', 'https://codehs.com/uploads/52d22b7bcc4dc735ae679dc8ad3a8ea2'));
                    HealthIconRegistry.icons.push(new HealthIconRegistry('bf-pixel', 'https://codehs.com/uploads/769c3fc33f98c6fc6b37ec6bd90b5b74'));
                    HealthIconRegistry.icons.push(new HealthIconRegistry('dad', 'https://codehs.com/uploads/2998bf34714de5212cbe031d73b10072'));
                    HealthIconRegistry.icons.push(new HealthIconRegistry('spooky', 'https://codehs.com/uploads/c1be8da6a846bb1abbd7852b3c207573'));
                    HealthIconRegistry.icons.push(new HealthIconRegistry('monster', 'https://codehs.com/uploads/ec71119ee2cb5a5c9a0384d51799e71a'));
                    HealthIconRegistry.icons.push(new HealthIconRegistry('pico', 'https://codehs.com/uploads/46b6f7e3937a92be91bf608395de5bf2'));
                    HealthIconRegistry.icons.push(new HealthIconRegistry('mom', 'https://codehs.com/uploads/146a551058d9899910052ea2c490f29a'));
                    HealthIconRegistry.icons.push(new HealthIconRegistry('parents', 'https://codehs.com/uploads/318734c537a6684ab38e4827d257231d'));
                    HealthIconRegistry.icons.push(new HealthIconRegistry('senpai', 'https://codehs.com/uploads/b1017de59c9fb3cfb5ec3d85d77ea5e9'));
                    HealthIconRegistry.icons.push(new HealthIconRegistry('spirit', 'https://codehs.com/uploads/b28313fb7141f8cbaba478b96ad0d62f'));
                    HealthIconRegistry.icons.push(new HealthIconRegistry('tankman', 'https://codehs.com/uploads/1c00dbd075340b98605aa3b43585d3ed'));
                    HealthIconRegistry.icons.push(new HealthIconRegistry('darnell', 'https://codehs.com/uploads/c5dac51c535fc8fe8e459971c95a0c51'));
                }

                name;
                png;

                constructor(name, png)
                {
                    this.name = name ?? '';
                    this.png = png ?? '';
                }
            }

            class Level
            {
                name;
                title;
                songs = [];
                difficulties = [];

                constructor(name, title, songs = [Constants.DEFAULT_SONG], difficulties = Constants.DEFAULT_DIFFICULTY_LIST)
                {
                    this.name = name ?? '';
                    this.title = title ?? '';
                    
                    this.songs = [];
                    for (var song of (songs ?? [Constants.DEFAULT_SONG]))
                    if (SongRegistry.getByName(song) != null)
                        this.songs.push(SongRegistry.getByName(song));

                    this.difficulties = difficulties ?? Constants.DEFAULT_DIFFICULTY_LIST;
                }

                showInFreeplay() // for Weekend1
                {
                    return true;
                }

                getDisplayNames() // for story mode
                {
                    return this.songs;
                }
            }

            class LevelRegistry
            {
                static levels = [];

                static initialize()
                {
                    LevelRegistry.levels.push(new Level('Tutorial', 'TEACHING TIME', ['tutorial']));
                    LevelRegistry.levels.push(new Level('Week 1', 'DADDY DEAREST', ['bopeebo', 'fresh', 'dadbattle']));
                    LevelRegistry.levels.push(new Level('Week 2', 'SPOOKY MONTH', ['spookeez', 'south', 'monster']));
                    LevelRegistry.levels.push(new Level('Week 3', 'PICO', ['pico', 'philly', 'blammed']));
                    LevelRegistry.levels.push(new Level('Week 4', 'MOMMY MUST MURDER', ['satin-panties', 'high', 'milf']));
                    LevelRegistry.levels.push(new Level('Week 5', 'RED SNOW', ['cocoa', 'eggnog', 'winter-horrorland']));
                    LevelRegistry.levels.push(new Level('Week 6', 'HATING SIMULATOR (FT. MAOWLING)', ['senpai', 'roses', 'thorns']));
                    LevelRegistry.levels.push(new Level('Week 7', 'TANKMAN (FT. JOHNNYUTAH)', ['ugh', 'guns', 'stress']));
                    LevelRegistry.levels.push(new Level('Weekend 1', 'DUE DEBTS', ['darnell', 'lit-up', '2hot'/*, 'blazin'*/]));
                    LevelRegistry.levels.push(new Level('NULL AND VOID', 'NULL AND VOID', ['null-and-void']));
                }
            }

            class PreferenceRegistry
            {
                static preferences = [];

                static initialize()
                {
                    PreferenceRegistry.preferences.push(new PreferenceRegistry('downscroll', false));
                    PreferenceRegistry.preferences.push(new PreferenceRegistry('middlescroll', false));
                    PreferenceRegistry.preferences.push(new PreferenceRegistry('ghost-tapping', false));
                    PreferenceRegistry.preferences.push(new PreferenceRegistry('camera-zooming', true));
                }

                static getByName(name)
                {
                    var preference = null;
                    for (var daPreference of PreferenceRegistry.preferences)
                        if (daPreference != null)
                            if (daPreference.name == name)
                                preference = daPreference;

                    return preference;
                }

                static changeValue(pref = '', val = false)
                {
                    if (PreferenceRegistry.getByName(pref) != null)
                        PreferenceRegistry.getByName(pref).value = val ?? false;

                    switch (pref)
                    {
                        case 'downscroll':
                            Constants.DOWN_SCROLL = PreferenceRegistry.getByName(pref).value;
                            break;

                        case 'middlescroll':
                            Constants.MIDDLE_SCROLL = PreferenceRegistry.getByName(pref).value;
                            break;

                        case 'ghost-tapping':
                            Constants.GHOST_TAPPING = PreferenceRegistry.getByName(pref).value;
                            break;

                        case 'camera-zooming':
                            Constants.CAMERA_ZOOMING = PreferenceRegistry.getByName(pref).value;
                            break;
                    }
                }

                name;
                value;

                constructor(name, value)
                {
                    this.name = name ?? '';
                    this.value = value ?? false;
                }
            }

            class SongRegistry
            {
                static songs = [];

                static default()
                {
                    return new SongRegistry('tutorial', 'https://codehs.com/uploads/defd37b8209c51a08be9de50c6824cf8', 'https://codehs.com/uploads/b108a2af0aabe8f4a848556c0a05c65f', 'https://codehs.com/uploads/a44ed2e28b66721e1e6dccb0a5d295ae', VocalType.PLAYER_OPPONENT);
                }

                static initialize()
                {
                    SongRegistry.songs.push(SongRegistry.default());

                    SongRegistry.songs.push(new SongRegistry('bopeebo', 'https://codehs.com/uploads/f65f1128e976a3f04822f47ef65d0551', 'https://codehs.com/uploads/278be7e49ff34408d57927b3d4bf34d4', 'https://codehs.com/uploads/0b85b6891f6130512409f49349519e66', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('fresh', 'https://codehs.com/uploads/011e939e34480120d07c3c5f55825569', 'https://codehs.com/uploads/4a20c42ed2136c7da0231dfab05d1837', 'https://codehs.com/uploads/74d050e670233c56db3e8eef6be95f8e', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('dadbattle', 'https://codehs.com/uploads/c2be1fb87189c5e819041f96f2bbc430', 'https://codehs.com/uploads/c464851447bf6dde0aa3d3ab81f1bade', 'https://codehs.com/uploads/ac0366042be72c99d73f51b37d0cbf8a', VocalType.PLAYER_OPPONENT));
                    
                    SongRegistry.songs.push(new SongRegistry('spookeez', 'https://codehs.com/uploads/fbbb435fa7c53d6491d7fa7856f440da', 'https://codehs.com/uploads/a408c9ddcea73ab503c0e18e4370fd9d', 'https://codehs.com/uploads/0918283368f5097a8d7efbb7e716ee5f', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('south', 'https://codehs.com/uploads/86ee402ae88d612612f0cbfd5c349dcd', 'https://codehs.com/uploads/dca1d97941c0d325873f4440ed955921', 'https://codehs.com/uploads/7335c5aae4832658e2de356d489a10cc', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('monster', 'https://codehs.com/uploads/0ef6646e650b418ba04abfb4e16e1a29', 'https://codehs.com/uploads/f8121fda44f8cb9fed82b6ec5b2d0e9e', 'https://codehs.com/uploads/6290f5c0ec3909ae2ca392e9c105e781', VocalType.PLAYER_OPPONENT));
                    
                    SongRegistry.songs.push(new SongRegistry('pico', 'https://codehs.com/uploads/075d0fe4590c8c0c623f7bfda2a4084e', 'https://codehs.com/uploads/31b2e3550bb332c20b60ba3efc7011cb', 'https://codehs.com/uploads/2190882ea817da6b80bf734c0ef65db8', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('philly-nice', 'https://codehs.com/uploads/31a0047ea129f621634dbb5fa27d6649', 'https://codehs.com/uploads/28ea10a5247a35725c4e5798919dc3d8', 'https://codehs.com/uploads/454be4512eaaa9c8cedf12633cad83f4', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('blammed', 'https://codehs.com/uploads/eca5f47d7a5775cb09927db40c8ddc2d', 'https://codehs.com/uploads/211a50f135ebbfcb0070ae8ff459752d', 'https://codehs.com/uploads/b3ab7f01d6323dc6468fc8c381e290d0', VocalType.PLAYER_OPPONENT));
                    
                    SongRegistry.songs.push(new SongRegistry('satin-panties', 'https://codehs.com/uploads/b5204fa9cdac2460b6d6b5a1495f1b56', 'https://codehs.com/uploads/86a4b76512c15aca9119d76e751c6db9', 'https://codehs.com/uploads/136781201e5eb88f51168fa122787cae', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('high', 'https://codehs.com/uploads/11bd4a5e005d1e7e5ca50081aa224c2e', 'https://codehs.com/uploads/617957d49adf55306ff30c9faa89eef2', 'https://codehs.com/uploads/ab6cdcc01f7d5a0d9de59c012852a06e', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('milf', 'https://codehs.com/uploads/93f0f85e99ed4a700397a1da7262ce4d', 'https://codehs.com/uploads/bda256ceaf401b779d2d386cbddbee0d', 'https://codehs.com/uploads/59c5c2a95b95d3be9ed38dabff095ffb', VocalType.PLAYER_OPPONENT));

                    SongRegistry.songs.push(new SongRegistry('cocoa', 'https://codehs.com/uploads/2d63e62cc7c9c656cba1229b7e5efb0f', 'https://codehs.com/uploads/62d02fc121755db3cb02601ba4026e02', 'https://codehs.com/uploads/ee67e62d8d1d9e3fcddf1391ff93cfc4', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('eggnog', 'https://codehs.com/uploads/25357239e77afeb09bb88773aab8f8bf', 'https://codehs.com/uploads/a5224155954076cb414ad5d6290681e8', 'https://codehs.com/uploads/2dc6def8ae05599ac019a6b4f54ef974', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('winter-horrorland', 'https://codehs.com/uploads/841f8efe5621ef911410be69bbb985dc', 'https://codehs.com/uploads/1aa550f07f47f97e4761e4d6a680986a', 'https://codehs.com/uploads/ddef431b27557947a6bef87a92c8dd37', VocalType.PLAYER_OPPONENT));

                    SongRegistry.songs.push(new SongRegistry('senpai', 'https://codehs.com/uploads/cab105661a711f057f76f78cc32ca2ba', 'https://codehs.com/uploads/7701d60682caa4722a1fecee37bb9c3c', 'https://codehs.com/uploads/b340cae6c2d0eb90095129f549d2a08f', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('roses', 'https://codehs.com/uploads/82de5c716f42168987a2fb85303e8e9f', 'https://codehs.com/uploads/40e4fb23a4af014701e560a422f77f23', 'https://codehs.com/uploads/783159fbdf5aafe779bb7fb6167220dc', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('thorns', 'https://codehs.com/uploads/b4bfbec1f814cd4686c9686bb38db6f7', 'https://codehs.com/uploads/040acdb2062fe7e97a781079dd56642c', 'https://codehs.com/uploads/faa3519951422d1d9b62d66a5e34fb32', VocalType.PLAYER_OPPONENT));

                    SongRegistry.songs.push(new SongRegistry('ugh', 'https://codehs.com/uploads/8b986ce6e607300de47e9cf0b419d7c3', 'https://codehs.com/uploads/b9b6842a5eb6d2dc53ec702cb861b71c', 'https://codehs.com/uploads/37f6529062721ee702157ef52ad649c7', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('guns', 'https://codehs.com/uploads/fc5bc7f9c23b7caa8b64c736b61912b5', 'https://codehs.com/uploads/e4e2a135e2a416f00310fd025e20eb7a', 'https://codehs.com/uploads/d1fe2bb8b57ed436b8926d701407f972', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('stress', 'https://codehs.com/uploads/8b96a51469235b5416bedd935087b904', 'https://codehs.com/uploads/2a2256f0376f4f2adf759907d107e1e4', 'https://codehs.com/uploads/18058cb82760cacd6992b201dab7d0d1', VocalType.PLAYER_OPPONENT));
                    
                    SongRegistry.songs.push(new SongRegistry('darnell', 'https://codehs.com/uploads/99b39f857289002b1f0bca7b08441f4a', 'https://codehs.com/uploads/d8e04a4c662a197969f2198cbad8e243', 'https://codehs.com/uploads/3275a2412ad0eb4d9672649578eb79ad', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('lit-up', 'https://codehs.com/uploads/3390f5d3378ae409850eb85b3d311e79', 'https://codehs.com/uploads/5fb1e6bedfda8daa7a0f11f74e5c29f8', 'https://codehs.com/uploads/1fdd023fdb7e1ee27f7d68fe32916087', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('2hot', 'https://codehs.com/uploads/3300f59f5bb4a0011c30a7714dfeee24', 'https://codehs.com/uploads/4270857f691032acc9d3803d2385fb8f', 'https://codehs.com/uploads/0585be21322cfacfd1a79fb43ba12455', VocalType.PLAYER_OPPONENT));
                    
                    SongRegistry.songs.push(new SongRegistry('bopeebo-erect', 'https://codehs.com/uploads/0e005937c8aae9edc4700d9e752734fb', 'https://codehs.com/uploads/1f13d97821a07f30e8614c4d73d50429', 'https://codehs.com/uploads/3bedff875918e0493b40b0b8e082ca39', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('fresh-erect', 'https://codehs.com/uploads/8b5dba800271d2662eeb5b5215a80737', 'https://codehs.com/uploads/f6bc6384fc6173d77881b8ee1023031d', 'https://codehs.com/uploads/360f33685866c8aa94f1e13ec556deab', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('dadbattle-erect', 'https://codehs.com/uploads/b62be37798f01fb08f1d15c6e2d6d1dd', 'https://codehs.com/uploads/1391e81b70b48254e75bb342a4e0ef69', 'https://codehs.com/uploads/10c432f00b71c8e118f9508f328a3387', VocalType.PLAYER_OPPONENT));

                    SongRegistry.songs.push(new SongRegistry('spookeez-erect', 'https://codehs.com/uploads/f3a9050b9d75c45b5041bf48b5ca0a87', 'https://codehs.com/uploads/0116344c58f20039e5d3dab5e204e88a', 'https://codehs.com/uploads/3c3b4136d1445cf3da4dbe4ae271e931', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('south-erect', 'https://codehs.com/uploads/0c761ebc4df014cf3fe13c2bb204112c', 'https://codehs.com/uploads/36a7cf4cafd943670a296c40c389a0cb', 'https://codehs.com/uploads/a9bfd0eedf58a9fc758ea563e415eceb', VocalType.PLAYER_OPPONENT));

                    SongRegistry.songs.push(new SongRegistry('pico-erect', 'https://codehs.com/uploads/0aa8973a5cd86c0a9bf00d1c4ffe51f2', 'https://codehs.com/uploads/bfea1e72f4c3f346c0059bfd8fe480c3', 'https://codehs.com/uploads/7408d01874d65730cd1f9e980fbb3b94', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('philly-nice-erect', 'https://codehs.com/uploads/d8a9c57fea13f1d7ee74907aadb77853', 'https://codehs.com/uploads/04fec0e03e9430ce5a61057aa0617f8b', 'https://codehs.com/uploads/9e4457c62492f3954522c7970a5044c3', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('blammed-erect', 'https://codehs.com/uploads/157328e59406145c957855c46903ea56', 'https://codehs.com/uploads/07932100d074af2786cc72c41bcd9139', 'https://codehs.com/uploads/d9686df5895519a4244ad6d6ad4d6efa', VocalType.PLAYER_OPPONENT));

                    SongRegistry.songs.push(new SongRegistry('satin-panties-erect', 'https://codehs.com/uploads/71bbe205f3db5aa57d2628ad0dce1e2f', 'https://codehs.com/uploads/5994033bac9b606bd7bd7d491fcd4569', 'https://codehs.com/uploads/93dc79c62bc1f3b5a5bdd162ed969ba6', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('high-erect', 'https://codehs.com/uploads/babfb25bb7bdd3863a91a5b2d6053229', 'https://codehs.com/uploads/d067c19ab164290cd748095e59c40a43', 'https://codehs.com/uploads/21dc6085a8804ccb7f9b85d1df62f299', VocalType.PLAYER_OPPONENT));

                    SongRegistry.songs.push(new SongRegistry('eggnog-erect', 'https://codehs.com/uploads/2384eecc793bbb3cd9852add91dec78b', 'https://codehs.com/uploads/d2d844258dc4f4cd67e4a13036bb17a3', 'https://codehs.com/uploads/cca3d5e95dfe3e243454740b112fc952', VocalType.PLAYER_OPPONENT));

                    SongRegistry.songs.push(new SongRegistry('senpai-erect', 'https://codehs.com/uploads/9f4ece4fc5ddf764f92aceddb156ffdf', 'https://codehs.com/uploads/543bd5dd314500034deba690abef6bc4', 'https://codehs.com/uploads/24a30103c14a65235f5653f422fa95b9', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('roses-erect', 'https://codehs.com/uploads/a8607f868a34a5a3b716e46fafb49cb2', 'https://codehs.com/uploads/ba114bda41f45abea97306943ac15fb3', 'https://codehs.com/uploads/267219731c3edde93134fe6e3261409e', VocalType.PLAYER_OPPONENT));
                    SongRegistry.songs.push(new SongRegistry('thorns-erect', 'https://codehs.com/uploads/ef6375d190ef53faf51204bb43240b7d', 'https://codehs.com/uploads/88432b0b3b7260a2486beac931574614', 'https://codehs.com/uploads/046329fa71544f379ad3d8fe8e65db91', VocalType.PLAYER_OPPONENT));

                    SongRegistry.songs.push(new SongRegistry('null-and-void', 'https://codehs.com/uploads/d6f7d186c0ce9408864d4b29d567bfd1', '', '', VocalType.NONE));
                }

                static getByName(name)
                {
                    var song = null;
                    for (var daSong of SongRegistry.songs)
                    if (daSong != null)
                        if (daSong.name == name)
                        song = daSong;

                    return song;
                }

                name;
                inst;
                vocals;
                vocalsOpponent;
                type;

                constructor(name, inst, vocals, vocalsOpponent, type)
                {
                    this.name = name ?? '';
                    this.inst = inst ?? '';
                    this.vocals = vocals ?? '';
                    this.vocalsOpponent = vocalsOpponent ?? '';
                    this.type = type ?? VocalType.PLAYER_OPPONENT;
                }
            }

            class Conductor
            {
                static instance = null;

                bpm = 0;
                bpmChangeMap = [];

                lastTime = 0;
                lastStep = 0;
                lastBeat = 0;
                lastSection = 0;

                update(time)
                {
                    this.lastTime = time;
                    this.lastStep = Math.floor(this.lastTime / (this.getBeatLengthMs() / 4));
                    this.lastBeat = Math.floor(this.lastStep / 4);
                    this.lastSection = Math.floor(this.lastBeat / 4);
                }

                constructor(beatsPerMin = 100) { this.bpm = beatsPerMin ?? 100; }
                getBeatLengthMs() { return (60 / this.bpm) * 1000; }
            }

            class Sound extends Phaser.Sound.WebAudioSound
            {
                defaultVolume = 1;

                constructor(manager, key, config)
                {
                    super(manager, key, config);

                    this.changeVolume(this.volume);
                }

                changeVolume(val)
                {
                    this.defaultVolume = val;
                }
            }

            class Controls
            {
                static list = new Map();

                static initialize()
                {
                    Controls.list.set('note_left', [Phaser.Input.Keyboard.KeyCodes.A, Phaser.Input.Keyboard.KeyCodes.LEFT]);
                    Controls.list.set('note_down', [Phaser.Input.Keyboard.KeyCodes.S, Phaser.Input.Keyboard.KeyCodes.DOWN]);
                    Controls.list.set('note_up', [Phaser.Input.Keyboard.KeyCodes.W, Phaser.Input.Keyboard.KeyCodes.UP]);
                    Controls.list.set('note_right', [Phaser.Input.Keyboard.KeyCodes.D, Phaser.Input.Keyboard.KeyCodes.RIGHT]);

                    Controls.list.set('ui_left', [Phaser.Input.Keyboard.KeyCodes.A, Phaser.Input.Keyboard.KeyCodes.LEFT]);
                    Controls.list.set('ui_down', [Phaser.Input.Keyboard.KeyCodes.S, Phaser.Input.Keyboard.KeyCodes.DOWN]);
                    Controls.list.set('ui_up', [Phaser.Input.Keyboard.KeyCodes.W, Phaser.Input.Keyboard.KeyCodes.UP]);
                    Controls.list.set('ui_right', [Phaser.Input.Keyboard.KeyCodes.D, Phaser.Input.Keyboard.KeyCodes.RIGHT]);

                    Controls.list.set('pause', [Phaser.Input.Keyboard.KeyCodes.ESC, Phaser.Input.Keyboard.KeyCodes.ENTER]);
                    Controls.list.set('accept', [Phaser.Input.Keyboard.KeyCodes.ENTER, Phaser.Input.Keyboard.KeyCodes.SPACE]);
                    Controls.list.set('reject', [Phaser.Input.Keyboard.KeyCodes.BACKSPACE, Phaser.Input.Keyboard.KeyCodes.ESC]);

                    Controls.list.set('vol_down', [Phaser.Input.Keyboard.KeyCodes.MINUS, Phaser.Input.Keyboard.KeyCodes.NUMPAD_SUBTRACT]);
                    Controls.list.set('vol_up', [Phaser.Input.Keyboard.KeyCodes.PLUS, Phaser.Input.Keyboard.KeyCodes.NUMPAD_ADD]);
                    Controls.list.set('vol_mute', [Phaser.Input.Keyboard.KeyCodes.ZERO, Phaser.Input.Keyboard.KeyCodes.NUMPAD_ZERO]);
                }
            }

            class Tallies
            {
                combo;
                missed;

                shit;
                bad;
                good;
                sick;
                maxCombo;

                score;
                isNewHighscore;

                totalNotesHit;
                totalNotes;

                constructor()
                {
                    this.combo = 0;
                    this.missed = 0;
                    this.shit = 0;
                    this.bad = 0;
                    this.good = 0;
                    this.sick = 0;
                    this.maxCombo = 0;
                    this.score = 0;
                    this.isNewHighscore = false;
                    this.totalNotesHit = 0;
                    this.totalNotes = 0;
                }
            }

            class Highscore
            {
                static tallies = new Tallies();
                static talliesLevel = new Tallies();

                static combineTallies(newTally, baseTally)
                {
                    var combinedTally = new Tallies();
                    combinedTally.missed = newTally.missed + baseTally.missed;
                    combinedTally.shit = newTally.shit + baseTally.shit;
                    combinedTally.bad = newTally.bad + baseTally.bad;
                    combinedTally.good = newTally.good + baseTally.good;
                    combinedTally.sick = newTally.sick + baseTally.sick;
                    combinedTally.totalNotes = newTally.totalNotes + baseTally.totalNotes;
                    combinedTally.totalNotesHit = newTally.totalNotesHit + baseTally.totalNotesHit;

                    combinedTally.combo = newTally.combo;
                    combinedTally.maxCombo = Math.floor(Math.max(newTally.maxCombo, baseTally.maxCombo));

                    return combinedTally;
                }
            }

            class MusicBeatState extends Phaser.Scene
            {
                static music;

                getWidth() { return this.cameras.main.width; }
                getHeight() { return this.cameras.main.height; }

                screenCenter(object, axis = 'XY')
                {
                    if (axis.toLowerCase().includes('x')) object.x = (this.getWidth() - object.width * (object.scaleX ?? 1)) / 2;
                    if (axis.toLowerCase().includes('y')) object.y = (this.getHeight() - object.height * (object.scaleY ?? 1)) / 2;
                }

                addToCameras(item, cameras = [])
                {
                    var allCameras = [this.cameras.main];
                    for (var cam of allCameras)
                    if (!cameras.includes(cam))
                        cam.ignore(item);
                }

                createImage(key, x = 0, y = 0)
                {
                    var img = new Phaser.GameObjects.Image(this, x, y, key);
                    img.setOrigin(0, 0);
                    return img;
                }

                createPhysicsImage(key, x = 0, y = 0)
                {
                    var img = this.physics.add.image(x, y, key);
                    img.setOrigin(0, 0);
                    return img;
                }

                createSprite(key, x = 0, y = 0)
                {
                    var spr = new Phaser.GameObjects.Sprite(this, x, y, key);
                    spr.setOrigin(0, 0);
                    return spr;
                }

                createRect(x = 0, y = 0, width = 1, height = 1, fillColor = 0xffffffff, fillAlpha = 1)
                {
                    var rect = new Phaser.GameObjects.Rectangle(this, x, y, width, height, fillColor, fillAlpha);
                    rect.setOrigin(0, 0);
                    return rect;
                }

                createText(x = 0, y = 0, text = '', size = 12, font = 'Vcr', color = '#ffffff', backColor = '#000000', backSize = 0, alignment = 'right')
                {
                    var txt = new Phaser.GameObjects.Text(this, x, y, text, {fontSize: size + 'px', fontFamily: font, color: color, stroke: backColor, strokeThickness: backSize, align: alignment});
                    txt.setOrigin(0, 0);
                    return txt;
                }

                constructor(key) { super(key); }

                create()
                {

                }

                preload()
                {
                    this.load.audio('confirm', ['https://codehs.com/uploads/199a8a1ed8d7ed670a7bc87850c1ff1b?.ogg']);
                    this.load.audio('scroll', ['https://codehs.com/uploads/9b7ea4ff87a49c1f612d0c6dba26dffb?.ogg']);
                    this.load.audio('cancel', ['https://codehs.com/uploads/46380b313aec5e65c7697083d1740198?.ogg']);

                    /*
                    WebFontLoader.call(this.load,
                    {
                        custom:
                        {
                            // 5by7 is the freeplay font!
                            families: ['Vcr', 'Phantomuff', "Week", "5by7"],
                            urls: ['https://codehs.com/uploads/114e38b8f4df96d686aef5587af5fa74?.css', 'https://codehs.com/uploads/f7310aafa9b8068226cc005d83628d20?.css', 'https://codehs.com/uploads/e694eee78c275ce72140a77ea8ccc498?.css', 'https://codehs.com/uploads/e206bbb9935f0c760e09c2b6e88c47c7?.css']
                        }
                    });
                    */
                }

                switchState(target, key, soundExclusion = [])
                {
                    for (var sound of this.sound.getAllPlaying())
                    if (sound != MusicBeatState.music && !soundExclusion.includes(sound))
                        sound.stop();

                    this.scene.remove(this);
                    this.scene.add(target, key);
                    this.scene.start(target);
                }

                lastElapsedTime = 0;
                elapsed = 0;
                lastStep = 0;

                update(time)
                {
                    this.elapsed = (time - this.lastElapsedTime) / 1000;
                    this.lastElapsedTime = time;
                    
                    if (Conductor.instance != null)
                    {
                        var newStep = Conductor.instance.lastStep;
                        if (this.lastStep != newStep) this.stepHit(newStep);
                        if (Math.floor(this.lastStep / 4) != Math.floor(newStep / 4)) this.beatHit(Math.floor(newStep / 4));
                        if (Math.floor(this.lastStep / 16) != Math.floor(newStep / 16)) this.sectionHit(Math.floor(newStep / 16));

                        this.lastStep = newStep;
                    }
                }

                stepHit(step) {}
                beatHit(beat) {}
                sectionHit(section) {}
            }

            class AtlasText
            {
                static precache(scene)
                {
                    scene.load.atlasXML('alphabet', 'https://codehs.com/uploads/62cd20f67b50b8c977a355e585f7d7fc', 'https://codehs.com/uploads/3b093adbf04bdc51c0b87217b1ff16d9');
                }
                
                x = 0.0;
                y = 0.0;
                width = 0.0;
                height = 0.0;
                alpha = 1;
                visible = true;

                scrollFactorX = 1;
                scrollFactorY = 1;

                targetY = 0;
                isMenuItem = false;

                text = "";

                lastSprite;
                lastWasSpace = false;

                splitWords = [];
                letters = [];

                isBold = false;
                scene;

                constructor(scene, x = 0.0, y = 0.0, text = "", bold = false)
                {
                    this.x = x;
                    this.y = y;

                    this.text = text;
                    this.isBold = bold;
                    this.scene = scene;

                    if (text != "")
                        this.addText();
                }

                addText()
                {
                    this.splitWords = this.text.split("");

                    var xPos = 0;
                    var yPos = 0;
                    var lastHeight = 0;

                    for (var character of this.splitWords)
                    {
                        if (character == " " || character == "-")
                            this.lastWasSpace = true;
                        
                        if (character == "\n")
                        {
                            xPos = 0;
                            yPos += this.height - lastHeight;

                            lastHeight = this.height;
                        }
                        else if (AlphaCharacter.alphabet.indexOf(character.toLowerCase()) != -1)
                        {
                            if (this.lastWasSpace)
                            {
                                xPos += 40;
                                this.width += 40;
                                this.lastWasSpace = false;
                            }

                            var letter = new AlphaCharacter(this.scene, xPos, yPos);

                            if (AlphaCharacter.symbols.includes(character))
                                letter.createSymbol(character);
                            if (this.isBold)
                                letter.createBold(character);
                            else
                                letter.createLetter(character);

                            this.width += letter.width;
                            xPos += letter.width;
                            this.letters.push(letter);

                            var equa = (letter.y - this.y + letter.height);
                            if (this.height < equa)
                                this.height = equa;

                            this.lastSprite = letter;
                        }
                    }
                }

                update(elapsed = 1 / 60)
                {
                    if (this.isMenuItem)
                    {
                        var scaledY = TSMath.remapToRange(this.targetY, 0, 1, 0, 1.3);

                        this.y = TSMath.fpsLerp(this.y, (scaledY * 120) + (720 * 0.48), 0.16, elapsed);
                        this.x = TSMath.fpsLerp(this.x, (this.targetY * 20) + 90, 0.16, elapsed);
                    }

                    for (var object of this.letters)
                    {
                        object.x = (this.x + object.baseX);
                        object.y = (this.y + object.baseY);
                        object.alpha = this.alpha;
                        object.visible = this.visible;

                        object.scrollFactorX = this.scrollFactorX;
                        object.scrollFactorY = this.scrollFactorY;
                    }
                }

                setText(scene, newText)
                {
                    if (this.text == newText || newText.length == null || newText.length <= 0)
                        return;

                    while (this.letters.length > 0)
                    {
                        var letter = this.letters.shift();
                        letter.visible = false;
                        letter.destroy();
                    }

                    this.width = 0;
                    this.height = 0;

                    this.text = newText;
                    this.scene = scene;
                    this.addText();
                    if (this.drawn) this.draw(this.scene);
                    if (this.addedToCameras) this.addToCameras(this.scene, this.addedCameras);
                }

                setVisible(visible)
                {
                    this.visible = visible ?? true;

                    for (var obj of this.letters)
                        obj.visible = this.visible;
                }

                addedToCams = false;
                addedCameras = [];
                addToCameras(scene, cameras = [])
                {
                    this.addedToCams = true;
                    this.addedCameras = cameras ?? [];
                    for (var object of this.letters)
                        if (object != null)
                            scene.addToCameras(object, this.addedCameras);
                }

                drawn = false;
                draw(from)
                {
                    this.drawn = true;
                    if (from != null)
                        for (var letter of this.letters)
                            from.add.existing(letter);
                }
            }

            class AlphaCharacter extends Phaser.GameObjects.Sprite
            {
                static alphabet = "abcdefghijklmnopqrstuvwxyz";

                static numbers = "1234567890";

                static symbols = "|~#$%()*+-:;<=>@[]^_.,'!?";

                row = 0;

                baseX = 0.0;
                baseY = 0.0;

                constructor(fromScene, x, y)
                {
                    super(fromScene, x, y, 'alphabet');
                    this.baseX = x;
                    this.baseY = y;
                    this.setOrigin(0, 0);
                }

                createBold(letter)
                {
                    this.anims.create({key: letter, repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames('alphabet', {prefix: letter.toUpperCase() + " bold", end: 3, zeroPad: 4})});
                    this.anims.play(letter);
                }

                createLetter(letter)
                {
                    var letterCase = "lowercase";
                    if (letter.toLowerCase() != letter)
                    {
                        letterCase = 'capital';
                    }

                    this.anims.create({key:letter, repeat:-1, frameRate:24, frames:this.anims.generateFrameNames('alphabet', {prefix:letter + " " + letterCase, end:3, zeroPad:4})});
                    this.anims.play(letter);

                    this.y = (110 - this.displayHeight) + (this.row * 60);
                }

                createNumber(letter)
                {
                    this.anims.create({key:letter, repeat:-1, frameRate:24, frames:this.anims.generateFrameNames('alphabet', {prefix:letter, end:3, zeroPad:4})});
                    this.anims.play(letter);
                }

                createSymbol(letter)
                {
                    switch (letter)
                    {
                        case '.':
                            this.anims.create({key:letter, repeat:-1, frameRate:24, frames:this.anims.generateFrameNames('alphabet', {prefix:'period', end:3, zeroPad:4})});
                            this.anims.play(letter);
                            this.y += 50;
                            break;
                        case "'":
                            this.anims.create({key:letter, repeat:-1, frameRate:24, frames:this.anims.generateFrameNames('alphabet', {prefix:'apostraphie', end:3, zeroPad:4})});
                            this.anims.play(letter);
                            break;
                        case "?":
                            this.anims.create({key:letter, repeat:-1, frameRate:24, frames:this.anims.generateFrameNames('alphabet', {prefix:'question mark', end:3, zeroPad:4})});
                            this.anims.play(letter);
                            break;
                        case "!":
                            this.anims.create({key:letter, repeat:-1, frameRate:24, frames:this.anims.generateFrameNames('alphabet', {prefix:'exclamation po number', end:3, zeroPad:4})});
                            this.anims.play(letter);
                            break;
                        case "<":
                            this.anims.create({key:letter, repeat:-1, frameRate:24, frames:this.anims.generateFrameNames('alphabet', {prefix:'leftpoint', end:3, zeroPad:4})});
                            this.anims.play(letter);
                            break;
                        case ">":
                            this.anims.create({key:letter, repeat:-1, frameRate:24, frames:this.anims.generateFrameNames('alphabet', {prefix:'rightpoint', end:3, zeroPad:4})});
                            this.anims.play(letter);
                            break;
                    }
                }
            }

            class TitleState extends MusicBeatState
            {
                static TITLE_BPM = 102;

                static initialized = false;
                static instance = null;

                logoBl;
                gfDance;
                titleEnter;

                enterPresses = 0;
                transTimer = 0;

                danceRight = false;

                constructor() { super('TitleState'); }

                preload()
                {
                    super.preload();

                    this.load.atlasXML('gfDance', 'https://codehs.com/uploads/f887a93ab8b3e54bda73abc238f3ccca', 'https://codehs.com/uploads/126fef5fe496f66c6ee145f28a04ec17');
                    this.load.atlasXML('logoBl', 'https://codehs.com/uploads/c1cbabd8cfc3de11ee754d02c378780e', 'https://codehs.com/uploads/923baeb22929779502b9e8d341f85f5a');
                    this.load.atlasXML('titleEnter', 'https://codehs.com/uploads/ab08cdaf1924fe3af1a425cd7805ab1c', 'https://codehs.com/uploads/34c1766de394c1b83163120a581507d6');

                    this.load.audio('freakyMenu', ['https://codehs.com/uploads/379303cd440818d9e1eebd9e4f5d1737?.ogg']);
                }

                create()
                {
                    super.create();
                    
                    if (!TitleState.initialized)
                    {
                        var script = this;
                        this.time.delayedCall
                        (
                            1000, function()
                            {
                            TitleState.initialized = true;
                            script.startIntro();
                            
                            MusicBeatState.music = script.sound.add('freakyMenu', {volume: 0.7, loop: true});
                            MusicBeatState.music.play();
                            }, [], null
                        );
                    } else
                        this.startIntro();
                }

                startIntro()
                {
                    Conductor.instance.bpm = TitleState.TITLE_BPM;

                    this.gfDance = this.createSprite('gfDance', this.getWidth() * 0.4, this.getHeight() * 0.07);
                    this.gfDance.anims.create({key: 'danceLeft', frameRate: 24, frames: this.anims.generateFrameNames('gfDance', {prefix: 'gfDance', end: 14, zeroPad: 4})});
                    this.gfDance.anims.create({key: 'danceRight', frameRate: 24, frames: this.anims.generateFrameNames('gfDance', {prefix: 'gfDance', start: 15, end: 29, zeroPad: 4})});
                    this.add.existing(this.gfDance);
                    this.addToCameras(this.gfDance, [this.cameras.main]);

                    this.logoBl = this.createSprite('logoBl', -150, -100);
                    this.logoBl.anims.create({key: 'bump', frameRate: 24, frames: this.anims.generateFrameNames('logoBl', {prefix: 'logo bumpin', end: 14, zeroPad: 4})});
                    this.add.existing(this.logoBl);
                    this.addToCameras(this.logoBl, [this.cameras.main]);

                    this.titleEnter = this.createSprite('titleEnter', 100, this.getHeight() * 0.8);
                    this.titleEnter.anims.create({key: 'idle', frameRate: 24, repeat: -1, frames: this.anims.generateFrameNames('titleEnter', {prefix: 'Press Enter to Begin', end: 44, zeroPad: 4})});
                    this.titleEnter.anims.create({key: 'press', frameRate: 24, repeat: -1, frames: this.anims.generateFrameNames('titleEnter', {prefix: 'ENTER PRESSED', end: 8, zeroPad: 4})});
                    this.titleEnter.anims.play('idle');
                    this.add.existing(this.titleEnter);
                    this.addToCameras(this.titleEnter, [this.cameras.main]);
                }

                beatHit(beat)
                {
                    super.beatHit(beat);

                    this.danceRight = !this.danceRight;

                    this.logoBl.anims.play('bump');
                    this.gfDance.anims.play('dance' + (this.danceRight ? 'Right' : 'Left'));
                }

                update(time)
                {
                    super.update(time);

                    if (MusicBeatState.music != null)
                        Conductor.instance.update(MusicBeatState.music.getCurrentTime() * 1000 ?? (1 / 60));

                    for (var key of Controls.list.get('accept'))
                    {
                        if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                        {
                            this.enterPresses++;
                            if (this.enterPresses == 1)
                            {
                                this.titleEnter.anims.play('press');
                                this.cameras.main.flash(1000, 255, 255, 255);
                                this.sound.add('confirm', {volume: 1, loop: false}).play();
                            }
                        }
                    }

                    if (this.enterPresses > 0)
                    {
                        this.transTimer += this.elapsed;
                        if (this.transTimer >= 1 || this.enterPresses > 1)
                            this.switchState('MainMenuState', MainMenuState);
                    }
                }
            }

            class CreditsState extends MusicBeatState
            {
                preload()
                {
                    super.preload();
                }

                create()
                {
                    super.create();
                }

                update(time)
                {
                    super.update(time);

                    /*
                    for (var key of Controls.list.get('ui_down'))
                        if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                            this.changeSelection(1);

                    for (var key of Controls.list.get('ui_up'))
                        if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                            this.changeSelection(-1);
                    */

                    for (var key of Controls.list.get('reject'))
                    {
                        if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                        {
                            var cnl = this.sound.add('cancel', {volume: 1, loop: false});
                            cnl.play();

                            this.switchState('MainMenuState', MainMenuState, [cnl]);
                        }
                    }
                }
            }

            class StoryMenuState extends MusicBeatState
            {
                enterPresses = 0;
                transTimer = 0;

                levelData = [];
                levels = [];
                curSelected = 0;

                bg;
                blackBar;

                difficultyText;
                arrowLeft;
                arrowRight;

                difficulties = [];
                difficultySelected = 0;

                preload()
                {
                    super.preload();

                    this.load.atlasXML('selector', 'https://codehs.com/uploads/6d27793282d1fd5df620562a706fb58f?.png', 'https://codehs.com/uploads/02274399b5ad02baaf4228dc4b56acb3?.xml');
                }

                create()
                {
                    super.create();

                    for (var level of LevelRegistry.levels)
                        if (level != null)
                            this.levelData.push(level);

                    for (var i=0; i<this.levelData.length; i++)
                    {
                        var level = this.createText(0, 0, this.levelData[i].name, 80, 'Phantomuff', '#ffffff', '#000000', 0, 'left');
                        this.screenCenter(level, 'X');
                        this.add.existing(level);
                        this.levels.push(level);
                    }

                    this.difficultyText = this.createText(this.getWidth() - 100, 456 + 30, 'HARD', 80, 'Phantomuff', '#ffffff', '#000000', 0, 'left');
                    this.difficultyText.x -= this.difficultyText.width;
                    this.add.existing(this.difficultyText);

                    var frames = 'selector';
                    this.arrowLeft = this.createSprite(frames, this.difficultyText.x - 70, this.difficultyText.y);
                    this.arrowLeft.anims.create({key: 'idle', frameRate: 24, repeat: -1, frames: this.arrowLeft.anims.generateFrameNames(frames, {prefix: 'arrow pointer loop', end: 14, zeroPad: 4})});
                    this.arrowLeft.anims.play('idle');
                    this.add.existing(this.arrowLeft);

                    this.arrowRight = this.createSprite(frames, this.difficultyText.x + 235, this.difficultyText.y);
                    this.arrowRight.flipX = true;
                    this.arrowRight.anims.create({key: 'idle', frameRate: 24, repeat: -1, frames: this.arrowRight.anims.generateFrameNames(frames, {prefix: 'arrow pointer loop', end: 14, zeroPad: 4})});
                    this.arrowRight.anims.play('idle');
                    this.add.existing(this.arrowRight);

                    this.bg = this.createRect(0, 56, this.getWidth(), 400, 0xFFF9CF51, 1);
                    this.add.existing(this.bg);

                    this.blackBar = this.createRect(0, 0, this.getWidth(), 56, 0xFF000000, 1);
                    this.add.existing(this.blackBar);

                    this.difficulties = Constants.DEFAULT_DIFFICULTY_LIST;
                    this.changeDifficulty(0);
                    this.changeSelection(0);
                }

                update(time)
                {
                    super.update(time);

                    if (this.enterPresses >= 0 && this.levels.length > 0)
                    {
                        for (var key of Controls.list.get('accept'))
                        {
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                            {
                                this.enterPresses++;
                                if (this.enterPresses == 1)
                                    this.sound.add('confirm', {volume: 1, loop: false}).play();
                            }
                        }
                    }

                    if (this.enterPresses == 0)
                    {
                        for (var key of Controls.list.get('ui_left'))
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                                this.changeDifficulty(-1);

                        for (var key of Controls.list.get('ui_down'))
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                                this.changeSelection(1);

                        for (var key of Controls.list.get('ui_up'))
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                                this.changeSelection(-1);

                        for (var key of Controls.list.get('ui_right'))
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                                this.changeDifficulty(1);

                        for (var key of Controls.list.get('reject'))
                        {
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                            {
                                this.enterPresses = -1;
                                
                                var cnl = this.sound.add('cancel', {volume: 1, loop: false});
                                cnl.play();

                                this.switchState('MainMenuState', MainMenuState, [cnl]);
                            }
                        }
                    }

                    if (this.enterPresses > 0)
                    {
                        this.transTimer += this.elapsed;
                        if (this.transTimer >= 1 || this.enterPresses > 1)
                        {
                            PlayState.playlist = new PlayStatePlaylist(true, this.levelData[this.curSelected].songs, (this.difficulties[this.difficultySelected] ?? Constants.DEFAULT_DIFFICULTY).toLowerCase());
                            this.switchState('PlayState', PlayState);
                        }
                    }

                    for (var i=0; i<this.levels.length; i++)
                        if (this.levels[i] != null)
                            this.levels[i].y = TSMath.baseLerp(this.levels[i].y, this.bg.y + this.bg.displayHeight + 30 + ((i - this.curSelected) * 120), 0.17);
                }

                changeSelection(change = 0)
                {
                    if (this.levels.length <= 0)
                    return;

                    var lastSelected = this.curSelected;
                    this.curSelected += change;

                    if (this.curSelected >= this.levels.length) this.curSelected = 0;
                    if (this.curSelected < 0) this.curSelected = this.levels.length - 1;

                    if (Math.abs(lastSelected - this.curSelected) != 0)
                        this.sound.add('scroll', {volume: 1, loop: false}).play();

                    for (var i=0; i<this.levels.length; i++)
                        this.levels[i].alpha = (i == this.curSelected ? 1 : 0.6);
                }

                changeDifficulty(change = 0)
                {
                    if (this.levels.length <= 0)
                        return;

                    this.difficultySelected += change;

                    if (this.difficultySelected >= this.difficulties.length) this.difficultySelected = 0;
                    if (this.difficultySelected < 0) this.difficultySelected = this.difficulties.length - 1;

                    var difficulty = this.difficulties[this.difficultySelected] ?? Constants.DEFAULT_DIFFICULTY;

                    switch (difficulty.toLowerCase())
                    {
                        case 'normal':
                            difficulty = 'norm';
                            break;
                    }

                    this.difficultyText.text = difficulty;

                    switch (difficulty.toLowerCase())
                    {
                        case 'hard':
                            this.difficultyText.setColor('#ff0000');
                            break;

                        case 'norm':
                            this.difficultyText.setColor('#ffff00');
                            break;

                        case 'easy':
                            this.difficultyText.setColor('#00ff00');
                            break;

                        default:
                            this.difficultyText.setColor('#ffffff');
                            break;
                    }
                }
            }

            class FreeplaySubState
            {
                static TEXT_SCALE = 1.3; // should be 0.8 with the '5by7' font but it isn't working at the moment.
            
                static precache(scene)
                {
                    scene.load.image('freeplayPinkBack', 'https://codehs.com/uploads/a975e58e63298b78008d2eca74164163?.png');
                    scene.load.image('freeplayBGdadShadow', 'https://codehs.com/uploads/8d32aace3a89d2cb252210c8ee5c8308?.png');
                    scene.load.image('freeplayBGdad', 'https://codehs.com/uploads/f037784409d33c702aa2914e9109146f?.png');

                    scene.load.atlasXML('freeplaySelector', 'https://codehs.com/uploads/6d27793282d1fd5df620562a706fb58f?.png', 'https://codehs.com/uploads/02274399b5ad02baaf4228dc4b56acb3?.xml');
                }

                scene;

                constructor(scene)
                {
                    this.scene = scene;

                    this.pinkBack = this.scene.createImage('freeplayPinkBack', 0, 0);
                    this.pinkBack.setTint(0xFFFFD4E9);
                    this.pinkBack.x -= this.pinkBack.width;
                    this.scene.add.existing(this.pinkBack);
                    this.scene.addToCameras(this.pinkBack, [this.scene.camFreeplay]);

                    this.bgDadShadow = this.scene.createImage('freeplayBGdadShadow', this.scene.camFreeplay.width, 0);
                    this.bgDadShadow.scaleX = this.bgDadShadow.scaleY = (this.scene.camFreeplay.height / this.bgDadShadow.height);
                    this.scene.add.existing(this.bgDadShadow);
                    this.scene.addToCameras(this.bgDadShadow, [this.scene.camFreeplay]);

                    this.bgDad = this.scene.createImage('freeplayBGdad', this.pinkBack.width * 0.74, 0);
                    this.bgDad.scaleX = this.bgDad.scaleY = (this.scene.camFreeplay.height / this.bgDad.height);
                    this.bgDad.visible = false;
                    this.scene.add.existing(this.bgDad);
                    this.scene.addToCameras(this.bgDad, [this.scene.camFreeplay]);

                    var allSongs = [];
                    for (var level of LevelRegistry.levels)
                    if (level.showInFreeplay())
                        for (var song of level.songs)
                        allSongs.push(song);

                    for (var i=0; i<(allSongs.length + 1); i++)
                    {
                        if (i > 0 && allSongs[i-1].name.length <= 0)
                            return;

                        if (i > 0)
                        {
                            var song = allSongs[i-1].name;
                            if (song != null && song.length > 0 && song.endsWith('-erect'))
                                if (SongRegistry.getByName(song.replace('-erect', '')))
                                    continue;
                        }

                        var option = this.scene.createText(0, 100 + i * 100, (i == 0 ? 'Random' : allSongs[i-1].name), Math.floor(40 * FreeplaySubState.TEXT_SCALE), 'Phantomuff', '#ffffff', '#000000', 0, 'left');
                        this.scene.add.existing(option);
                        this.scene.addToCameras(option, [this.scene.camFreeplay]);
                        this.songs.push(option);

                        if (i > 0) this.songData.push(allSongs[i-1]);
                    }

                    this.overhangBar = this.scene.createRect(0, 0, this.scene.camFreeplay.width, 64, 0xff000000, 1);
                    this.overhangBar.y -= this.overhangBar.height;
                    this.scene.add.existing(this.overhangBar);
                    this.scene.addToCameras(this.overhangBar, [this.scene.camFreeplay]);

                    this.freeplayTxt = this.scene.createText(8, 8, 'FREEPLAY', 48, 'Vcr', '#ffffff', '#000000', 0, 'left');
                    this.scene.add.existing(this.freeplayTxt);
                    this.scene.addToCameras(this.freeplayTxt, [this.scene.camFreeplay]);
                    this.freeplayTxt.visible = false;

                    this.difficultyText = this.scene.createText(90, 80, 'HARD', 80, 'Phantomuff', '#ffffff', '#000000', 0, 'left');
                    this.scene.add.existing(this.difficultyText);
                    this.scene.addToCameras(this.difficultyText, [this.scene.camFreeplay]);

                    var frames = 'freeplaySelector';
                    this.arrowLeft = this.scene.createSprite(frames, 20, this.difficultyText.y);
                    this.arrowLeft.anims.create({key: 'idle', frameRate: 24, repeat: -1, frames: this.arrowLeft.anims.generateFrameNames(frames, {prefix: 'arrow pointer loop', end: 14, zeroPad: 4})});
                    this.arrowLeft.anims.play('idle');
                    this.scene.add.existing(this.arrowLeft);
                    this.scene.addToCameras(this.arrowLeft, [this.scene.camFreeplay]);

                    this.arrowRight = this.scene.createSprite(frames, 325, this.difficultyText.y);
                    this.arrowRight.flipX = true;
                    this.arrowRight.anims.create({key: 'idle', frameRate: 24, repeat: -1, frames: this.arrowRight.anims.generateFrameNames(frames, {prefix: 'arrow pointer loop', end: 14, zeroPad: 4})});
                    this.arrowRight.anims.play('idle');
                    this.scene.add.existing(this.arrowRight);
                    this.scene.addToCameras(this.arrowRight, [this.scene.camFreeplay]);

                    this.difficultyText.visible = false;
                    this.arrowLeft.visible = false;
                    this.arrowRight.visible = false;

                    this.scene.camFreeplay.visible = false;

                    this.changeSelection(0);
                }

                enterPresses = 0;
                transTimer = 0;

                songs = [];
                songData = [];
                erectSongs = [];
                curSelected = 0;

                pinkBack;
                bgDadShadow;
                bgDad;

                difficultyText;
                arrowLeft;
                arrowRight;

                overhangBar;
                freeplayTxt;

                isOpen = false;

                open()
                {
                    this.scene.camFreeplay.visible = true;
                    this.enterPresses = 0;

                    this.pinkBack.x = -this.pinkBack.width;
                    this.bgDadShadow.x = this.scene.camFreeplay.width;
                    this.overhangBar.y = -this.overhangBar.height;

                    for (var song of this.songs)
                    {
                        if (song != null)
                        {
                            song.visible = true;
                            song.x = this.scene.camFreeplay.width;
                        }
                    }

                    this.scene.tweens.add
                    ({
                        targets: this.pinkBack,
                        x: 0,
                        duration: 600,
                        ease: Phaser.Math.Easing.Quartic.Out
                    });

                    this.scene.tweens.add
                    ({
                        targets: this.bgDadShadow,
                        x: this.bgDad.x,
                        duration: 700,
                        ease: Phaser.Math.Easing.Quintic.Out
                    });

                    this.scene.tweens.add
                    ({
                        targets: this.overhangBar,
                        y: 0,
                        duration: 300,
                        ease: Phaser.Math.Easing.Quartic.Out
                    });

                    var script = this;
                    this.scene.time.addEvent // bf dj
                    ({
                        delay: 800,
                        repeat: 0,
                        callback: function()
                        {
                            script.pinkBack.setTint(0xFFFFD863);
                            script.bgDad.visible = true;
                            script.isOpen = true;
                            script.freeplayTxt.visible = true;

                            script.difficultyText.visible = true;
                            script.arrowLeft.visible = true;
                            script.arrowRight.visible = true;
                        }
                    });
                }

                close()
                {
                    this.pinkBack.setTint(0xFFFFD4E9);
                    this.bgDad.visible = false;
                    this.freeplayTxt.visible = false;

                    this.difficultyText.visible = false;
                    this.arrowLeft.visible = false;
                    this.arrowRight.visible = false;

                    for (var song of this.songs)
                        if (song != null)
                            song.visible = false;

                    this.scene.tweens.add
                    ({
                        targets: this.pinkBack,
                        x: -this.pinkBack.width,
                        duration: 600,
                        ease: Phaser.Math.Easing.Quartic.Out
                    });

                    this.scene.tweens.add
                    ({
                        targets: this.bgDadShadow,
                        x: this.scene.camFreeplay.width,
                        duration: 700,
                        ease: Phaser.Math.Easing.Quintic.Out
                    });

                    this.scene.tweens.add
                    ({
                        targets: this.overhangBar,
                        y: -this.overhangBar.height,
                        duration: 300,
                        ease: Phaser.Math.Easing.Quartic.Out
                    });

                    var script = this;
                    this.scene.time.addEvent // bf dj
                    ({
                        delay: 800,
                        repeat: 0,
                        callback: function()
                        {
                            script.isOpen = false;

                            script.scene.enterPresses = 0;
                            script.scene.transTimer = 0;

                            script.scene.camFreeplay.visible = false;
                        }
                    });
                }

                onAccept()
                {
                    if (this.enterPresses >= 0 && this.songs.length > 0)
                    {
                        this.enterPresses++;
                        if (this.enterPresses == 1)
                        {
                            this.scene.sound.add('confirm', {volume: 1, loop: false}).play();
                            if (this.curSelected == 0)
                                this.changeSelection(Math.floor(Math.random() * (this.songs.length - 1) + 1));
                        }
                    }
                }

                onReject()
                {
                    if (this.enterPresses == 0)
                    {
                        this.enterPresses = -1;
                        
                        var cnl = this.scene.sound.add('cancel', {volume: 1, loop: false});
                        cnl.play();

                        this.close();
                    }
                }

                update(elapsed)
                {
                    if (this.isOpen)
                    {
                        if (this.enterPresses > 0)
                        {
                            this.transTimer += elapsed;
                            if (this.transTimer >= 1 || this.enterPresses > 1)
                            {
                                var isErect = (this.difficulties[this.difficultySelected] == 'erect' || this.difficulties[this.difficultySelected] == 'nightmare');

                                PlayState.playlist = new PlayStatePlaylist(false, [SongRegistry.getByName(this.songData[this.curSelected - 1].name + (isErect ? '-erect' : ''))], (this.difficulties[this.difficultySelected] ?? Constants.DEFAULT_DIFFICULTY).toLowerCase());
                                this.scene.switchState('PlayState', PlayState);
                            }
                        }
                        else if (this.enterPresses == 0)
                        {
                            for (var key of Controls.list.get('ui_left'))
                                if (Phaser.Input.Keyboard.JustDown(this.scene.input.keyboard.addKey(key)))
                                    this.changeDifficulty(-1);

                            for (var key of Controls.list.get('ui_right'))
                                if (Phaser.Input.Keyboard.JustDown(this.scene.input.keyboard.addKey(key)))
                                    this.changeDifficulty(1);
                        }

                        for (var i=0; i<this.songs.length; i++)
                        {
                            if (this.songs[i] != null)
                            {
                                var targetY = (i - this.curSelected);
                                var scaledY = TSMath.remapToRange(targetY, 0, 1, 0, 1.3);
                                this.songs[i].x = TSMath.fpsLerp(this.songs[i].x, ((Math.abs(targetY - 1) * -1) * 50) + (this.scene.camFreeplay.width / 2), 0.16, elapsed);
                                this.songs[i].y = TSMath.fpsLerp(this.songs[i].y, (scaledY * 100) + (this.scene.camFreeplay.height * 0.3), 0.16, elapsed);
                            }
                        }
                    }
                }

                changeSelection(change = 0)
                {
                    if (this.songs.length <= 0 || (this.enterPresses != 0 && this.curSelected != 0))
                    return;

                    var lastSelected = this.curSelected;
                    this.curSelected += change;

                    if (this.curSelected >= this.songs.length) this.curSelected = 0;
                    if (this.curSelected < 0) this.curSelected = this.songs.length - 1;

                    if (Math.abs(lastSelected - this.curSelected) != 0)
                        this.scene.sound.add('scroll', {volume: 1, loop: false}).play();

                    for (var i=0; i<this.songs.length; i++)
                        this.songs[i].alpha = (i == this.curSelected ? 1 : 0.6);

                    var hasErect = (this.curSelected == 0);
                    if (this.curSelected > 0 && SongRegistry.getByName(this.songData[this.curSelected - 1].name + '-erect') != null)
                        hasErect = true;
                    
                    this.difficulties = (hasErect ? Constants.DEFAULT_DIFFICULTY_LIST_FULL : Constants.DEFAULT_DIFFICULTY_LIST);
                    this.changeDifficulty(0);
                }

                difficulties = [];
                difficultySelected = 0;

                changeDifficulty(change = 0)
                {
                    if (this.songs.length <= 0)
                        return;

                    this.difficultySelected += change;

                    if (this.difficultySelected >= this.difficulties.length) this.difficultySelected = 0;
                    if (this.difficultySelected < 0) this.difficultySelected = this.difficulties.length - 1;

                    var difficulty = this.difficulties[this.difficultySelected] ?? Constants.DEFAULT_DIFFICULTY;

                    switch (difficulty.toLowerCase())
                    {
                        case 'nightmare':
                            difficulty = 'night';
                            break;

                        case 'normal':
                            difficulty = 'norm';
                            break;
                    }

                    this.difficultyText.text = difficulty;

                    switch (difficulty.toLowerCase())
                    {
                        case 'night':
                            this.difficultyText.setColor('#8949fe');
                            break;

                        case 'erect':
                            this.difficultyText.setColor('#fd579d');
                            break;

                        case 'hard':
                            this.difficultyText.setColor('#ff0000');
                            break;

                        case 'norm':
                            this.difficultyText.setColor('#ffff00');
                            break;

                        case 'easy':
                            this.difficultyText.setColor('#00ff00');
                            break;

                        default:
                            this.difficultyText.setColor('#000000');
                            break;
                    }
                }
            }

            class OptionsState extends MusicBeatState
            {
                curSelected = 0;
                    
                enterPresses = 0;
                transTimer = 0;

                list = ['preferences', 'controls', 'exit'];
                options = [];

                preload()
                {
                    super.preload();

                    this.load.image('desatBG', "https://codehs.com/uploads/17c518129e9a4f26524bf25c3a201036");
                    AtlasText.precache(this);
                }

                create()
                {
                    super.create();

                    var bg = this.createImage('desatBG', 0, 0);
                    bg.setTint(0xFFea71fd);
                    this.add.existing(bg);
                    this.addToCameras(bg, [this.cameras.main]);

                    for (var i=0; i<this.list.length; i++)
                    {
                        var option = new AtlasText(this, 0, 100 + i * 100, this.list[i], true);
                        option.targetY = i;
                        option.draw(this);
                        this.screenCenter(option, 'X');
                        this.options.push(option);
                    }

                    this.changeSelection();
                }

                changeSelection(change = 0)
                {
                    if (this.options.length <= 0)
                        return;
                    
                    var lastSelected = this.curSelected;
                    this.curSelected += change;

                    if (this.curSelected >= this.options.length) this.curSelected = 0;
                    if (this.curSelected < 0) this.curSelected = this.options.length - 1;

                    if (Math.abs(lastSelected - this.curSelected) != 0)
                        this.sound.add('scroll', {volume: 0.4, loop: false}).play();

                    for (var i=0; i<this.options.length; i++)
                        this.options[i].alpha = (i == this.curSelected ? 1 : 0.6);
                }

                update(time)
                {
                    super.update(time);

                    for (var option of this.options)
                        option.update(this.elapsed);

                    if (this.enterPresses >= 0)
                    {
                        for (var key of Controls.list.get('accept'))
                        {
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                            {
                                if (this.options.length > 0)
                                {
                                    this.enterPresses++;
                                    if (this.enterPresses == 1)
                                        this.sound.add('confirm', {volume: 1, loop: false}).play();
                                }
                            }
                        }
                    }

                    if (this.enterPresses == 0)
                    {
                        for (var key of Controls.list.get('ui_down'))
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                                this.changeSelection(1);

                        for (var key of Controls.list.get('ui_up'))
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                                this.changeSelection(-1);

                        for (var key of Controls.list.get('reject'))
                        {
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                            {
                                this.enterPresses = -1;
                                
                                var cnl = this.sound.add('cancel', {volume: 1, loop: false});
                                cnl.play();

                                this.switchState('MainMenuState', MainMenuState, [cnl]);
                            }
                        }
                    }

                    if (this.enterPresses > 0)
                    {
                        this.transTimer += this.elapsed;
                        if (this.transTimer >= 1 || this.enterPresses > 1)
                        {
                            switch (this.list[this.curSelected])
                            {
                                case 'preferences':
                                    this.switchState('PreferencesState', PreferencesState);
                                    break;

                                case 'controls':
                                    this.switchState('ControlsState', ControlsState);
                                    break;

                                default:
                                    this.switchState('MainMenuState', MainMenuState);
                                    break;
                            }
                        }
                    }
                }
            }

            class ControlsState extends MusicBeatState
            {
                preload()
                {
                    super.preload();

                    this.load.image('desatBG', "https://codehs.com/uploads/17c518129e9a4f26524bf25c3a201036");
                    // AtlasText.precache(this);
                }

                controls = ['note_left', 'note_down', 'note_up', 'note_right', 'ui_left', 'ui_down', 'ui_up', 'ui_right', 'pause', 'accept', 'reject'];
                titles = [];
                keyRow1 = [];
                keyRow2 = [];

                bindingBlack;
                bindingBG;
                bindingText;
                bindingHint;
                binding = false;

                curSelected = 0;
                curRow = 0;
                followY = 0;

                camBinding;

                addToCameras(item, cameras = [])
                {
                    var allCameras = [this.cameras.main, this.camBinding];
                    for (var cam of allCameras)
                        if (!cameras.includes(cam))
                            cam.ignore(item);
                }

                create()
                {
                    super.create();

                    this.camBinding = new Phaser.Cameras.Scene2D.Camera(0, 0, this.getWidth(), this.getHeight());
                    this.cameras.addExisting(this.camBinding, false);

                    var bg = this.createImage('desatBG', 0, 0);
                    bg.setTint(0xFFea71fd);
                    bg.scrollFactorY = 0;
                    this.add.existing(bg);
                    this.addToCameras(bg, [this.cameras.main]);

                    for (var i=0; i<this.controls.length; i++)
                    {
                        var option = new AtlasText(this, 50, (120 * i) + 30, this.controls[i].replace('_', ' '), true);
                        option.targetY = i;
                        option.draw(this);
                        option.addToCameras(this, [this.cameras.main]);
                        this.titles.push(option);
                        
                        var key = new AtlasText(this, option.x + 600, (120 * i) + 30, this.keyFromCode(Controls.list.get(this.controls[i])[0]), false);
                        key.targetY = i;
                        key.draw(this);
                        key.addToCameras(this, [this.cameras.main]);
                        this.keyRow1.push(key);

                        var key = new AtlasText(this, option.x + 900, (120 * i) + 30, this.keyFromCode(Controls.list.get(this.controls[i])[1]), false);
                        key.targetY = i;
                        key.draw(this);
                        key.addToCameras(this, [this.cameras.main]);
                        this.keyRow2.push(key);
                    }

                    this.bindingBlack = this.createRect(0, 0, this.getWidth(), this.getHeight(), 0x99000000, 0.6);
                    this.bindingBlack.alpha = 0.6;
                    this.bindingBlack.scrollFactorX = this.bindingBlack.scrollFactorY = 0;
                    this.add.existing(this.bindingBlack);
                    this.addToCameras(this.bindingBlack, [this.camBinding]);

                    this.bindingBG = this.createRect(0, 0, this.getWidth() / 1.5, this.getHeight() / 1.5, 0xfff9cf51, 1);
                    this.bindingBG.scrollFactorX = this.bindingBG.scrollFactorY = 0;
                    this.screenCenter(this.bindingBG);
                    this.add.existing(this.bindingBG);
                    this.addToCameras(this.bindingBG, [this.camBinding]);

                    this.bindingText = new AtlasText(this, 0, this.bindingBG.y + 15, 'BINDING KEY', true);
                    this.bindingText.draw(this);
                    this.bindingText.scrollFactorX = this.bindingText.scrollFactorY = 0;
                    this.screenCenter(this.bindingText, 'X');
                    this.bindingText.addToCameras(this, [this.camBinding]);

                    this.bindingHint = new AtlasText(this, 0, this.bindingBG.y + this.bindingBG.height - 115, 'ESCAPE TO CANCEL', true);
                    this.bindingHint.draw(this);
                    this.bindingHint.scrollFactorX = this.bindingHint.scrollFactorY = 0;
                    this.screenCenter(this.bindingHint, 'X');
                    this.bindingHint.addToCameras(this, [this.camBinding]);

                    this.closeBinding();

                    var script = this;
                    this.input.keyboard.on('keydown', script.onKeyPress, this)

                    this.changeSelection(0);
                    this.changeRow(0);
                    if (this.titles.length > 0) this.followY = (this.titles[this.curSelected].y + (this.titles[this.curSelected].height/2));
                }

                keyFromCode(code)
                {
                    switch (code)
                    {
                        case 37: return 'LEFT';
                        case 40: return 'DOWN';
                        case 38: return 'UP';
                        case 39: return 'RIGHT';
                        case 8: return 'BKSP';
                        case 9: return 'TAB';
                        case 13: return 'ENTER';
                        case 16: return 'SHIFT';
                        case 17: return 'CTRL';
                        case 18: return 'ALT';
                        case 20: return 'CPSLK';
                        case 27: return 'ESC';
                        case 32: return 'SPACE';
                        default: return String.fromCharCode(code).toUpperCase();
                    }
                }

                onKeyPress(key)
                {
                    if (this.binding)
                    {
                        if (key.keyCode == 27) 
                        {
                            this.closeBinding();
                            return;
                        }

                        var ogKeys = Controls.list.get(this.controls[this.curSelected]);
                        ogKeys[this.curRow] = key.keyCode;
                        Controls.list.set(this.controls[this.curSelected], ogKeys);

                        if (this.curRow == 0)
                        {
                            this.keyRow1[this.curSelected].setText(this, this.keyFromCode(Controls.list.get(this.controls[this.curSelected])[0]));
                            this.keyRow1[this.curSelected].addToCameras(this, [this.cameras.main]);
                        }
                        else if (this.curRow == 1)
                        {
                            this.keyRow2[this.curSelected].setText(this, this.keyFromCode(Controls.list.get(this.controls[this.curSelected])[1]));
                            this.keyRow2[this.curSelected].addToCameras(this, [this.cameras.main]);
                        }

                        this.closeBinding();
                    }
                }
                
                openBinding()
                {
                    this.camBinding.visible = true;
                    this.binding = true;
                }

                unbindNext = false;
                unbindTmr = 0;
                closeBinding()
                {
                    this.camBinding.visible = false;
                    this.binding = false;
                    this.unbindNext = true;
                }

                update(time)
                {
                    super.update(time);
                
                    if (!this.binding && !this.unbindNext)
                    {
                        for (var key of Controls.list.get('ui_down'))
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                                this.changeSelection(1);

                        for (var key of Controls.list.get('ui_up'))
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                                this.changeSelection(-1);

                        for (var key of Controls.list.get('ui_left'))
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                                this.changeRow(-1);

                        for (var key of Controls.list.get('ui_right'))
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                                this.changeRow(1);

                        for (var key of Controls.list.get('reject'))
                        {
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                            {
                                var cnl = this.sound.add('cancel', {volume: 1, loop: false});
                                cnl.play();

                                this.switchState('OptionsState', OptionsState, [cnl]);
                            }
                        }

                        for (var key of Controls.list.get('accept'))
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                                this.openBinding();
                    }

                    if (this.unbindNext)
                    {
                        this.unbindTmr += this.elapsed;
                        if (this.unbindTmr > 0.3)
                        {
                            this.unbindTmr = false;
                            this.unbindNext = false; // stall controls
                        }
                    }

                    if (this.bindingText != null) this.bindingText.update(this.elapsed);
                    if (this.bindingHint != null) this.bindingHint.update(this.elapsed);

                    for (var option of this.titles)
                        if (option != null)
                            option.update(this.elapsed);

                    for (var key of this.keyRow1)
                        if (key != null)
                            key.update(this.elapsed);

                    for (var key of this.keyRow2)
                        if (key != null)
                            key.update(this.elapsed);

                    if (this.titles.length > 0) this.followY = TSMath.baseLerp(this.followY, (this.titles[this.curSelected].y + (this.titles[this.curSelected].height/2)), 0.072);
                    this.cameras.main.centerOnY(this.followY);
                }

                changeSelection(change = 0)
                {
                    if (this.titles.length <= 0)
                        return;

                    var lastSelected = this.curSelected;
                    this.curSelected += change;

                    if (this.curSelected >= this.titles.length) this.curSelected = 0;
                    if (this.curSelected < 0) this.curSelected = this.titles.length - 1;

                    if (Math.abs(lastSelected - this.curSelected) != 0)
                        this.sound.add('scroll', {volume: 1, loop: false}).play();

                    this.changeRow(0);
                }

                changeRow(change = 0)
                {
                    var lastRow = this.curRow;
                    this.curRow += change;

                    if (this.curRow > 1) this.curRow = 0;
                    if (this.curRow < 0) this.curRow = 1;

                    if (Math.abs(lastRow - this.curRow) != 0)
                        this.sound.add('scroll', {volume: 1, loop: false}).play();

                    for (var i=0; i<this.keyRow1.length; i++)
                        this.keyRow1[i].alpha = ((i == this.curSelected && this.curRow == 0) ? 1 : 0.6);
                    for (var i=0; i<this.keyRow2.length; i++)
                        this.keyRow2[i].alpha = ((i == this.curSelected && this.curRow == 1) ? 1 : 0.6);
                }
            }

            class PreferencesState extends MusicBeatState
            {
                preload()
                {
                    super.preload();

                    this.load.image('desatBG', "https://codehs.com/uploads/17c518129e9a4f26524bf25c3a201036");
                    this.load.atlasXML('uiCheckbox', 'https://codehs.com/uploads/d9a5128a1122d6f9489087e3127fb347', 'https://codehs.com/uploads/c99e08196f430ad59115e41df01300a1');
                    AtlasText.precache(this);
                }

                preferences = [];
                checkboxes = [];
                options = [];

                curSelected = 0;
                followY = 0;

                create()
                {
                    super.create();

                    var bg = this.createImage('desatBG', 0, 0);
                    bg.setTint(0xFFea71fd);
                    bg.scrollFactorY = 0;
                    this.add.existing(bg);
                    this.addToCameras(bg, [this.cameras.main]);

                    for (var i=0; i<PreferenceRegistry.preferences.length; i++)
                    {
                        this.preferences.push(PreferenceRegistry.preferences[i].name);

                        var box = new Checkbox(this, 30, (120 * i) + 30, PreferenceRegistry.getByName(this.preferences[i]).value);
                        this.add.existing(box);
                        this.checkboxes.push(box);

                        var option = new AtlasText(this, 120, (120 * i) + 30, this.preferences[i], true);
                        option.targetY = i;
                        option.x = 150;
                        option.draw(this);
                        this.options.push(option);
                    }

                    this.changeSelection(0);
                    if (this.options.length > 0) this.followY = ((this.options[this.curSelected].y + (this.options[this.curSelected].height/2))+this.getWidth())/4;
                }

                update(time)
                {
                    super.update(time);
                
                    for (var key of Controls.list.get('ui_down'))
                        if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                            this.changeSelection(1);

                    for (var key of Controls.list.get('ui_up'))
                        if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                            this.changeSelection(-1);

                    for (var key of Controls.list.get('reject'))
                    {
                        if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                        {
                            var cnl = this.sound.add('cancel', {volume: 1, loop: false});
                            cnl.play();

                            this.switchState('OptionsState', OptionsState, [cnl]);
                        }
                    }

                    for (var key of Controls.list.get('accept'))
                    {
                        if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                        {
                            if (this.checkboxes[this.curSelected] != null)
                            {
                                var newVal = (!PreferenceRegistry.getByName(this.preferences[this.curSelected]).value) ?? false;
                                PreferenceRegistry.changeValue(this.preferences[this.curSelected], newVal);
                                this.checkboxes[this.curSelected].setVal(newVal);
                            }
                        }
                    }

                    for (var option of this.options)
                        if (option != null)
                            option.update(this.elapsed);

                    for (var chkbox of this.checkboxes)
                        if (chkbox != null)
                            chkbox.update();

                    if (this.options.length > 0) this.followY = TSMath.baseLerp(this.followY, ((this.options[this.curSelected].y + (this.options[this.curSelected].height/2))+this.getWidth())/4, 0.072);
                    this.cameras.main.centerOnY(this.followY);
                }

                changeSelection(change = 0)
                {
                    if (this.options.length <= 0)
                        return;

                    var lastSelected = this.curSelected;
                    this.curSelected += change;

                    if (this.curSelected >= this.options.length) this.curSelected = 0;
                    if (this.curSelected < 0) this.curSelected = this.options.length - 1;

                    if (Math.abs(lastSelected - this.curSelected) != 0)
                        this.sound.add('scroll', {volume: 1, loop: false}).play();

                    for (var i=0; i<this.options.length; i++)
                        this.options[i].alpha = (i == this.curSelected ? 1 : 0.6);
                }
            }

            class Checkbox extends Phaser.GameObjects.Sprite
            {
                actualX = 0;
                actualY = 0;

                offset = {x: 0, y: 0};

                constructor(scene, x, y, val)
                {
                    super(scene, x, y, 'uiCheckbox');
                    this.setOrigin(0, 0);
                    this.actualX = x;
                    this.actualY = y;

                    this.anims.create({key: 'static', frameRate: 24, frames: this.anims.generateFrameNames('uiCheckbox', {prefix: 'Check Box unselected', end: 0, zeroPad: 4})});
                    this.anims.create({key: 'checked', frameRate: 24, frames: this.anims.generateFrameNames('uiCheckbox', {prefix: 'Check Box selecting animation', end: 10, zeroPad: 4})});
                    this.anims.play('static');

                    this.scaleX = this.scaleY = 0.7;

                    this.setVal(val);
                }

                update()
                {
                    switch (this.anims.getName())
                    {
                        case 'static':
                            this.offset = {x: 0, y: 0};
                            break;
                        case 'checked':
                            this.offset = {x: 17, y: 70};
                            break;
                    }

                    this.x = this.actualX - this.offset.x;
                    this.y = this.actualY - this.offset.y;
                }

                setVal(value)
                {
                    if (value)
                        this.anims.play('checked');
                    else
                        this.anims.play('static');
                }
            }

            class MainMenuState extends MusicBeatState
            {
                static openFreeplayOnReady = false;

                options = ['storymode', 'freeplay', 'options', 'credits'];
                menuItems = [];
                curSelected = 0;
                camFollow = {base: 0, lerp: 0};

                enterPresses = 0;
                transTimer = 0;

                camFreeplay;
                freeplay;
                
                constructor() { super('MainMenuState'); }

                preload()
                {
                    super.preload();

                    this.load.image('menuBG', 'https://codehs.com/uploads/12a7fe4e84f444bc668ad63018022698');

                    this.load.atlasXML('storymode', 'https://codehs.com/uploads/c6f2d4e44a6ffecd7179bc1db0c72434?.png', 'https://codehs.com/uploads/546b625dc5d1263364011aa895511ebf?.xml');
                    this.load.atlasXML('freeplay', 'https://codehs.com/uploads/637295ce7d40787aa3a94d9c451b0f36?.png', 'https://codehs.com/uploads/2dc4e6ec3f5072458015139493350181?.xml');
                    this.load.atlasXML('options', 'https://codehs.com/uploads/cc00b88b1ff3b525d6274cf2ead9409a?.png', 'https://codehs.com/uploads/fe43068fa3d3b0bea843e9380bf5e932?.xml');
                    this.load.atlasXML('credits', 'https://codehs.com/uploads/626497b44d0ca1ac5dee7111e97d0c4e?.png', 'https://codehs.com/uploads/432f2b3f68d598bdcc9162fa25d36640?.xml');

                    FreeplaySubState.precache(this);
                }

                addToCameras(item, cameras = [])
                {
                    var allCameras = [this.cameras.main, this.camFreeplay];
                    for (var cam of allCameras)
                    if (!cameras.includes(cam))
                        cam.ignore(item);
                }

                create()
                {
                    super.create();

                    this.camFreeplay = new Phaser.Cameras.Scene2D.Camera(0, 0, this.getWidth(), this.getHeight());
                    this.cameras.addExisting(this.camFreeplay, false);

                    var menuBG = this.createImage('menuBG', 0, 0);
                    menuBG.scaleX = menuBG.scaleY = 1.175;
                    menuBG.scrollFactorY = 0.17;
                    this.screenCenter(menuBG);
                    this.add.existing(menuBG);
                    this.addToCameras(menuBG, [this.cameras.main]);

                    for (var i = 0; i < this.options.length; i++)
                    {
                        var menuItem = this.createSprite(this.options[i], 0, 0);

                        menuItem.anims.create({key: 'idle', frameRate: 24, repeat: -1, frames: menuItem.anims.generateFrameNames(this.options[i], {prefix: this.options[i] + ' idle', end: 8, zeroPad: 4})});
                        menuItem.anims.create({key: 'selected', frameRate: 24, repeat: -1, frames: menuItem.anims.generateFrameNames(this.options[i], {prefix: this.options[i] + ' selected', end: 2, zeroPad: 4})});
                        menuItem.anims.play('idle');

                        this.menuItems.push(menuItem);
                        this.add.existing(menuItem);
                        this.addToCameras(menuItem, [this.cameras.main]);

                        menuItem.scrollFactorY = 0.4;
                    }

                    this.changeSelection();
                    this.camFollow.lerp = this.camFollow.base;

                    var version = this.createText(5, this.cameras.main.height, "v0.4.1", 16, 'Vcr', '#ffffff', '#000000', 2, 'left');
                    version.scrollFactorX = version.scrollFactorY = 0;
                    version.y -= version.height;
                    this.add.existing(version);
                    this.addToCameras(version, [this.cameras.main]);

                    this.freeplay = new FreeplaySubState(this);

                    if (MainMenuState.openFreeplayOnReady)
                    {
                        MainMenuState.openFreeplayOnReady = false;
                        this.enterPresses = -2;

                        this.freeplay.open();
                    }
                }

                changeSelection(change = 0)
                {
                    if (this.menuItems.length <= 0)
                        return;
                    
                    var lastSelected = this.curSelected;
                    this.curSelected += change;

                    if (this.curSelected >= this.menuItems.length) this.curSelected = 0;
                    if (this.curSelected < 0) this.curSelected = this.menuItems.length - 1;

                    if (Math.abs(lastSelected - this.curSelected) != 0)
                        this.sound.add('scroll', {volume: 1, loop: false}).play();

                    for (var i = 0; i < this.menuItems.length; i++)
                    {
                        this.menuItems[i].anims.play(i == this.curSelected ? 'selected' : 'idle');
                        this.screenCenter(this.menuItems[i], 'X');

                        var spacing = 160;
                        var top = (this.getHeight() - (spacing * this.menuItems.length)) / 2;
                        this.menuItems[i].y = top + spacing * i - (i == this.curSelected ? this.menuItems[i].height / 8 : 0);
                    }

                    this.camFollow.base = this.menuItems[this.curSelected].y + this.menuItems[this.curSelected].height / 2;
                }

                update(time)
                {
                    super.update(time);

                    if (this.enterPresses >= 0 || this.freeplay.isOpen)
                    {
                        for (var key of Controls.list.get('accept'))
                        {
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                            {
                                if (this.freeplay.isOpen)
                                    this.freeplay.onAccept();
                                else if (this.menuItems.length > 0)
                                {
                                    this.enterPresses++;
                                    if (this.enterPresses == 1)
                                    this.sound.add('confirm', {volume: 1, loop: false}).play();
                                }
                            }
                        }
                    }

                    if (this.enterPresses == 0 || this.freeplay.isOpen)
                    {
                        for (var key of Controls.list.get('ui_down'))
                        {
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                            {
                                if (this.freeplay.isOpen) this.freeplay.changeSelection(1);
                                else this.changeSelection(1);
                            }
                        }

                        for (var key of Controls.list.get('ui_up'))
                        {
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                            {
                                if (this.freeplay.isOpen) this.freeplay.changeSelection(-1);
                                else this.changeSelection(-1);
                            }
                        }

                        for (var key of Controls.list.get('reject'))
                        {
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                            {
                                if (this.freeplay.isOpen)
                                    this.freeplay.onReject();
                                else
                                {
                                    this.enterPresses = -1;
                                    
                                    var cnl = this.sound.add('cancel', {volume: 1, loop: false});
                                    cnl.play();

                                    this.switchState('TitleState', TitleState, [cnl]);
                                }
                            }
                        }
                    }

                    if (this.enterPresses > 0 && !this.freeplay.isOpen)
                    {
                        this.transTimer += this.elapsed;
                        if (this.transTimer >= 1 || this.enterPresses > 1)
                        {
                            switch (this.options[this.curSelected].toLowerCase())
                            {
                                case 'storymode':
                                    this.switchState('StoryMenuState', StoryMenuState);
                                    break;

                                case 'freeplay':
                                    this.enterPresses = -2;
                                    this.freeplay.open();
                                    break;

                                case 'options':
                                    this.switchState('OptionsState', OptionsState);
                                    break;

                                case 'credits':
                                    this.switchState('CreditsState', CreditsState);
                                    break;

                                default:
                                    this.switchState('TitleState', TitleState);
                                    break;
                            }
                        }
                    }

                    this.camFollow.lerp = TSMath.baseLerp(this.camFollow.lerp, this.camFollow.base, 0.072);
                    this.cameras.main.centerOnY(this.camFollow.lerp);

                    this.freeplay.update(this.elapsed);
                }
            }

            class Note extends Phaser.GameObjects.Sprite
            {
                static precache(scene)
                {
                    scene.load.atlasXML('STRUMLINE_NOTES', 'https://codehs.com/uploads/d0afd214e27d42f517b5be860431cdd2?.png', 'https://codehs.com/uploads/1727def271c3d5289eebfd0a442bb4d5?.xml');
                }

                mustHit;
                line;
                time;
                type;

                mayHit = false;
                hasMissed = false;
                handledMiss = false;

                constructor(scene, mustHit = false, line = 0, time = 0, type = '')
                {
                    var frames = (PlayState.instance == null || !PlayState.instance.pixelUI) ? 'STRUMLINE_NOTES' : 'STRUMLINE_PIXEL';
                    super(scene, -10000, -10000, frames);
                    this.setOrigin(0, 0);

                    this.anims.create({key: 'scroll0', frameRate: 24, frames: this.anims.generateFrameNames(frames, {prefix: 'noteLeft', start: 1, end: 1, zeroPad: 4})});
                    this.anims.create({key: 'scroll1', frameRate: 24, frames: this.anims.generateFrameNames(frames, {prefix: 'noteDown', start: 1, end: 1, zeroPad: 4})});
                    this.anims.create({key: 'scroll2', frameRate: 24, frames: this.anims.generateFrameNames(frames, {prefix: 'noteUp', start: 1, end: 1, zeroPad: 4})});
                    this.anims.create({key: 'scroll3', frameRate: 24, frames: this.anims.generateFrameNames(frames, {prefix: 'noteRight', start: 1, end: 1, zeroPad: 4})});

                    this.mayHit = false;
                    this.hasMissed = false;
                    this.handledMiss = false;

                    this.mustHit = mustHit ?? false;
                    this.line = Math.floor(line % Strumline.KEY_COUNT) ?? 0;
                    this.time = time ?? 0;
                    this.type = type ?? '';

                    this.anims.play('scroll' + this.line);
                }

                kill()
                {
                    this.visible = false;
                    this.destroy();
                }
            }

            class NoteSplash extends Phaser.GameObjects.Sprite
            {
                static precache(scene)
                {
                    scene.load.atlasXML('STRUMLINE_NOTESPLASHES', 'https://codehs.com/uploads/93d32240f621641e5c2eee0b6190416c', 'https://codehs.com/uploads/916073f12fefead965446ec388efefb0')
                }

                animFinished = false;

                constructor(scene, note)
                {
                    super(scene, note.x, note.y, 'STRUMLINE_NOTESPLASHES');
                    this.setOrigin(0, 0);

                    for (var i=1; i<3; i++)
                    {
                        this.anims.create({key: 'splash0-' + i, frameRate: 24, frames: this.anims.generateFrameNames('STRUMLINE_NOTESPLASHES', {prefix: 'note impact ' + i + ' purple', end: 3, zeroPad: 4})});
                        this.anims.create({key: 'splash1-' + i, frameRate: 24, frames: this.anims.generateFrameNames('STRUMLINE_NOTESPLASHES', {prefix: 'note impact ' + i + ' blue', end: 3, zeroPad: 4})});
                        this.anims.create({key: 'splash2-' + i, frameRate: 24, frames: this.anims.generateFrameNames('STRUMLINE_NOTESPLASHES', {prefix: 'note impact ' + i + ' green', end: 3, zeroPad: 4})});
                        this.anims.create({key: 'splash3-' + i, frameRate: 24, frames: this.anims.generateFrameNames('STRUMLINE_NOTESPLASHES', {prefix: 'note impact ' + i + ' red', end: 3, zeroPad: 4})});
                    }

                    this.alpha = 0.6;
                    this.revive(note);
                }

                revive(note)
                {
                    this.animFinished = false;
                    this.visible = true;

                    this.x = note.x - (this.width * 0.3);
                    this.y = note.y - (this.height * 0.3);

                    this.anims.play('splash' + note.line + '-' + Math.floor(Math.random() * (2 - 1) + 1));
                    this.anims.currentAnim.frameRate = 24 + (Math.floor(Math.random() * (2 + 2) - 2));
                    this.anims.hideOnComplete = true;
                }

                update()
                {
                    if (!this.visible && !this.animFinished)
                        this.animFinished = true;
                }
                
                kill()
                {
                    this.visible = false;
                    this.destroy();
                }
            }

            class Strumline
            {
                static precache(scene)
                {
                    scene.load.atlasXML('STRUMLINE', 'https://codehs.com/uploads/f058b26f1ce073ac132673894932db5b?.png', 'https://codehs.com/uploads/1a3502bbd78c3acf6809f26bda178bc4?.xml');
                    scene.load.atlasXML('STRUMLINE_PIXEL', 'https://codehs.com/uploads/3bef32800523cbbb79b4b4fd67fa7ef8?.png', 'https://codehs.com/uploads/7f406fa2a5cc1257cbe637b4f3a68ca5?.xml');
                }

                static STRUMLINE_SIZE = 104;
                static NOTE_SPACING = Strumline.STRUMLINE_SIZE + 8;

                static INITIAL_OFFSET = -0.275 * Strumline.STRUMLINE_SIZE;
                static NUDGE = 2.0;

                static KEY_COUNT = 4;
                static NOTE_SPLASH_CAP = 6;

                static get_RENDER_DISTANCE_MS()
                {
                    return (Constants.SCREEN_WIDTH / Constants.PIXELS_PER_MS);
                }

                scene;
                strums = [];
                held = [];

                x;
                y;

                constructor(scene, x = 0, y = 0)
                {
                    this.scene = scene;
                    this.x = x;
                    this.y = y;

                    for (var i=0; i<Strumline.KEY_COUNT; i++)
                    {
                        var pixelBump = (PlayState.instance == null || !PlayState.instance.pixelUI) ? 0 : 0.3;
                        var strum = new StrumlineNote(this.scene, i, x + (Strumline.NOTE_SPACING * i) + (Strumline.NOTE_SPACING * pixelBump), y + (Strumline.NOTE_SPACING * pixelBump));
                        if (PlayState.instance == null || !PlayState.instance.pixelUI) strum.scaleX = strum.scaleY = 0.7;
                        this.strums.push(strum);
                        this.held.push(false);
                    }
                }

                draw(scene)
                {
                    for (var strum of this.strums)
                        scene.add.existing(strum);
                }

                addToCameras(scene, cameras)
                {
                    for (var strum of this.strums)
                        scene.addToCameras(strum, cameras);
                }
            }

            class StrumlineNote extends Phaser.GameObjects.Sprite
            {
                static DEFAULT_OFFSET = 28;
                static CONFIRM_HOLD_TIME = 0.25;

                confirmHoldTimer = -1;
                canIdle = true;

                line;
                directions = ['Left', 'Down', 'Up', 'Right'];

                baseX = 0;
                baseY = 0;

                constructor(scene, line = 0, x = 0, y = 0)
                {
                    var frames = (PlayState.instance == null || !PlayState.instance.pixelUI) ? 'STRUMLINE' : 'STRUMLINE_PIXEL';
                    super(scene, x, y, frames);
                    this.setOrigin(0, 0);

                    this.line = line;
                    this.baseX = x;
                    this.baseY = y;

                    for (var i=0; i<Strumline.KEY_COUNT; i++)
                    {
                        this.anims.create({key: 'static' + i, frameRate: 24, frames: this.anims.generateFrameNames(frames, {prefix: 'static' + this.directions[i], start: 1, end: 1, zeroPad: 4})});
                        this.anims.create({key: 'press' + i, frameRate: 24, frames: this.anims.generateFrameNames(frames, {prefix: 'press' + ((PlayState.instance == null || !PlayState.instance.pixelUI) ? '' : 'ed') + this.directions[i], start: 1, end: 4, zeroPad: 4})});
                        this.anims.create({key: 'confirm' + i, frameRate: 24, frames: this.anims.generateFrameNames(frames, {prefix: 'confirm' + this.directions[i], start: 1, end: 4, zeroPad: 4})});
                        this.anims.create({key: 'confirmHold' + i, frameRate: 24, frames: this.anims.generateFrameNames(frames, {prefix: 'confirmHold' + this.directions[i], start: 1, end: 4, zeroPad: 4})});
                    }

                    this.playAnim('static');
                }

                update(elapsed)
                {
                    if (this.confirmHoldTimer >= 0 && this.canIdle)
                    {
                        this.confirmHoldTimer += elapsed;

                        if (this.confirmHoldTimer >= StrumlineNote.CONFIRM_HOLD_TIME)
                        {
                            this.confirmHoldTimer = -1;
                            this.playAnim('static');
                        }
                    }
                }

                playAnim(name)
                {
                    this.anims.play(name + this.line);
                    this.set_position(this.baseX, this.baseY);
                }

                set_position(x, y)
                {
                    this.set_x(x);
                    this.set_y(y);
                }

                set_x(val)
                {
                    this.baseX = val;
                    this.x = val;

                    if ((PlayState.instance == null || !PlayState.instance.pixelUI) && this.anims.getName().startsWith('press')) this.x += StrumlineNote.DEFAULT_OFFSET;
                }

                set_y(val)
                {
                    this.baseY = val;
                    this.y = val;
                    if ((PlayState.instance == null || !PlayState.instance.pixelUI) && this.anims.getName().startsWith('press')) this.y += StrumlineNote.DEFAULT_OFFSET;
                }
            }

            class TailNote
            {
                static precache(scene)
                {
                    scene.load.atlasXML('STRUMLINE_NOTETAILS', 'https://codehs.com/uploads/0ec2f9b4aefa059070fc55362e5e4387?.png', 'https://codehs.com/uploads/95929715dcc760da3d6627c206e677ab?.xml')
                    scene.load.atlasXML('STRUMLINE_PIXELNOTETAILS', 'https://codehs.com/uploads/92ab6a85bccbfade2aeeadf6519383a1?.png', 'https://codehs.com/uploads/95929715dcc760da3d6627c206e677ab?.xml')
                }

                followNote;

                mustHit;
                line;
                time;
                length;

                mayHit = false;
                hasMissed = false;
                holding = false;

                x = 0;
                y = 0;

                tailNote;
                tailNoteEnd;

                constructor(scene, mustHit = false, note, line = 0, time = 0, length = 0)
                {
                    var frames = (PlayState.instance == null || !PlayState.instance.pixelUI) ? 'STRUMLINE_NOTETAILS' : 'STRUMLINE_PIXELNOTETAILS';
                    this.followNote = note;

                    this.mustHit = mustHit ?? false;
                    this.line = Math.floor(line % 4) ?? 0;
                    this.time = time ?? 0;
                    this.length = length ?? 0;

                    if (this.length > 0)
                    {
                        this.tailNote = new Phaser.GameObjects.Sprite(scene, -10000, -10000, frames);
                        this.tailNote.anims.create({key: 'scroll0', frameRate: 24, frames: this.tailNote.anims.generateFrameNames(frames, {prefix: 'purple hold piece', end: 0, zeroPad: 4})});
                        this.tailNote.anims.create({key: 'scroll1', frameRate: 24, frames: this.tailNote.anims.generateFrameNames(frames, {prefix: 'blue hold piece', end: 0, zeroPad: 4})});
                        this.tailNote.anims.create({key: 'scroll2', frameRate: 24, frames: this.tailNote.anims.generateFrameNames(frames, {prefix: 'green hold piece', end: 0, zeroPad: 4})});
                        this.tailNote.anims.create({key: 'scroll3', frameRate: 24, frames: this.tailNote.anims.generateFrameNames(frames, {prefix: 'red hold piece', end: 0, zeroPad: 4})});
                        this.tailNote.anims.play('scroll' + this.line);
                    }

                    this.tailNoteEnd = new Phaser.GameObjects.Sprite(scene, -10000, -10000, frames);
                    this.tailNoteEnd.anims.create({key: 'scroll0', frameRate: 24, frames: this.tailNoteEnd.anims.generateFrameNames(frames, {prefix: 'purple hold end', end: 0, zeroPad: 4})});
                    this.tailNoteEnd.anims.create({key: 'scroll1', frameRate: 24, frames: this.tailNoteEnd.anims.generateFrameNames(frames, {prefix: 'blue hold end', end: 0, zeroPad: 4})});
                    this.tailNoteEnd.anims.create({key: 'scroll2', frameRate: 24, frames: this.tailNoteEnd.anims.generateFrameNames(frames, {prefix: 'green hold end', end: 0, zeroPad: 4})});
                    this.tailNoteEnd.anims.create({key: 'scroll3', frameRate: 24, frames: this.tailNoteEnd.anims.generateFrameNames(frames, {prefix: 'red hold end', end: 0, zeroPad: 4})});
                    this.tailNoteEnd.anims.play('scroll' + this.line);
                }

                setScale(x, y)
                {
                    if (this.tailNote != null)
                    {
                        this.tailNote.scaleX = x;
                        this.tailNote.scaleY = y;
                    }

                    if (this.tailNoteEnd != null)
                    {
                        this.tailNoteEnd.scaleX = x;
                        this.tailNoteEnd.scaleY = y;
                    }
                }

                draw(scene)
                {
                    if (this.tailNote != null) scene.add.existing(this.tailNote);
                    if (this.tailNoteEnd != null) scene.add.existing(this.tailNoteEnd);
                }

                addToCameras(scene, cameras = [])
                {
                    if (this.tailNote != null) scene.addToCameras(this.tailNote, cameras);
                    if (this.tailNoteEnd != null) scene.addToCameras(this.tailNoteEnd, cameras);
                }

                setX(val)
                {
                    if (this.tailNote != null) this.tailNote.x = val;
                    if (this.tailNoteEnd != null) this.tailNoteEnd.x = val;
                    this.x = val;
                }

                setY(val)
                {
                    var followY = val;

                    if (this.tailNote != null)
                    {
                        this.tailNote.y = followY;
                        followY += (this.tailNote.displayHeight / 2) * (Constants.DOWN_SCROLL ? -1 : 1);
                    }

                    if (this.tailNoteEnd != null) this.tailNoteEnd.y = followY;

                    this.y = val;
                }

                setPosition(x, y)
                {
                    this.setX(x);
                    this.setY(y);
                }

                kill()
                {
                    if (this.tailNote != null)
                    {
                        this.tailNote.visible = false;
                        this.tailNote.destroy();
                    }

                    if (this.tailNoteEnd != null)
                    {
                        this.tailNoteEnd.visible = false;
                        this.tailNoteEnd.destroy();
                    }
                }
            }

            class TailNoteHoldSplash extends Phaser.GameObjects.Sprite
            {
                static precache(scene)
                {
                    // i have to do some custom exporting cos of the rotated frames unless i can find a way to read the xmls
                    scene.load.atlasXML('NOTETAILS_SPLASH_PURPLE', 'https://codehs.com/uploads/4600ed89a44e23d4df95bb165d8d0cca?.png', 'https://codehs.com/uploads/c92b9a359f6439f75c9e16c56c23a718?.xml');
                    scene.load.atlasXML('NOTETAILS_SPLASH_BLUE', 'https://codehs.com/uploads/687e7c3bfefc3a6207aac5a6ce4dd8f7?.png', 'https://codehs.com/uploads/998b79601734607129bfd3e9a8324f3a?.xml');
                    scene.load.atlasXML('NOTETAILS_SPLASH_GREEN', 'https://codehs.com/uploads/f2133280b90fec4f93df8f5595a546c5?.png', 'https://codehs.com/uploads/82c616ba2bad306910c4ec3820d0aac3?.xml');
                    scene.load.atlasXML('NOTETAILS_SPLASH_RED', 'https://codehs.com/uploads/befa948ff0b320b63c22b68d83d7c3be?.png', 'https://codehs.com/uploads/d06e61a6041d1b3f96fadaeadb335cc1?.xml'); 
                }

                line;

                baseX = 0;
                baseY = 0;

                constructor(scene, line = 0, x = 0, y = 0)
                {
                    var colors = ['Purple', 'Blue', 'Green', 'Red'];
                    var color = (colors[Math.floor(line % Strumline.KEY_COUNT) ?? 0] ?? 'Purple');
                    var tex = 'NOTETAILS_SPLASH_' + color.toUpperCase();

                    super(scene, x, y, tex);
                    this.setOrigin(0, 0);

                    this.anims.create({key: 'hold', frameRate: 24, repeat: -1, frames: this.anims.generateFrameNames(tex, {prefix: 'holdCover' + color, start: 1, end: 4, zeroPad: 4})});
                    this.anims.create({key: 'splash', frameRate: 24, frames: this.anims.generateFrameNames(tex, {prefix: 'holdCoverEnd' + color, start: 1, end: 8, zeroPad: 4})});
                    this.playAnim('hold');

                    this.x -= this.width / 1.35;
                    this.y -= this.height / 2;
                
                    this.baseX = this.x;
                    this.baseY = this.y;
                }

                playAnim(name)
                {
                    if (!this.anims.exists(name))
                        return;

                    this.anims.play(name);

                    if (name == 'splash') this.anims.hideOnComplete = true;
                    else this.anims.hideOnComplete = false;
                }

                update()
                {
                    if (this.displayHeight > this.displayWidth)
                    {
                        this.angle = 90;
                        this.x = this.baseX + 330;
                        this.y = this.baseY + 10;
                    }
                    else
                    {
                        this.angle = 0;
                        this.x = this.baseX;
                        this.y = this.baseY;
                    }
                }

                kill()
                {
                    this.visible = false;
                    this.destroy();
                }
            }

            class ChartType
            {
                static VANILLA = 'CHART_VANILLA';
                static LEGACY = 'CHART_LEGACY';
            }

            class Chart
            {
                static precache(scene)
                {
                    for (var chart of ChartRegistry.charts)
                    {
                        if (chart.name != null && chart.name.length > 0)
                        {
                            if (PlayState.playlist == null || PlayState.playlist.songs[0].name == chart.name)
                            {
                                if (chart.data != null && chart.data.length > 0)
                                    scene.load.json(chart.name + '-chart', chart.data + '?.json');
                                if (chart.metadata != null && chart.metadata.length > 0)
                                    scene.load.json(chart.name + '-metadata', chart.metadata + '?.json');
                            }
                        }
                    }
                }

                songName;
                data;
                metadata;
                chartType;
                difficulty;

                constructor(scene, name, difficulty = Constants.DEFAULT_DIFFICULTY)
                {
                    var chart = null;
                    for (var daChart of ChartRegistry.charts)
                    if (daChart.name == name)
                        chart = daChart;

                    if (chart == null) return;

                    this.songName = chart.name ?? '';
                    this.chartType = chart.type ?? ChartType.VANILLA;
                    this.difficulty = difficulty ?? Constants.DEFAULT_DIFFICULTY;
                    if (this.songName == null || this.songName.length <= 0) return;

                    this.data = scene.cache.json.get(this.songName + '-chart');
                    if (this.chartType == ChartType.LEGACY) this.data = this.data.song;
                    else
                        this.metadata = scene.cache.json.get(this.songName + '-metadata');
                }

                getName()
                {
                    var name = '';
                    if (this.chartType == ChartType.LEGACY) name = this.data.song ?? '';
                    else if (this.chartType == ChartType.VANILLA) name = this.metadata.songName ?? '';

                    return name;
                }

                getArtist()
                {
                    var name = '';
                    if (this.chartType == ChartType.LEGACY) name = '';
                    else if (this.chartType == ChartType.VANILLA) name = this.metadata.artist ?? '';

                    return name;
                }

                getCharter()
                {
                    var name = '';
                    if (this.chartType == ChartType.LEGACY) name = '';
                    else if (this.chartType == ChartType.VANILLA) name = this.metadata.charter ?? '';

                    return name;
                }

                getNotes(difficulty = this.difficulty)
                {
                    difficulty = difficulty ?? this.difficulty;

                    if (this.data == null) return [];
                    else if (this.chartType == ChartType.LEGACY) return this.data.notes ?? [];

                    switch (difficulty)
                    {
                        case 'easy': return this.data.notes.easy ?? [];
                        case 'normal': return this.data.notes.normal ?? [];
                        case 'hard': return this.data.notes.hard ?? [];
                        case 'erect': return this.data.notes.erect ?? [];
                        case 'nightmare': return this.data.notes.nightmare ?? [];
                        case 'picospeaker': return this.data.notes.picospeaker ?? [];
                        default: return [];
                    }
                }

                getScrollSpeed()
                {
                    if (this.data == null) return 1;
                    else if (this.chartType == ChartType.LEGACY) return this.data.speed ?? 1;

                    switch (this.difficulty)
                    {
                        case 'easy': return this.data.scrollSpeed.easy ?? 1;
                        case 'normal': return this.data.scrollSpeed.normal ?? 1;
                        case 'hard': return this.data.scrollSpeed.hard ?? 1;
                        case 'erect': return this.data.scrollSpeed.erect ?? 1;
                        case 'nightmare': return this.data.scrollSpeed.nightmare ?? 1;
                        default: return 1;
                    }
                }

                getDifficulties(chart)
                {
                    /*
                    if (chart.chartType == ChartType.VANILLA)
                    {
                        if (chart.metadata != null)
                        {

                        }
                    }
                    */

                    //return Constants.DEFAULT_DIFFICULTY_LIST;
                }

                getStage()
                {
                    if (this.data == null) return '';
                    else if (this.chartType == ChartType.LEGACY) return this.data.stage ?? '';
                    else if (this.chartType == ChartType.VANILLA) return this.metadata.playData.stage ?? '';
                    else return '';
                }
            }

            class VocalType // needed to determine what de opponent does
            {
                static PLAYER_OPPONENT = 'VOCAL_PLAYER_OPPONENT'; // Two vocal tracks, one for player, one for opponent
                static PLAYER = 'VOCAL_PLAYER';
                static OPPONENT = 'VOCAL_OPPONENT';
                static LEGACY = 'VOCAL_LEGACY'; // Only one vocal track
                static NONE = 'VOCAL_NONE';
            }

            class Song
            {
                static precache(scene)
                {
                    for (var song of SongRegistry.songs)
                    {
                        if (song.name != null && song.name.length > 0)
                        {
                            if (PlayState.playlist == null || PlayState.playlist.songs[0].name == song.name)
                            {
                                if (song.inst != null && song.inst.length > 0)
                                    scene.load.audio(song.name + '-instrumental', song.inst + '?.ogg');
                                if (song.vocals != null && song.vocals.length > 0)
                                    scene.load.audio(song.name + '-vocals', song.vocals + '?.ogg');
                                if (song.vocalsOpponent != null && song.vocalsOpponent.length > 0)
                                    scene.load.audio(song.name + '-opponentvocals', song.vocalsOpponent + '?.ogg');
                            }
                        }
                    }
                }

                songName;
                vocalType;

                paused = false;

                inst;
                vocals;
                opponentVocals;

                constructor(scene, songName)
                {
                    var song = null;
                    for (var daSong of SongRegistry.songs)
                        if (daSong.name == songName)
                            song = daSong;

                    if (song == null) return;

                    this.songName = song.name ?? '';
                    this.vocalType = song.type ?? VocalType.PLAYER_OPPONENT;

                    this.inst = new Phaser.Sound.WebAudioSound(scene.sound, songName + '-instrumental', {volume: 1, loop: false});

                    var hasVocals = false;
                    var hasOppVocals = false;

                    switch (this.vocalType)
                    {
                        case VocalType.PLAYER_OPPONENT:
                            hasVocals = true;
                            hasOppVocals = true;
                            break;

                        case VocalType.PLAYER:
                            hasVocals = true;
                            hasOppVocals = false;
                            break;

                        case VocalType.OPPONENT:
                            hasVocals = false;
                            hasOppVocals = true;
                            break;

                        case VocalType.NONE:
                            hasVocals = false;
                            hasOppVocals = false;
                            break;

                        default:
                            hasVocals = true;
                            hasOppVocals = true;
                            break;
                    }

                    if (hasVocals) this.vocals = new Phaser.Sound.WebAudioSound(scene.sound, songName + '-vocals', {volume: 1, loop: false});
                    if (hasOppVocals) this.opponentVocals = new Phaser.Sound.WebAudioSound(scene.sound, songName + '-opponentvocals', {volume: 1, loop: false});
                }

                play()
                {
                    this.paused = false;
                    if (this.inst != null) this.inst.play();
                    if (this.vocals != null) this.vocals.play();
                    if (this.opponentVocals != null) this.opponentVocals.play();
                }

                stop()
                {
                    if (this.inst != null) this.inst.stop();
                    if (this.vocals != null) this.vocals.stop();
                    if (this.opponentVocals != null) this.opponentVocals.stop();
                }

                pause()
                {
                    this.paused = true;
                    if (this.inst != null) this.inst.pause();
                    if (this.vocals != null) this.vocals.pause();
                    if (this.opponentVocals != null) this.opponentVocals.pause();
                }

                resume()
                {
                    this.paused = false;
                    if (this.inst != null) this.inst.resume();
                    if (this.vocals != null) this.vocals.resume();
                    if (this.opponentVocals != null) this.opponentVocals.resume();
                }

                onOpponentHit()
                {
                    if (this.vocalType == VocalType.PLAYER_OPPONENT || this.vocalType == VocalType.OPPONENT)
                    {
                        if (this.opponentVocals != null)
                            this.opponentVocals.volume = 1;
                    }
                    else if (this.vocalType == VocalType.LEGACY)
                    {
                        if (this.vocals != null)
                            this.vocals.volume = 1;
                    }
                }

                onOpponentMiss()
                {
                    if (this.vocalType == VocalType.PLAYER_OPPONENT || this.vocalType == VocalType.OPPONENT)
                    {
                        if (this.opponentVocals != null)
                            this.opponentVocals.volume = 0;
                    }
                    else if (this.vocalType == VocalType.LEGACY)
                    {
                        if (this.vocals != null)
                            this.vocals.volume = 0;
                    }
                }

                onPlayerHit()
                {
                    if (this.vocalType != VocalType.OPPONENT && this.vocalType != VocalType.NONE)
                        if (this.vocals != null)
                            this.vocals.volume = 1;
                }

                onPlayerMiss()
                {
                    if (this.vocalType != VocalType.OPPONENT && this.vocalType != VocalType.NONE)
                        if (this.vocals != null)
                            this.vocals.volume = 0;
                }

                hasEnded()
                {
                    return (this.inst != null ? (this.inst.getCurrentTime() >= this.inst.duration) : false);
                }

                getTime()
                {
                    return (this.inst != null ? this.inst.getCurrentTime() : 0);
                }
            }

            class BaseStage
            {
                static precache(scene) {}

                manager;

                constructor(mng) { this.manager = mng; }

                onCreate()                     {} // Before any characters are added.
                onCreateGF()                   {} // After GF has been added.
                onCreateDad()                  {} // After GF and Dad have been added.
                onCreateBF()                   {} // After GF, Dad, and BF have been added.
                onCreatePost()                 {} // After everything has been added.

                onUpdate(elapsed)              {} // Called every frame

                // Self Explanatory
                onStepHit(step)                {}
                onBeatHit(beat)                {}
                onSectionHit(section)          {}
            }

            class MainStage extends BaseStage
            {
                static precache(scene)
                {
                    scene.load.image('stageback', "https://codehs.com/uploads/eceae724685993674c7063d14ca50365");
                    scene.load.image('stagefront', "https://codehs.com/uploads/84fc06befc0240491b22b2abb7f65ff5");
                    scene.load.image('stagecurtains', "https://codehs.com/uploads/8690b221171b39a164774c6c87600bf2");
                }

                stageBack;
                stageFront;
                stageCurtains;

                onCreate()
                {
                    this.manager.zoom = 0.9;

                    this.stageBack = this.manager.scene.createImage('stageback', -600, -200);
                    this.stageBack.scrollFactorX = this.stageBack.scrollFactorY = 0.9;
                    this.manager.add(this.stageBack);

                    this.stageFront = this.manager.scene.createImage('stagefront', -650, 600);
                    this.stageFront.scrollFactorX = this.stageFront.scrollFactorY = 0.9;
                    this.stageFront.active = false;
                    this.stageFront.scaleX = this.stageFront.scaleY = 1.1;
                    this.manager.add(this.stageFront);

                    this.stageCurtains = this.manager.scene.createImage('stagecurtains', -500, -300);
                    this.stageCurtains.scrollFactorX = this.stageCurtains.scrollFactorY = 1.3;
                    this.stageCurtains.active = false;
                    this.stageCurtains.scaleX = this.stageCurtains.scaleY = 0.9;
                    this.manager.add(this.stageCurtains);
                }
            }

            class SpookyMansion extends BaseStage
            {
                static precache(scene)
                {
                    scene.load.atlasXML('halloween_bg', 'https://codehs.com/uploads/356540ef74f029f813dbfb229382197d', 'https://codehs.com/uploads/61cdd72145af4f39a8701463f717da7b');
                    scene.load.audio('thunder_1', ['https://codehs.com/uploads/35a36f28d4d3712bdf2aa6d256c12d71?.ogg']);
                    scene.load.audio('thunder_2', ['https://codehs.com/uploads/7cc9e208f0c3ccef8e855ac94831bdfc?.ogg']);
                }

                halloweenBG;
                lightningStrikeBeat = 0;
                lightningOffset = 8;

                onCreate()
                {
                    var tex = 'halloween_bg';
                    this.halloweenBG = this.manager.scene.createSprite(tex, -200, -100);
                    this.halloweenBG.anims.create({key: 'idle', frameRate: 24, repeat: -1, frames: this.halloweenBG.anims.generateFrameNames(tex, {prefix: 'halloweem bg', end: 0, zeroPad: 4})});
                    this.halloweenBG.anims.create({key: 'lightning', frameRate: 24, frames: this.halloweenBG.anims.generateFrameNames(tex, {prefix: 'halloweem bg lightning strike', end: 29, zeroPad: 4})});
                    this.halloweenBG.anims.play('idle');
                    this.manager.add(this.halloweenBG);
                }

                onBeatHit(beat)
                {
                    if ((Math.random() * 100) < 10)
                        if (beat > this.lightningStrikeBeat + this.lightningOffset)
                            this.lightningStrikeShit(beat);
                }

                lightningStrikeShit(beat)
                {
                    this.manager.scene.sound.add('thunder_' + Math.floor(Math.random() * (2 - 1) + 1), {volume: 1, loop: false}).play();
                    this.halloweenBG.anims.play('lightning');

                    this.lightningStrikeBeat = beat;
                    this.lightningOffset = Math.floor(Math.random() * (24 - 8) + 8);

                    if (this.manager.scene.player != null)
                    {
                        this.manager.scene.player.playAnim('scared');
                        this.manager.scene.player.specialAnim = true;
                    }
                    
                    if (this.manager.scene.girlfriend != null)
                    {
                        this.manager.scene.girlfriend.playAnim('scared');
                        this.manager.scene.girlfriend.specialAnim = true;
                    }
                }
            }

            class PhillyTrain extends BaseStage
            {
                static precache(scene)
                {
                    scene.load.image('phillySky', 'https://codehs.com/uploads/f299a828fdf7b06db13d1507f9b3b3a7');
                    scene.load.image('phillyCity', 'https://codehs.com/uploads/99edbad4156d71f19796b44f7e99c214');
                    scene.load.image('phillyWin0', 'https://codehs.com/uploads/8e4044ff3d44ae67ed977c2480789a9d');
                    scene.load.image('phillyWin1', 'https://codehs.com/uploads/998a75d50908e1b2f542fca3cb46805b');
                    scene.load.image('phillyWin2', 'https://codehs.com/uploads/2c1e0ab50149a88fcd1e16004c3ba508');
                    scene.load.image('phillyWin3', 'https://codehs.com/uploads/c80c0b992329d97fae1aca89cf528d91');
                    scene.load.image('phillyWin4', 'https://codehs.com/uploads/b78548538b6b4f015c4087e74c8b48b0');
                    scene.load.image('phillyBehindTrain', 'https://codehs.com/uploads/26dccf264eb6d7dba24d77ebfc11a430');
                    scene.load.image('phillyTrain', 'https://codehs.com/uploads/6a157ecbaea6aa4607cc4a675ff658bc');
                    scene.load.image('phillyStreet', 'https://codehs.com/uploads/3bec5c2ae6b49e6a5ae7fee4e5113aeb');

                    scene.load.audio('train_passes', ['https://codehs.com/uploads/2be3218e8965dc664b0312d8f6caab7c?.ogg']);
                }

                sky;
                city;
                cityLights = [];
                trainBehind;
                train;
                street;

                onCreate()
                {
                    this.sky = this.manager.scene.createImage('phillySky', -100, 0);
                    this.sky.scrollFactorX = this.sky.scrollFactorY = 0.1;
                    this.manager.add(this.sky);

                    this.city = this.manager.scene.createImage('phillyCity', -10, 0);
                    this.city.scrollFactorX = this.city.scrollFactorY = 0.3;
                    this.city.scaleX = this.city.scaleY = 0.85;
                    this.manager.add(this.city);

                    for (var i=0; i<5; i++)
                    {
                        var light = this.manager.scene.createImage('phillyWin' + i, this.city.x, this.city.y);
                        light.scrollFactorX = light.scrollFactorY = this.city.scrollFactorX;
                        light.scaleX = light.scaleY = this.city.scaleX;
                        light.alpha = 0;
                        this.cityLights.push(light);
                        this.manager.add(light);
                    }

                    this.trainBehind = this.manager.scene.createImage('phillyBehindTrain', -40, 50);
                    this.manager.add(this.trainBehind);

                    this.train = this.manager.scene.createImage('phillyTrain', 2000, 360);
                    this.manager.add(this.train);

                    this.trainSound = this.manager.scene.sound.add('train_passes', {volume: 1, loop: false});
                    this.manager.soundPool.push(this.trainSound);

                    this.street = this.manager.scene.createImage('phillyStreet', this.trainBehind.x, this.trainBehind.y);
                    this.manager.add(this.street);

                    this.manager.scene.opponentPos[0] += 100;
                    this.manager.scene.playerPos[0] += 100;
                }

                curLight = -1;

                trainSound;
                trainMoving = false;
                trainFrameTiming = 0;
                trainCars = 8;
                trainFinishing = false;
                trainCooldown = 0;
                startedMoving = false;

                onBeatHit(beat)
                {
                    if (!this.trainMoving)
                        this.trainCooldown += 1;

                    if (beat % 4 == 0)
                    {
                        for (var light of this.cityLights)
                            light.alpha = 0;

                        this.curLight = Math.floor(Math.random() * (this.cityLights.length - 1));
                        this.cityLights[this.curLight].alpha = 1;
                    }

                    if (beat % 8 == 4 && (Math.random() * 100) < 30 && !this.trainMoving && this.trainCooldown > 8)
                    {
                        this.trainCooldown = Math.floor(Math.random() * (-4 - 0) + 0);
                        this.trainStart();
                    }
                }

                onUpdate(elapsed)
                {
                    if (this.trainMoving)
                    {
                        this.trainFrameTiming += elapsed;

                        if (this.trainFrameTiming >= 1 / 24)
                        {
                            this.updateTrainPos();
                            this.trainFrameTiming = 0;
                        }
                    }

                    if (this.cityLights[this.curLight] != null)
                        this.cityLights[this.curLight].alpha -= (((Conductor.instance.getBeatLengthMs() ?? 0) / 1000) * elapsed * 1.5);
                }

                trainStart()
                {
                    this.trainMoving = true;
                    this.trainSound.play();
                }

                updateTrainPos()
                {
                    if (this.trainSound.getCurrentTime() * 1000 >= 4700)
                    {
                        this.startedMoving = true;

                        if (this.manager.scene.girlfriend != null && this.manager.scene.girlfriend.anims.getName() != 'hairBlow')
                        {
                            this.manager.scene.girlfriend.playAnim('hairBlow');
                            this.manager.scene.girlfriend.specialAnim = true;
                        }
                    }

                    if (this.startedMoving)
                    {
                        this.train.x -= 400;

                        if (this.train.x < -2000 && !this.trainFinishing)
                        {
                            this.train.x = -1150;
                            this.trainCars -= 1;

                            if (this.trainCars <= 0)
                                this.trainFinishing = true;
                        }

                        if (this.train.x < -4000 && this.trainFinishing)
                            this.trainReset();
                    }
                }

                trainReset()
                {
                    if (this.manager.scene.girlfriend != null)
                    {
                        this.manager.scene.girlfriend.playAnim('hairFall');
                        this.manager.scene.girlfriend.specialAnim = true;
                    }

                    this.train.x = 1280 + 200;
                    this.trainMoving = false;
                    this.trainCars = 8;
                    this.trainFinishing = false;
                    this.startedMoving = false;
                }
            }

            class LimoRide extends BaseStage
            {
                static DANCER_COUNT = 5;

                static precache(scene)
                {
                    scene.load.image('limoSunset', 'https://codehs.com/uploads/82a666e5cd701c58df0429576935bfe1?.png');
                    scene.load.atlasXML('limoBG', 'https://codehs.com/uploads/4e845e1089f616f7be3aab468e527186?.png', 'https://codehs.com/uploads/a82e5422a6e5a104f6a067d8de518acd?.xml');
                    scene.load.atlasXML('limoDancer', 'https://codehs.com/uploads/95854723bc852417b3c076e52882e36c?.png', 'https://codehs.com/uploads/f7eba59e3845f6b3ef23ffcca2f4bfdb?.xml');
                    scene.load.atlasXML('limoDrive', 'https://codehs.com/uploads/0ecd67b3a755e26acf072867dae764bc?.png', 'https://codehs.com/uploads/c8a04bc6c64092704381042d566405df?.xml');
                    scene.load.image('limoFastCar', 'https://codehs.com/uploads/89611d761f2ce39140312457f531386f?.png');

                    scene.load.audio('limoCarPassing0', ['https://codehs.com/uploads/c096fd09ffc440d0dbf354882819d6b0?.ogg']);
                    scene.load.audio('limoCarPassing1', ['https://codehs.com/uploads/e5ff185bbe8f61517ff553fca6a7e149?.ogg']);
                }

                sunset;
                limoBG;
                limoDancers = [];
                fastCar;
                limoDrive;

                onCreate()
                {
                    this.manager.zoom = 0.9;

                    this.sunset = this.manager.scene.createImage('limoSunset', -120, -50);
                    this.sunset.scrollFactorX = this.sunset.scrollFactorY = 0.1;
                    this.manager.add(this.sunset);

                    var frames = 'limoBG';
                    this.limoBG = this.manager.scene.createSprite(frames, -200, 480);
                    this.limoBG.scrollFactorX = this.limoBG.scrollFactorY = 0.4;
                    this.limoBG.anims.create({key: 'drive', repeat: -1, frameRate: 24, frames: this.limoBG.anims.generateFrameNames(frames, {prefix: 'background limo pink', end: 3, zeroPad: 4})});
                    this.limoBG.anims.play('drive');
                    this.manager.add(this.limoBG);

                    for (var i=0; i<LimoRide.DANCER_COUNT; i++)
                    {
                        var frames = 'limoDancer';
                        var dancer = this.manager.scene.createSprite(frames, (370 * i) + 130, this.limoBG.y - 400);
                        dancer.scrollFactorX = dancer.scrollFactorY = 0.4;
                        dancer.anims.create({key: 'danceLeft', frameRate: 24, frames: dancer.anims.generateFrameNames('limoDancer', {prefix: 'bg dancer sketch PINK', end: 14, zeroPad: 4})});
                        dancer.anims.create({key: 'danceRight', frameRate: 24, frames: dancer.anims.generateFrameNames('limoDancer', {prefix: 'bg dancer sketch PINK', start: 15, end: 29, zeroPad: 4})});
                        dancer.anims.play('danceLeft');

                        this.limoDancers.push(dancer);
                        this.manager.add(dancer);
                    }

                    this.fastCar = this.manager.scene.createPhysicsImage('limoFastCar', -300, 160);
                    this.manager.scene.addToCameras(this.fastCar, [this.manager.scene.cameras.main]);

                    this.resetFastCar();

                    this.manager.scene.playerPos[0] += 300;
                    this.manager.scene.playerPos[1] -= 245;
                }

                onCreateGF()
                {
                    var frames = 'limoDrive';
                    this.limoDrive = this.manager.scene.createSprite(frames, -120, 550);
                    this.limoDrive.anims.create({key: 'drive', frameRate: 24, repeat: -1, frames: this.limoDrive.anims.generateFrameNames(frames, {prefix: 'Limo stage', end: 3, zeroPad: 4})})
                    this.limoDrive.anims.play('drive');
                    this.manager.add(this.limoDrive);
                }

                danceLeft = true;

                onBeatHit(beat)
                {
                    this.danceLeft = !this.danceLeft;

                    for (var dancer of this.limoDancers)
                        if (dancer != null)
                            dancer.anims.play(this.danceLeft ? 'danceLeft' : 'danceRight');

                    if ((Math.random() * 100) < 10 && this.fastCarCanDrive)
                        this.fastCarDrive();
                }

                fastCarCanDrive = false;
                fastCarTimer = 0;

                resetFastCar()
                {
                    if (this.fastCar != null)
                    {
                        this.fastCar.x = -12600;
                        this.fastCar.y = Math.floor(Math.random() * (250 - 140) + 140);
                        this.fastCar.setVelocityX(0);

                        this.fastCarCanDrive = true;
                        this.fastCarTimer = 0;
                    }
                }

                fastCarDrive()
                {
                    var carSound = this.manager.scene.sound.add('limoCarPassing' + Math.floor(Math.random() * 1), {volume: 0.7, loop: false});
                    carSound.play();
                    this.manager.soundPool.push(carSound);

                    this.fastCar.setVelocityX((Math.floor(Math.random() * (220 - 170) + 170) / this.manager.scene.elapsed) * 3);
                    this.fastCarCanDrive = false;
                }

                onUpdate(elapsed)
                {
                    if (!this.fastCarCanDrive && this.fastCar != null)
                    {
                        this.fastCarTimer += elapsed;
                        if (this.fastCarTimer >= 2)
                            this.resetFastCar();
                    }
                }
            }

            class MallXmas extends BaseStage
            {
                static precache(scene)
                {
                    scene.load.image('christmasBgWalls', 'https://codehs.com/uploads/5634743be93b454cc0ac4c14f67a828d');
                    scene.load.atlasXML('christmasUpperBop', 'https://codehs.com/uploads/8407e0b1db50da39a98fb3009e714e20', 'https://codehs.com/uploads/d93fc99ae61e0bf17afc0873be71822b');
                    scene.load.image('christmasBgEscalator', 'https://codehs.com/uploads/d2a3fc53e05bdc870b22dff9b1afd31b');
                    scene.load.image('christmasTree', 'https://codehs.com/uploads/eb1c7b9c591f1f104a635f6f57bbc0b9');
                    scene.load.atlasXML('christmasBottomBop', 'https://codehs.com/uploads/ba3aa7fda1ab933c27676da7d5e1f4ae', 'https://codehs.com/uploads/d91c86379763177e200a3c7c55239fd4');
                    scene.load.image('christmasFgSnow', 'https://codehs.com/uploads/087ebdc890f8c87a6370c4a397eac3cb');
                    scene.load.atlasXML('christmasSanta', 'https://codehs.com/uploads/1afd6eaefdd61ba02f09cbafbdd207cd', 'https://codehs.com/uploads/226a2e401ac5d3446f2d0ba922021260');
                }

                bg;
                upperBoppers;
                escalator;
                tree;
                bottomBoppers;
                snow;
                santa;

                onCreate()
                {
                    this.manager.zoom = 0.8;

                    this.bg = this.manager.scene.createImage('christmasBgWalls', -1000, -500);
                    this.bg.scrollFactorX = this.bg.scrollFactorY = 0.2;
                    this.bg.scaleX = this.bg.scaleY = 0.8;
                    this.manager.add(this.bg);

                    var frames = 'christmasUpperBop';
                    this.upperBoppers = this.manager.scene.createSprite(frames, -240, -90);
                    this.upperBoppers.scrollFactorX = this.upperBoppers.scrollFactorY = 0.33;
                    this.upperBoppers.scaleX = this.upperBoppers.scaleY = 0.85;
                    this.upperBoppers.anims.create({key: 'bop', frameRate: 24, frames: this.upperBoppers.anims.generateFrameNames(frames, {prefix: 'Upper Crowd Bob', end: 12, zeroPad: 4})})
                    this.upperBoppers.anims.play('bop');
                    this.manager.add(this.upperBoppers);
                    
                    this.escalator = this.manager.scene.createImage('christmasBgEscalator', -1100, -600);
                    this.escalator.scrollFactorX = this.escalator.scrollFactorY = 0.3;
                    this.escalator.active = false;
                    this.escalator.scaleX = this.escalator.scaleY = 0.9;
                    this.manager.add(this.escalator);

                    this.tree = this.manager.scene.createImage('christmasTree', 370, -250);
                    this.tree.scrollFactorX = this.tree.scrollFactorY = 0.4;
                    this.manager.add(this.tree);

                    var frames = 'christmasBottomBop';
                    this.bottomBoppers = this.manager.scene.createSprite(frames, -300, 140);
                    this.bottomBoppers.scrollFactorX = this.bottomBoppers.scrollFactorY = 0.9;
                    this.bottomBoppers.anims.create({key: 'bop', frameRate: 24, frames: this.bottomBoppers.anims.generateFrameNames(frames, {prefix: 'Bottom Level Boppers', end: 13, zeroPad: 4})})
                    this.bottomBoppers.anims.play('bop');
                    this.manager.add(this.bottomBoppers);

                    this.snow = this.manager.scene.createImage('christmasFgSnow', -600, 700);
                    this.snow.active = false;
                    this.manager.add(this.snow);

                    var frames = 'christmasSanta';
                    this.santa = this.manager.scene.createSprite(frames, -840, 150);
                    this.santa.anims.create({key: 'idle', frameRate: 24, frames: this.santa.anims.generateFrameNames(frames, {prefix: 'santa idle in fear', end: 13, zeroPad: 4})})
                    this.santa.anims.play('idle');
                    this.manager.add(this.santa);

                    this.manager.scene.opponentPos[0] -= 200;
                    this.manager.scene.playerPos[0] += 400;
                }

                onCreatePost()
                {
                    if (this.manager.scene.player != null)
                    {
                        this.manager.scene.player.camFollow[0] -= 100;
                        this.manager.scene.player.camFollow[1] -= 100;
                    }
                }

                onBeatHit()
                {
                    this.upperBoppers.anims.play('bop');
                    this.bottomBoppers.anims.play('bop');
                    this.santa.anims.play('idle');
                }
            }

            class MallEvil extends BaseStage
            {
                static precache(scene)
                {
                    scene.load.image('christmasEvilBG', 'https://codehs.com/uploads/9f6810a7001d422927f2ef5c85fd121c');
                    scene.load.image('christmasEvilTree', 'https://codehs.com/uploads/dc7f5ba0a3817b43cd2945fb42255865');
                    scene.load.image('christmasEvilSnow', 'https://codehs.com/uploads/5c4e74fdecb54bc9fb4ee34cbb13ef58');
                }

                bg;
                tree;
                snow;

                onCreate()
                {
                    this.bg = this.manager.scene.createImage('christmasEvilBG', -400, -500);
                    this.bg.scrollFactorX = this.bg.scrollFactorY = 0.2;
                    this.bg.scaleX = this.bg.scaleY = 0.8;
                    this.manager.add(this.bg);

                    this.tree = this.manager.scene.createImage('christmasEvilTree', 300, -300);
                    this.tree.scrollFactorX = this.tree.scrollFactorY = 0.2;
                    this.manager.add(this.tree);

                    this.snow = this.manager.scene.createImage('christmasEvilSnow', -200, 700);
                    this.snow.active = false;
                    this.manager.add(this.snow);

                    this.manager.scene.playerPos[0] += 100;
                }
            }

            class School extends BaseStage
            {
                static precache(scene)
                {
                    scene.load.image('weebSky', 'https://codehs.com/uploads/accf526b77908ade7a56ba934fdeeeef');
                    scene.load.image('weebSchool', 'https://codehs.com/uploads/789fc8ca74bcf11974b85cac1583d692');
                    scene.load.image('weebStreet', 'https://codehs.com/uploads/0681025dc96e3a4371a7a68c990248e6');
                    scene.load.image('weebTreesBack', 'https://codehs.com/uploads/fa2f4164c25bd5384e24b772b814f962');

                    scene.load.atlasXML('weebTrees', 'https://codehs.com/uploads/4cd1ae13338c3922e0f93b2b31f7d39d', 'https://codehs.com/uploads/f8700d2968e6397fda758fb9a89b6931');
                    scene.load.atlasXML('weebPetals', 'https://codehs.com/uploads/dfea8a08a3734d7be4acda5fccc9ff18', 'https://codehs.com/uploads/603365091c3fecc68b0e880822574a7f');
                    scene.load.atlasXML('weebFreaks', 'https://codehs.com/uploads/12d64f22ef5c778433db52ecb76d64da', 'https://codehs.com/uploads/ee6b78ead106b9fbdcfb1324372ca935');
                }

                sky;
                school;
                street;
                treesBack;
                
                trees;
                petals;
                girls;

                altGirls = false;

                onCreate()
                {
                    if (PlayState.instance != null)
                    {
                        PlayState.instance.pixelUI = true;

                        if (PlayState.instance.chart != null)
                        {
                            if (PlayState.instance.chart.songName != null)
                                if (PlayState.instance.chart.songName.startsWith('roses'))
                                    this.altGirls = true;
                        }
                    }

                    this.sky = this.manager.scene.createImage('weebSky', -100, -100);
                    this.sky.scrollFactorX = this.sky.scrollFactorY = 0.1;
                    this.manager.add(this.sky);

                    this.school = this.manager.scene.createImage('weebSchool', -200, 0);
                    this.school.scrollFactorX = 0.6;
                    this.school.scrollFactorY = 0.9;
                    this.manager.add(this.school);

                    this.street = this.manager.scene.createImage('weebStreet', -200, 0);
                    this.street.scrollFactorX = this.street.scrollFactorY = 0.95;
                    this.manager.add(this.street);

                    this.treesBack = this.manager.scene.createImage('weebTreesBack', -30, 130);
                    this.treesBack.scrollFactorX = this.treesBack.scrollFactorY = 0.9;
                    this.treesBack.scaleX = this.treesBack.scaleY = (4.797 / 6);
                    this.manager.add(this.treesBack);

                    var frames = 'weebTrees';
                    this.trees = this.manager.scene.createSprite(frames, -580, -800);
                    this.trees.scrollFactorX = this.trees.scrollFactorY = 0.85;
                    this.trees.scaleX = this.trees.scaleY = (5.102 / 6);
                    this.trees.anims.create({key: 'idle', frameRate: 16, repeat: -1, frames: this.trees.anims.generateFrameNames(frames, {prefix: 'trees_', end: 18, zeroPad: 0})});
                    this.trees.anims.play('idle');
                    this.manager.add(this.trees);

                    var frames = 'weebPetals';
                    this.petals = this.manager.scene.createSprite(frames, -20, -40);
                    this.petals.scrollFactorX = this.petals.scrollFactorY = 0.85;
                    this.petals.anims.create({key: 'idle', frameRate: 24, repeat: -1, frames: this.petals.anims.generateFrameNames(frames, {prefix: 'PETALS ALL instance 1', end: 55, zeroPad: 4})});
                    this.petals.anims.play('idle');
                    this.manager.add(this.petals);

                    var frames = 'weebFreaks';
                    this.girls = this.manager.scene.createSprite(frames, -100, 190);
                    this.girls.scrollFactorX = this.girls.scrollFactorY = 0.9;
                    this.girls.anims.create({key: 'danceLeft', frameRate: 24, frames: this.girls.anims.generateFrameNames(frames, {prefix: 'BG girls group instance 1', end: 14, zeroPad: 4})});
                    this.girls.anims.create({key: 'danceRight', frameRate: 24, frames: this.girls.anims.generateFrameNames(frames, {prefix: 'BG girls group instance 1', start: 15, end: 29, zeroPad: 4})});
                    this.girls.anims.create({key: 'danceLeft-alt', frameRate: 24, frames: this.girls.anims.generateFrameNames(frames, {prefix: 'BG fangirls dissuaded instance 1', end: 14, zeroPad: 4})});
                    this.girls.anims.create({key: 'danceRight-alt', frameRate: 24, frames: this.girls.anims.generateFrameNames(frames, {prefix: 'BG fangirls dissuaded instance 1', start: 15, end: 29, zeroPad: 4})});
                    this.girls.anims.play('danceLeft');
                    this.manager.add(this.girls);
                }

                danceLeft = true;

                onBeatHit(beat)
                {
                    this.danceLeft = !this.danceLeft;
                    if (this.girls != null)
                        this.girls.anims.play((this.danceLeft ? 'danceLeft' : 'danceRight') + (this.altGirls ? '-alt' : ''));
                }
            }

            class SchoolEvil extends BaseStage
            {
                static precache(scene)
                {
                    scene.load.image('evilSchoolBG', 'https://codehs.com/uploads/90b9df5c74aae27b495ce343c2dc6675?.png');
                    scene.load.image('evilSchoolFG', 'https://codehs.com/uploads/34996279e726971da611f7738ed36285?.png');
                }

                bg;
                fg;

                onCreate()
                {
                    if (PlayState.instance != null)
                        PlayState.instance.pixelUI = true;

                    this.bg = this.manager.scene.createSprite('evilSchoolBG', -200, 0);
                    this.bg.scrollFactorX = 0.6;
                    this.bg.scrollFactorY = 0.9;
                    this.manager.add(this.bg);

                    this.fg = this.manager.scene.createSprite('evilSchoolFG', -200, 0);
                    this.fg.scrollFactorX = this.fg.scrollFactorY = 0.95;
                    this.manager.add(this.fg);
                }
            }

            class TankmanBattlefield extends BaseStage
            {
                static precache(scene)
                {
                    scene.load.image('tankSky', 'https://codehs.com/uploads/e680ae55e1148a11113fc902007b5bce');
                    scene.load.image('tankMountains', 'https://codehs.com/uploads/9e48c69a67416367f6c761b5bd3462bf');
                    scene.load.image('tankBuildings', 'https://codehs.com/uploads/d60810dda4f3bcb4e0fdf1254751455f');
                    scene.load.image('tankRuins', 'https://codehs.com/uploads/78d3c18daa2371a0a6a55da581269adb');
                    scene.load.image('tankClouds', 'https://codehs.com/uploads/d3d6dcef296be88f67805ea7bae49c29');
                    scene.load.atlasXML('tankSmokeLeft', 'https://codehs.com/uploads/83c38e8644b2f850e1f4d1a24b773a57', 'https://codehs.com/uploads/b4a90a10afd45d06347412a709ba0e0d');
                    scene.load.atlasXML('tankSmokeRight', 'https://codehs.com/uploads/2a022f3e3696a28022afedfb51f7175e', 'https://codehs.com/uploads/d604a3daa9b2dd0e7a1538f0c07abc36');
                    scene.load.atlasXML('tankWatchtower', 'https://codehs.com/uploads/fd3f7c031f112322be372ee2d1b7ec4c', 'https://codehs.com/uploads/bd99e72c43f8b7e898ccf25ea65ab6d3');
                    scene.load.atlasXML('tankRolling', 'https://codehs.com/uploads/3e2b6658ee334043406e4b5de1d10ec4', 'https://codehs.com/uploads/f312a9b74c0f69b3a0615a9108532722');
                    scene.load.image('tankGround', 'https://codehs.com/uploads/232d74520b5c2fd2868dd977874c4c4d');
                    scene.load.atlasXML('tankFG0', 'https://codehs.com/uploads/5932960c05db06da933db039138a818c', 'https://codehs.com/uploads/99d113887c0a4291195ffa39b2a1067d');
                    scene.load.atlasXML('tankFG1', 'https://codehs.com/uploads/c3d0969c49c09a07f3b52cb669309181', 'https://codehs.com/uploads/bafe2358772d63df6d083f382b5590f8');
                    scene.load.atlasXML('tankFG2', 'https://codehs.com/uploads/c570f90997e968a49f7c75013475f4cd', 'https://codehs.com/uploads/07c3a9c0ecd570376f1655ae7800ae0d');
                    scene.load.atlasXML('tankFG3', 'https://codehs.com/uploads/9a83ea3b7a2349b8ed1718642fdcf602', 'https://codehs.com/uploads/9e97b8a5f844f5dfba161d2e3c6b6349');
                    scene.load.atlasXML('tankFG4', 'https://codehs.com/uploads/8ceb81ee9e2d55d5a8f0a4124c2a7e8b', 'https://codehs.com/uploads/02d2b5063ea84fdcd0f1494b3337d101');
                    scene.load.atlasXML('tankFG5', 'https://codehs.com/uploads/deba297bed3e9e59ef4b003b3c4797ed', 'https://codehs.com/uploads/67f201b907a12e51510cb05227381401');

                    RunningTankman.precache(scene);
                }

                sky;
                mountains;
                buildings;
                ruins;
                clouds;
                smokeLeft;
                smokeRight;
                watchtower;
                tankRolling;
                ground;

                tankFGboppers = [];

                tankmenRunning = [];

                onCreate()
                {
                    this.manager.zoom = 0.8;

                    this.sky = this.manager.scene.createImage('tankSky', -400, -400);
                    this.sky.scrollFactorX = this.sky.scrollFactorY = 0;
                    this.manager.add(this.sky);

                    this.mountains = this.manager.scene.createImage('tankMountains', -280, -20);
                    this.mountains.scrollFactorX = this.mountains.scrollFactorY = 0.2;
                    this.mountains.scaleX = this.mountains.scaleY = 1.2;
                    this.manager.add(this.mountains);

                    this.buildings = this.manager.scene.createImage('tankBuildings', -180, 0);
                    this.buildings.scrollFactorX = this.buildings.scrollFactorY = 0.3;
                    this.buildings.scaleX = this.buildings.scaleY = 1.1;
                    this.manager.add(this.buildings);

                    this.ruins = this.manager.scene.createImage('tankRuins', -180, 0);
                    this.ruins.scrollFactorX = this.ruins.scrollFactorY = 0.35;
                    this.ruins.scaleX = this.ruins.scaleY = 1.1;
                    this.manager.add(this.ruins);

                    this.clouds = this.manager.scene.createPhysicsImage('tankClouds', Math.floor(Math.random() * (-100 + 700) - 700), Math.floor(Math.random() * (20 + 20) - 20));
                    this.clouds.scrollFactorX = this.clouds.scrollFactorY = 0.4;
                    this.clouds.setVelocityX(Math.random() * (5 - 15) + 15);
                    this.manager.scene.addToCameras(this.clouds, [this.manager.scene.cameras.main]);
                    
                    this.manager.add(this.clouds);

                    var tex = 'tankSmokeLeft';
                    this.smokeLeft = this.manager.scene.createSprite(tex, -200, 0);
                    this.smokeLeft.scrollFactorX = this.smokeLeft.scrollFactorY = 0.4;
                    this.smokeLeft.anims.create({key: 'idle', frameRate: 24, repeat: -1, frames: this.smokeLeft.anims.generateFrameNames(tex, {prefix: 'SmokeBlurLeft instance 1', end: 47, zeroPad: 4})});
                    this.smokeLeft.anims.play('idle');
                    this.manager.add(this.smokeLeft);

                    var tex = 'tankSmokeRight';
                    this.smokeRight = this.manager.scene.createSprite(tex, 1100, -100);
                    this.smokeRight.scrollFactorX = this.smokeRight.scrollFactorY = 0.4;
                    this.smokeRight.anims.create({key: 'idle', frameRate: 24, repeat: -1, frames: this.smokeRight.anims.generateFrameNames(tex, {prefix: 'SmokeRight instance 1', end: 47, zeroPad: 4})});
                    this.smokeRight.anims.play('idle');
                    this.manager.add(this.smokeRight);

                    var tex = 'tankWatchtower';
                    this.watchtower = this.manager.scene.createSprite(tex, 100, 50);
                    this.watchtower.scrollFactorX = this.watchtower.scrollFactorY = 0.5;
                    this.watchtower.anims.create({key: 'idle', frameRate: 24, frames: this.watchtower.anims.generateFrameNames(tex, {prefix: 'watchtower gradient color instance 1', end: 13, zeroPad: 4})});
                    this.watchtower.anims.play('idle');
                    this.manager.add(this.watchtower);

                    var tex = 'tankRolling';
                    this.tankRolling = this.manager.scene.createSprite(tex, 300, 300);
                    this.tankRolling.scrollFactorX = this.tankRolling.scrollFactorY = 0.5;
                    this.tankRolling.anims.create({key: 'idle', frameRate: 24, repeat: -1, frames: this.tankRolling.anims.generateFrameNames(tex, {prefix: 'BG tank w lighting instance 1', end: 2, zeroPad: 4})});
                    this.tankRolling.anims.play('idle');
                    this.manager.add(this.tankRolling);

                    this.tankMoving = false;
                    this.tankAngle = Math.floor(Math.random() * (-90 - 45) + 45);
                    this.tankSpeed = Math.random() * (5 - 7) + 7;
                    this.tankX = 400;

                    this.checkForBGTankmen();

                    this.ground = this.manager.scene.createImage('tankGround', -420, -150);
                    this.ground.scrollFactorX = this.ground.scrollFactorY = 1;
                    this.ground.scaleX = this.ground.scaleY = 1.15;
                    this.manager.add(this.ground);

                    this.manager.scene.girlfriendPos[0] -= 200;
                    this.manager.scene.girlfriendPos[1] -= 75;
                }

                onCreateBF()
                {
                    var tex = 'tankFG0';
                    var bopper = this.manager.scene.createSprite(tex, -500, 650);
                    bopper.scrollFactorX = 1.7;
                    bopper.scrollFactorY = 1.5;
                    bopper.anims.create({key: 'idle', frameRate: 24, frames: bopper.anims.generateFrameNames(tex, {prefix: 'fg tankhead far right instance 1', end: 13, zeroPad: 4})});
                    bopper.anims.play('idle');
                    this.manager.add(bopper);
                    this.tankFGboppers.push(bopper);

                    var tex = 'tankFG2';
                    var bopper = this.manager.scene.createSprite(tex, 360, 980);
                    bopper.scrollFactorX = bopper.scrollFactorY = 1.5;
                    bopper.anims.create({key: 'idle', frameRate: 24, frames: bopper.anims.generateFrameNames(tex, {prefix: 'foreground man 3 instance 1', end: 13, zeroPad: 4})});
                    bopper.anims.play('idle');
                    this.manager.add(bopper);
                    this.tankFGboppers.push(bopper);

                    var tex = 'tankFG3';
                    var bopper = this.manager.scene.createSprite(tex, 1050, 1240);
                    bopper.scrollFactorX = 3.5;
                    bopper.scrollFactorY = 2.5;
                    bopper.anims.create({key: 'idle', frameRate: 24, frames: bopper.anims.generateFrameNames(tex, {prefix: 'fg tankhead 4 instance 1', end: 14, zeroPad: 4})});
                    bopper.anims.play('idle');
                    this.manager.add(bopper);
                    this.tankFGboppers.push(bopper);

                    var tex = 'tankFG4';
                    var bopper = this.manager.scene.createSprite(tex, 1200, 900);
                    bopper.scrollFactorX = bopper.scrollFactorY = 1.5;
                    bopper.anims.create({key: 'idle', frameRate: 24, frames: bopper.anims.generateFrameNames(tex, {prefix: 'fg tankman bobbin 3 instance 1', end: 13, zeroPad: 4})});
                    bopper.anims.play('idle');
                    this.manager.add(bopper);
                    this.tankFGboppers.push(bopper);

                    var tex = 'tankFG5';
                    var bopper = this.manager.scene.createSprite(tex, 1550, 700);
                    bopper.scrollFactorX = bopper.scrollFactorY = 1.5;
                    bopper.anims.create({key: 'idle', frameRate: 24, frames: bopper.anims.generateFrameNames(tex, {prefix: 'fg tankhead far right instance 1', end: 13, zeroPad: 4})});
                    bopper.anims.play('idle');
                    this.manager.add(bopper);
                    this.tankFGboppers.push(bopper);

                    var tex = 'tankFG1';
                    var bopper = this.manager.scene.createSprite(tex, -300, 750);
                    bopper.scrollFactorX = 2.0;
                    bopper.scrollFactorY = 0.2;
                    bopper.anims.create({key: 'idle', frameRate: 24, frames: bopper.anims.generateFrameNames(tex, {prefix: 'fg tankhead 5 instance 1', end: 14, zeroPad: 4})});
                    bopper.anims.play('idle');
                    this.manager.add(bopper);
                    this.tankFGboppers.push(bopper);
                }

                onBeatHit(beat)
                {
                    if (this.watchtower != null)
                        this.watchtower.anims.play('idle')

                    for (var bopper of this.tankFGboppers)
                        if (bopper != null)
                            bopper.anims.play('idle');
                }

                tankMoving;
                tankAngle;
                tankSpeed;
                tankX;

                onUpdate(elapsed)
                {
                    this.moveTank(elapsed);

                    for (var tankman of this.tankmenRunning)
                    {
                        if (tankman != null)
                        {
                            tankman.update();

                            if (tankman.time <= (Conductor.instance.lastTime ?? 0))
                            {
                                if (!tankman.anims.getName().startsWith('shot'))
                                    tankman.playAnim('shot ' + Math.floor(Math.random() * (2 - 1) + 1));
                                //tankman.visible = false;
                                //tankman.destroy();
                                //this.tankmenRunning.splice(this.tankmenRunning.indexOf(tankman), 1);
                            }
                        }
                    }
                }

                moveTank(elapsed)
                {
                    var daAngleOffset = 1;
                    this.tankAngle += elapsed * this.tankSpeed;

                    if (this.tankRolling != null)
                    {
                        this.tankRolling.angle = this.tankAngle - 90 + 15;
                        this.tankRolling.x = this.tankX + Math.cos(this.asRadians((this.tankAngle * daAngleOffset) + 180)) * 1500;
                        this.tankRolling.y = 1300 + Math.sin(this.asRadians((this.tankAngle * daAngleOffset) + 180)) * 1100;
                    }
                }

                asRadians(degrees)
                {
                    return degrees * (Math.PI / 180);
                }

                checkForBGTankmen()
                {
                    if (PlayState.instance != null)
                    {
                        if (PlayState.instance.chart != null)
                        {
                            var notes = PlayState.instance.chart.getNotes('picospeaker') ?? [];
                            if (notes.length > 0)
                            {
                                for (var note of notes)
                                {
                                    if (Math.random() * 100 < 6.5)
                                    {
                                        var tankman = new RunningTankman(PlayState.instance, Math.random() * (200 - 50) + 50, 400 + Math.floor(Math.random() * (100 - 50) + 50), ((note.d ?? 0) < 2));
                                        // tankman.scaleX = tankman.scaleY = 0.6;
                                        tankman.time = note.t ?? 0;
                                        tankman.runSpeed = Math.random() * (1 - 0.6) + 0.6;
                                        this.manager.add(tankman);
                                        this.tankmenRunning.push(tankman);
                                    }
                                }
                            }
                        }
                    }
                }
            }

            class RunningTankman extends Phaser.GameObjects.Sprite
            {
                static precache(scene)
                {
                    scene.load.atlasXML('tankmanRunning', 'https://codehs.com/uploads/a6c253ff229f3c2cb5862141af7a0e55', 'https://codehs.com/uploads/23fdbc0de28be19144110ab2eeb43538');
                }

                left = false;
                time = 0;
                runSpeed = 1;
                baseX = 0;
                baseY = 0;

                constructor(scene, x = 0, y = 0, left = false, time = 0)
                {
                    var frames = 'tankmanRunning';
                    super(scene, x, y, frames);

                    this.anims.create({key: 'run', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(frames, {prefix: 'tankman running', end: 13, zeroPad: 4})});
                    this.anims.create({key: 'shot 1', frameRate: 24, frames: this.anims.generateFrameNames(frames, {prefix: 'John Shot 1', end: 11, zeroPad: 4})});
                    this.anims.create({key: 'shot 2', frameRate: 24, frames: this.anims.generateFrameNames(frames, {prefix: 'John Shot 2', end: 11, zeroPad: 4})});
                    this.playAnim('run');

                    this.baseX = x ?? 0;
                    this.baseY = y ?? 0;

                    this.left = left ?? false;
                    this.flipX = this.left;
                }

                offsetted = false;

                playAnim(name)
                {
                    if (!this.anims.exists(name))
                        return;

                    this.anims.play(name);

                    if (name.startsWith('shot') && !this.offsetted)
                    {
                        this.offsetted = true;
                        this.baseX -= 300;
                        this.baseY -= 200;

                        this.anims.hideOnComplete = true;
                    }
                    else if (!name.startsWith('shot') && this.offsetted)
                    {
                        this.offsetted = false;
                        this.baseX += 300;
                        this.baseY += 200;
                    }
                }

                update()
                {
                    if (this.anims.getName() == 'run')
                    {
                        if (this.left)
                            this.x = (PlayState.instance.getWidth() * 0.02 - this.baseX) + (((Conductor.instance.lastTime ?? 0) - this.time) * this.runSpeed);
                        else
                            this.x = (PlayState.instance.getWidth() * 0.74 + this.baseX) - (((Conductor.instance.lastTime ?? 0) - this.time) * this.runSpeed);
                    }
                }
            }

            class PhillyStreets extends BaseStage
            {
                static precache(scene)
                {
                    scene.load.image('phillySkybox', "https://codehs.com/uploads/2a1f416d7a70e2844a80787e03f86c8d");
                    scene.load.image('phillySkyline', "https://codehs.com/uploads/84d816059e7edfe42c336f7b3b9b0c36");
                    scene.load.image('phillyForegroundCity', "https://codehs.com/uploads/14288afd0d3d5dced8ac0ee6ade63a60");
                    scene.load.image('phillyConstruction', "https://codehs.com/uploads/c49786f8c77872f1727029bf6a508588");
                    scene.load.image('phillyHighwayLights', "https://codehs.com/uploads/a827d319dde290f7ef3123c9b7eb7d72");
                    scene.load.image('phillyHighwayLights_lightmap', "https://codehs.com/uploads/3dca219b020fc437690bb2e97985fa00");
                    scene.load.image('phillyHighway', "https://codehs.com/uploads/576952a3a500226de4869c4153f3152b");
                    scene.load.image('phillySmog', "https://codehs.com/uploads/d63e0595242e3bdc382317b3bbd6a332");
                    scene.load.atlasXML('phillyCars', 'https://codehs.com/uploads/78ed144ba76774716d294c8891b310fc', 'https://codehs.com/uploads/ce9f5d0f5ac0b049dc9434e0f8f98c99');
                    scene.load.atlasXML('phillyTraffic', 'https://codehs.com/uploads/c59c8806b042b1972320245563393524', 'https://codehs.com/uploads/47c95c24f64218ce8987e08261d07437');
                    scene.load.image('phillyTraffic_lightmap', "https://codehs.com/uploads/7d36fce5060bcc4c5f5b22bd74941952");
                    scene.load.image('phillyForeground', "https://codehs.com/uploads/ab46bed93d522da05e804b7a88f511d2");
                    scene.load.image('spraycanPile', "https://codehs.com/uploads/980f91e5b47c5f3b84102beb43b86a90");
                }

                // Hey dumbass, TileSprite exists!
                // scrollingSky:Phaser.GameObjects.TileSprite;
                scrollingSky;
                scrollingSky2;
                scrollingSky3;

                sky;
                city;
                construction;
                highwayLights;
                highwayLights_lightmap;
                highway;
                smog;
                cars;
                cars2;
                traffic;
                traffic_lightmap;
                foreground;
                spraycanPile;

                onCreate()
                {
                    this.manager.zoom = 0.77;

                    this.scrollingSky = this.manager.scene.createImage('phillySkybox', -650, -375);
                    this.scrollingSky.scrollFactorX = this.scrollingSky.scrollFactorY = 0.1;
                    this.scrollingSky.scaleX = this.scrollingSky.scaleY = 0.65;
                    this.scrollingSky.x += this.scrollingSky.displayWidth / 2; // Phaser wonky hitboxes
                    this.scrollingSky.y += this.scrollingSky.displayHeight / 2;
                    this.manager.add(this.scrollingSky);

                    this.scrollingSky2 = this.manager.scene.createImage('phillySkybox', this.scrollingSky.x, this.scrollingSky.y);
                    this.scrollingSky2.scrollFactorX = this.scrollingSky2.scrollFactorY = 0.1;
                    this.scrollingSky2.scaleX = this.scrollingSky2.scaleY = 0.65;
                    this.scrollingSky2.x -= this.scrollingSky2.displayWidth; // Phaser wonky hitboxes
                    this.manager.add(this.scrollingSky2);

                    this.scrollingSky3 = this.manager.scene.createImage('phillySkybox', this.scrollingSky2.x, this.scrollingSky2.y);
                    this.scrollingSky3.scrollFactorX = this.scrollingSky3.scrollFactorY = 0.1;
                    this.scrollingSky3.scaleX = this.scrollingSky3.scaleY = 0.65;
                    this.scrollingSky3.y -= this.scrollingSky3.displayHeight;
                    this.manager.add(this.scrollingSky3);

                    this.sky = this.manager.scene.createImage('phillySkyline', -545, -273);
                    this.sky.scrollFactorX = this.sky.scrollFactorY = 0.2;
                    this.manager.add(this.sky);

                    this.city = this.manager.scene.createImage('phillyForegroundCity', 625, 94);
                    this.city.scrollFactorX = this.city.scrollFactorY = 0.3;
                    this.manager.add(this.city);

                    this.construction = this.manager.scene.createImage('phillyConstruction', 1800, 364);
                    this.construction.scrollFactorX = 0.7;
                    this.construction.scrollFactorY = 1;
                    this.manager.add(this.construction);

                    this.highwayLights = this.manager.scene.createImage('phillyHighwayLights', 284, 305);
                    this.highwayLights.scrollFactorX = this.highwayLights.scrollFactorY = 1;
                    this.manager.add(this.highwayLights);

                    this.highwayLights_lightmap = this.manager.scene.createImage('phillyHighwayLights_lightmap', 284, 305);
                    this.highwayLights_lightmap.scrollFactorX = this.highwayLights_lightmap.scrollFactorY = 1;
                    //this.manager.add(this.highwayLights_lightmap);

                    this.highway = this.manager.scene.createImage('phillyHighway', 139, 209);
                    this.highway.scrollFactorX = this.highway.scrollFactorY = 1;
                    this.manager.add(this.highway);

                    this.smog = this.manager.scene.createImage('phillySmog', -6, 245);
                    this.smog.scrollFactorX = 0.8;
                    this.smog.scrollFactorY = 1;
                    this.manager.add(this.smog);

                    this.cars = this.manager.scene.createSprite('phillyCars', 1748, 818);
                    this.cars.scrollFactorX = 0.9;
                    this.cars.scrollFactorY = 1;
                    this.cars.anims.create({key: 'car1', frameRate: 24, repeat: -1, frames: this.cars.anims.generateFrameNames('phillyCars', {prefix: 'car1', end: 0, zeroPad: 4})});
                    this.cars.anims.create({key: 'car2', frameRate: 24, repeat: -1, frames: this.cars.anims.generateFrameNames('phillyCars', {prefix: 'car2', end: 0, zeroPad: 4})});
                    this.cars.anims.create({key: 'car3', frameRate: 24, repeat: -1, frames: this.cars.anims.generateFrameNames('phillyCars', {prefix: 'car3', end: 0, zeroPad: 4})});
                    this.cars.anims.create({key: 'car4', frameRate: 24, repeat: -1, frames: this.cars.anims.generateFrameNames('phillyCars', {prefix: 'car4', end: 0, zeroPad: 4})});
                    this.manager.add(this.cars);

                    this.cars2 = this.manager.scene.createSprite('phillyCars', 1748, 818);
                    this.cars2.scrollFactorX = 0.9;
                    this.cars2.scrollFactorY = 1;
                    this.cars2.anims.create({key: 'car1', frameRate: 24, repeat: -1, frames: this.cars2.anims.generateFrameNames('phillyCars', {prefix: 'car1', end: 0, zeroPad: 4})});
                    this.cars2.anims.create({key: 'car2', frameRate: 24, repeat: -1, frames: this.cars2.anims.generateFrameNames('phillyCars', {prefix: 'car2', end: 0, zeroPad: 4})});
                    this.cars2.anims.create({key: 'car3', frameRate: 24, repeat: -1, frames: this.cars2.anims.generateFrameNames('phillyCars', {prefix: 'car3', end: 0, zeroPad: 4})});
                    this.cars2.anims.create({key: 'car4', frameRate: 24, repeat: -1, frames: this.cars2.anims.generateFrameNames('phillyCars', {prefix: 'car4', end: 0, zeroPad: 4})});
                    this.cars2.flipX = true;
                    this.manager.add(this.cars2);

                    this.traffic = this.manager.scene.createSprite('phillyTraffic', 1840, 608);
                    this.traffic.scrollFactorX = 0.9;
                    this.traffic.scrollFactorY = 1;
                    this.traffic.anims.create({key: 'togreen', frameRate: 24, frames: this.cars2.anims.generateFrameNames('phillyTraffic', {prefix: 'redtogreen', end: 20, zeroPad: 4})});
                    this.traffic.anims.create({key: 'tored', frameRate: 24, frames: this.cars2.anims.generateFrameNames('phillyTraffic', {prefix: 'greentored', end: 57, zeroPad: 4})});
                    this.manager.add(this.traffic)
                    
                    this.traffic_lightmap = this.manager.scene.createImage('phillyTraffic_lightmap', 1840, 608);
                    this.traffic_lightmap.scrollFactorX = 0.9;
                    this.traffic_lightmap.scrollFactorY = 1;
                    this.manager.add(this.traffic_lightmap);

                    this.foreground = this.manager.scene.createImage('phillyForeground', 88, 317);
                    this.foreground.scrollFactorX = this.foreground.scrollFactorY = 1;
                    this.manager.add(this.foreground);

                    this.manager.scene.girlfriendPos[0] += 800;
                    this.manager.scene.girlfriendPos[1] += 265;

                    this.manager.scene.opponentPos[0] += 600;
                    this.manager.scene.opponentPos[1] += 300;

                    this.manager.scene.playerPos[0] += 1150;
                    this.manager.scene.playerPos[1] += 350;
                }

                onCreateBF()
                {
                    this.spraycanPile = this.manager.scene.createImage('spraycanPile', 920, 1045);
                    this.spraycanPile.scrollFactorX = this.spraycanPile.scrollFactorY = 1;
                    this.manager.add(this.spraycanPile);

                    // this.resetCar(true, true);
                        // this.resetStageValues();
                }

                update(elapsed)
                {
                    var fullSky = [this.scrollingSky, this.scrollingSky2, this.scrollingSky3];
                    
                    for (var sky of fullSky)
                    {
                        sky.x += 1;
                        if (sky.x > this.manager.scene.getWidth() ?? 1280)
                        {
                            var lowestX = sky.x;
                            for (var dbSky of fullSky)
                            if (dbSky.x < lowestX)
                                lowestX = dbSky.x;

                            sky.x = lowestX - sky.displayWidth;
                        }
                    }
                }

                /*
                onBeatHit(beat)
                {
                    if ((Math.random() * 100) < 10 && beat != (this.lastChange + this.changeInterval) && this.carInterruptable)
                    {
                        if (!this.lightsStop)
                            this.driveCar(this.cars);
                        else
                            this.driveCarLights(this.cars);
                    }

                    if ((Math.random() * 100) < 10 && beat != (this.lastChange + this.changeInterval) && this.car2Interruptable && !this.lightsStop)
                        this.driveCarBack(this.cars2);

                    if (beat == (this.lastChange + this.changeInterval))
                        this.changeLights(beat);
                }

                lightsStop = false;
                lastChange = 0;
                changeInterval = 8;

                carWaiting = false;
                carInterruptable = true;
                car2Interruptable = true;

                changeLights(beat)
                {
                    this.lastChange = beat;
                    this.lightsStop = !this.lightsStop;

                    if (this.lightsStop)
                    {
                        this.traffic.anims.play('tored');
                        this.changeInterval = 20;
                    } else {
                        this.traffic.anims.play('togreen');
                        this.changeInterval = 30;

                        if (this.carWaiting == true) this.finishCarLights(this.cars);
                    }
                }

                resetCar(left, right)
                {
                    if (left)
                    {
                        this.carWaiting = false;
                        this.carInterruptable = true;

                        if (this.cars != null)
                        {
                            // FlxTween.cancelTweensOf(cars);
                            this.cars.x = 1200;
                            this.cars.y = 818;
                            this.cars.angle = 0;
                        }
                    }

                    if (right)
                    {
                        this.car2Interruptable = true;
                            
                        if (this.cars2 != null)
                        {
                            // FlxTween.cancelTweensOf(cars2);
                            this.cars2.x = 1200;
                            this.cars2.y = 818;
                            this.cars2.angle = 0;
                        }
                    }
                }

                resetStageValues()
                {
                    this.lastChange = 0;
                    this.changeInterval = 8;

                    if (this.traffic != null)
                        this.traffic.anims.play('togreen');

                    this.lightsStop = false;
                }

                getPoint(x, y) { return {x: x, y: y}; }
                */
            }

            class Null extends BaseStage
            {
                static precache(scene) {}

                onCreate()
                {
                    if (PlayState.instance != null)
                        PlayState.instance.pixelUI = true;

                    this.manager.zoom = 0.7;
                }

                onCreatePost()
                {
                    if (this.manager.scene.opponent != null)
                        this.manager.scene.opponent.camFollow[0] += 100;

                    if (this.manager.scene.healthBar != null)
                        this.manager.scene.healthBar.setVisible(false);
                    if (this.manager.scene.iconP1 != null)
                        this.manager.scene.iconP1.visible = false;
                    if (this.manager.scene.iconP2 != null)
                        this.manager.scene.iconP2.visible = false;
                    if (this.manager.scene.scoreText != null)
                        this.manager.scene.scoreText.visible = false;
                }
            }

            class StageManager
            {
                static precache(scene)
                {
                    BaseStage.precache(scene);
                    MainStage.precache(scene);
                    SpookyMansion.precache(scene);
                    PhillyTrain.precache(scene);
                    LimoRide.precache(scene);
                    MallXmas.precache(scene);
                    MallEvil.precache(scene);
                    School.precache(scene);
                    SchoolEvil.precache(scene);
                    TankmanBattlefield.precache(scene);
                    PhillyStreets.precache(scene);
                    Null.precache(scene);
                }

                list = [];
                objectList = [];
                soundPool = [];
                scene;
                zoom = 1.05;

                constructor(scene, stage = 'mainStage')
                {
                    this.scene = scene;
                    this.list.push(this.getStageFromName(stage));
                }

                getStageFromName(name)
                {
                    switch (name.toLowerCase())
                    {
                        case 'mainstage':                           return new MainStage(this);
                        case 'spookymansion':                   return new SpookyMansion(this);
                        case 'phillytrain':                       return new PhillyTrain(this);
                        case 'limoride':                             return new LimoRide(this);
                        case 'mallxmas':                             return new MallXmas(this);
                        case 'mallevil':                             return new MallEvil(this);
                        case 'school':                                 return new School(this);
                        case 'schoolevil':                         return new SchoolEvil(this);
                        case 'tankmanbattlefield':         return new TankmanBattlefield(this);
                        case 'phillystreets':                   return new PhillyStreets(this);
                        // case 'phillyblazin':                  return new PhillyBlazin(this);
                        case 'null':                                     return new Null(this);
                        default:                                    return new MainStage(this);
                    }
                }

                onCreate()                                  { for (var stage of this.list) stage.onCreate(); }
                onCreateGF()                              { for (var stage of this.list) stage.onCreateGF(); }
                onCreateDad()                            { for (var stage of this.list) stage.onCreateDad(); }
                onCreateBF()                              { for (var stage of this.list) stage.onCreateBF(); }
                onCreatePost()                          { for (var stage of this.list) stage.onCreatePost(); }

                onUpdate(elapsed)                    { for (var stage of this.list) stage.onUpdate(elapsed); }

                onStepHit(step)                        { for (var stage of this.list) stage.onStepHit(step); }
                onBeatHit(beat)                        { for (var stage of this.list) stage.onBeatHit(beat); }
                onSectionHit(section)            { for (var stage of this.list) stage.onSectionHit(section); }

                add(obj)
                {
                    this.scene.add.existing(obj);
                    this.scene.addToCameras(obj, [this.scene.cameras.main]);
                    this.objectList.push(obj);
                }
            }

            class Character extends Phaser.GameObjects.Sprite
            {
                static precache(scene)
                {
                    for (var character of CharacterRegistry.characters)
                    {
                        if (character != null)
                        {
                            if (character.name != null && character.name.length > 0)
                            {
                                if (character.png != null && character.png.length > 0)
                                    if (character.xml != null && character.xml.length > 0)
                                        scene.load.atlasXML(character.name, character.png + '?.png', character.xml + '?.xml');
                            }
                        }
                    }
                }

                animOffsets;

                isPlayer = false;
                curCharacter;
                icon;

                holdTimer = 0;
                startedDeath = false;

                danceTimer = 0;
                danceRight = false;
                specialAnim = false;

                camFollow = [0, 0];
                camAdd = [0, 0];
                animationNotes = [];

                baseX = 0.0;
                baseY = 0.0;

                canIdle = true;

                knifeRaised = false;

                constructor(scene, x = 0, y = 0, character = Constants.DEFAULT_CHARACTER, isPlayer = false)
                {
                    character = character ?? Constants.DEFAULT_CHARACTER;

                    var characterFrame = character;
                    switch (character.toLowerCase())
                    {
                        case 'senpai-angry':
                            characterFrame = 'senpai';
                            break;

                        case "null":
                            characterFrame = 'senpai';
                            character = 'senpai-angry';
                            break;
                    }

                    var foundFrame = false;
                    for (var char of CharacterRegistry.characters)
                    if (char != null)
                        if (char.name == characterFrame)
                            foundFrame = true;

                    if (!foundFrame)
                        characterFrame = character = Constants.DEFAULT_CHARACTER;

                    super(scene, x, y, characterFrame);

                    this.baseX = x;
                    this.baseY = y;

                    this.animOffsets = new Map();
                    this.curCharacter = character;
                    this.icon = character;
                    this.isPlayer = isPlayer;

                    this.setOrigin(0, 0);

                    switch (this.curCharacter)
                    {
                        case 'bf':
                            this.baseY += 350;
                            this.camAdd[0] = -200;
                            this.camAdd[1] = -100;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF idle dance', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE LEFT0', end: 14, zeroPad: 3})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE DOWN0', end: 29, zeroPad: 3})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE UP0', end: 14, zeroPad: 3})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE RIGHT0', end: 61, zeroPad: 3})});
                            this.anims.create({key: 'singLEFTmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE LEFT MISS', end: 33, zeroPad: 4})});
                            this.anims.create({key: 'singDOWNmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE DOWN MISS', end: 28, zeroPad: 4})});
                            this.anims.create({key: 'singUPmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE UP MISS', end: 23, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHTmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE RIGHT MISS', end: 45, zeroPad: 4})});
                            this.anims.create({key: 'scared', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF idle shaking', end: 3, zeroPad: 4})});
                            this.anims.create({key: 'hey', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF HEY!!', end: 25, zeroPad: 4})});

                            this.anims.create({key: 'firstDeath', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF dies', end: 57, zeroPad: 4})});
                            this.anims.create({key: 'deathLoop', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF Dead Loop', end: 33, zeroPad: 4})});
                            this.anims.create({key: 'deathConfirm', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF Dead confirm', end: 33, zeroPad: 4})});

                            this.animOffsets.set('idle', [-5, 0]);
                            this.animOffsets.set('singLEFT', [5, -6]);
                            this.animOffsets.set('singDOWN', [-20, -51]);
                            this.animOffsets.set('singUP', [-46, 27]);
                            this.animOffsets.set('singRIGHT', [-48, -7]);
                            this.animOffsets.set('singLEFTmiss', [7, 19]);
                            this.animOffsets.set('singDOWNmiss', [-15, -19]);
                            this.animOffsets.set('singUPmiss', [-46, 27]);
                            this.animOffsets.set('singRIGHTmiss', [-44, 22]);
                            this.animOffsets.set('scared', [-4, 0]);
                            this.animOffsets.set('hey', [-3, 5]);

                            this.animOffsets.set('firstDeath', [-37, 11]);
                            this.animOffsets.set('deathLoop', [-37, 5]);
                            this.animOffsets.set('deathConfirm', [-37, 69]);

                            this.flipX = true;
                            break;

                        case 'gf':
                            this.anims.create({key: 'danceLeft', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Dancing Beat', end: 14, zeroPad: 4})});
                            this.anims.create({key: 'danceRight', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Dancing Beat', start: 15, end: 29, zeroPad: 4})});
                            this.anims.create({key: 'sad', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'gf sad', end: 12, zeroPad: 4})})
                            this.anims.create({key: 'scared', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF FEAR ', end: 3, zeroPad: 4})});
                            this.anims.create({key: 'hairBlow', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Dancing Beat Hair blowing', end: 3, zeroPad: 4})});
                            this.anims.create({key: 'hairFall', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Dancing Beat Hair Landing', end: 11, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF left note', end: 14, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Down Note', end: 19, zeroPad: 4})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Up Note', end: 6, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Right Note', end: 14, zeroPad: 4})});
                            this.anims.create({key: 'cheer', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Cheer', end: 20, zeroPad: 4})});
                            
                            this.animOffsets.set('danceLeft', [0, -9]);
                            this.animOffsets.set('danceRight', [0, -9]);
                            this.animOffsets.set('sad', [2, -21]);
                            this.animOffsets.set('scared', [-2, -17]);
                            this.animOffsets.set('hairBlow', [45, -8]);
                            this.animOffsets.set('hairFall', [0, -9]);
                            this.animOffsets.set('singLEFT', [0, -19]);
                            this.animOffsets.set('singDOWN', [0, -20]);
                            this.animOffsets.set('singUP', [0, 4]);
                            this.animOffsets.set('singRIGHT', [0, -20]);
                            this.animOffsets.set('cheer', [3, 0]);
                            break;

                        case 'dad':
                            this.camAdd[0] = 100;
                            this.camAdd[1] = -100;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Dad idle dance', end: 12, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'dad sing note right', end: 15, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Dad Sing Note DOWN', end: 15, zeroPad: 4})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Dad Sing note UP', end: 59, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Dad Sing Note LEFT', end: 18, zeroPad: 4})});

                            this.anims.create({key: 'idle-hold', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Dad idle dance', start: 11, end: 12, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT-hold', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'dad sing note right', start: 2, end: 15, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN-hold', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Dad Sing Note DOWN', start: 3, end: 15, zeroPad: 4})});
                            this.anims.create({key: 'singUP-hold', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Dad Sing note UP', start: 3, end: 59, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT-hold', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Dad Sing Note LEFT', start: 3, end: 18, zeroPad: 4})});

                            this.animOffsets.set('idle', [0, 0]);
                            this.animOffsets.set('singLEFT', [-9, 10]);
                            this.animOffsets.set('singDOWN', [0, -30]);
                            this.animOffsets.set('singUP', [-6, 50]);
                            this.animOffsets.set('singRIGHT', [0, 27]);

                            this.animOffsets.set('idle-hold', [0, 0]);
                            this.animOffsets.set('singLEFT-hold', [-9, 10]);
                            this.animOffsets.set('singDOWN-hold', [0, -30]);
                            this.animOffsets.set('singUP-hold', [-6, 50]);
                            this.animOffsets.set('singRIGHT-hold', [0, 27]);
                            break;

                        case 'spooky':
                            this.baseY += 200;
                            this.camAdd[0] += 200;
                            this.camAdd[1] -= 50;

                            this.anims.create({key: 'danceLeft', frameRate: 12, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'spooky dance idle', frames: [0, 2, 6], zeroPad: 4})});
                            this.anims.create({key: 'danceRight', frameRate: 12, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'spooky dance idle', frames: [8, 10, 12, 14], zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'note sing left', end: 14, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'spooky DOWN note', end: 24, zeroPad: 4})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'spooky UP NOTE', end: 4, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'spooky sing right', end: 24, zeroPad: 4})});

                            this.animOffsets.set('danceLeft', [0, 0]);
                            this.animOffsets.set('danceRight', [0, 0]);
                            this.animOffsets.set('singLEFT', [130, -10]);
                            this.animOffsets.set('singDOWN', [-50, -130]);
                            this.animOffsets.set('singUP', [-20, 26]);
                            this.animOffsets.set('singRIGHT', [-130, -14]);
                            break;

                        case 'monster':
                            this.baseY += 100;
                            this.camAdd[0] += 200;
                            this.camAdd[1] -= 150;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'monster idle', end: 14, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Monster Right note', end: 19, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'monster down', end: 29, zeroPad: 4})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'monster up note', end: 23, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Monster left note', end: 14, zeroPad: 4})});

                            this.animOffsets.set('idle', [3, 0]);
                            this.animOffsets.set('singLEFT', [-51, 30]);
                            this.animOffsets.set('singDOWN', [-50, -80]);
                            this.animOffsets.set('singUP', [-20, 94]);
                            this.animOffsets.set('singRIGHT', [-30, 20]);
                            break;

                        case 'pico':
                            this.baseY += 300;
                            this.camAdd[0] += 279;
                            this.camAdd[1] -= 100;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico Idle Dance instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico NOTE LEFT instance 1', end: 16, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico Down Note instance 1', end: 10, zeroPad: 4})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'pico Up note instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico Note Right instance 1', end: 16, zeroPad: 4})});

                            this.animOffsets.set('idle', [0, 0]);
                            this.animOffsets.set('singRIGHT', [-68, -7]);
                            this.animOffsets.set('singDOWN', [200, -70]);
                            this.animOffsets.set('singUP', [-29, 27]);
                            this.animOffsets.set('singLEFT', [65, 9]);
                            break;

                        case 'bf-car':
                            this.baseY += 350;
                            this.camAdd[0] = -200;
                            this.camAdd[1] = -100;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF idle dance', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'idle-hold', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF idle dance', start: 10, end: 13, zeroPad: 4})});

                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE LEFT0', end: 15, zeroPad: 3})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE DOWN0', end: 29, zeroPad: 3})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE UP0', end: 14, zeroPad: 3})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE RIGHT0', end: 61, zeroPad: 3})});

                            this.anims.create({key: 'singLEFT-hold', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE LEFT0', start: 12, end: 15, zeroPad: 3})});
                            this.anims.create({key: 'singDOWN-hold', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE DOWN0', start: 26, end: 29, zeroPad: 3})});
                            this.anims.create({key: 'singUP-hold', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE UP0', start: 11, end: 14, zeroPad: 3})});
                            this.anims.create({key: 'singRIGHT-hold', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE RIGHT0', start: 58, end: 61, zeroPad: 3})});

                            this.anims.create({key: 'singLEFTmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE LEFT MISS', end: 33, zeroPad: 4})});
                            this.anims.create({key: 'singDOWNmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE DOWN MISS', end: 28, zeroPad: 4})});
                            this.anims.create({key: 'singUPmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE UP MISS', end: 23, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHTmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE RIGHT MISS', end: 45, zeroPad: 4})});

                            this.animOffsets.set('idle', [-5, 0]);
                            this.animOffsets.set('idle-hold', [-5, 0]);

                            this.animOffsets.set('singLEFT', [5, -6]);
                            this.animOffsets.set('singDOWN', [-20, -51]);
                            this.animOffsets.set('singUP', [-46, 27]);
                            this.animOffsets.set('singRIGHT', [-48, -7]);

                            this.animOffsets.set('singLEFT-hold', [5, -6]);
                            this.animOffsets.set('singDOWN-hold', [-20, -51]);
                            this.animOffsets.set('singUP-hold', [-46, 27]);
                            this.animOffsets.set('singRIGHT-hold', [-48, -7]);

                            this.animOffsets.set('singLEFTmiss', [7, 19]);
                            this.animOffsets.set('singDOWNmiss', [-15, -19]);
                            this.animOffsets.set('singUPmiss', [-46, 27]);
                            this.animOffsets.set('singRIGHTmiss', [-44, 22]);

                            this.flipX = true;
                            this.icon = 'bf';
                            break;

                        case 'gf-car':
                            this.anims.create({key: 'danceLeft', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Dancing Beat Hair blowing CAR', end: 14, zeroPad: 4})});
                            this.anims.create({key: 'danceRight', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Dancing Beat Hair blowing CAR', start: 15, end: 29, zeroPad: 4})});
                            this.anims.create({key: 'idle-hold', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Dancing Beat Hair blowing CAR', frames: [10, 11, 12, 25, 26, 27], zeroPad: 4})});
                            this.anims.create({key: 'duck', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Duck', frames: [0, 1, 2, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3], zeroPad: 4})});
                            
                            this.animOffsets.set('danceLeft', [0, 0]);
                            this.animOffsets.set('danceRight', [0, 0]);
                            this.animOffsets.set('idle-hold', [0, 0]);
                            this.animOffsets.set('duck', [0, -100]);
                            break;

                        case 'mom-car':
                            this.camAdd[0] = 100;
                            this.camAdd[1] = -100;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Mom Idle', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Mom Left Pose', end: 9, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'MOM DOWN POSE', end: 14, zeroPad: 4})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Mom Up Pose', end: 14, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Mom Pose Left', end: 9, zeroPad: 4})});

                            this.anims.create({key: 'idle-hold', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Mom Idle', start: 10, end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT-hold', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Mom Left Pose', start: 2, end: 9, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN-hold', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'MOM DOWN POSE', start: 2, end: 14, zeroPad: 4})});
                            this.anims.create({key: 'singUP-hold', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Mom Up Pose', start: 2, end: 14, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT-hold', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Mom Pose Left', start: 2, end: 9, zeroPad: 4})});

                            for (var i=0; i<2; i++)
                            {
                            var postfix = (i == 0 ? '' : '-hold');
                            this.animOffsets.set('idle' + postfix, [0, 0]);
                            this.animOffsets.set('singLEFT' + postfix, [250, -23]);
                            this.animOffsets.set('singDOWN' + postfix, [20, -160]);
                            this.animOffsets.set('singUP' + postfix, [14, 71]);
                            this.animOffsets.set('singRIGHT' + postfix, [10, -60]);
                            }

                            this.icon = 'mom';
                            break;

                        case 'bf-christmas':
                            this.baseY += 350;
                            this.camAdd[0] = -100;
                            this.camAdd[1] = -100;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF idle dance', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE LEFT0', end: 14, zeroPad: 3})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE DOWN0', end: 29, zeroPad: 3})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE UP0', end: 14, zeroPad: 3})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE RIGHT0', end: 61, zeroPad: 3})});
                            this.anims.create({key: 'singLEFTmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE LEFT MISS', end: 33, zeroPad: 4})});
                            this.anims.create({key: 'singDOWNmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE DOWN MISS', end: 28, zeroPad: 4})});
                            this.anims.create({key: 'singUPmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE UP MISS', end: 23, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHTmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE RIGHT MISS', end: 45, zeroPad: 4})});

                            this.animOffsets.set('idle', [-5, 0]);
                            this.animOffsets.set('singLEFT', [12, -6]);
                            this.animOffsets.set('singDOWN', [-10, -50]);
                            this.animOffsets.set('singUP', [-29, 27]);
                            this.animOffsets.set('singRIGHT', [-38, -7]);
                            this.animOffsets.set('singLEFTmiss', [12, 24]);
                            this.animOffsets.set('singDOWNmiss', [-11, -19]);
                            this.animOffsets.set('singUPmiss', [-29, 27]);
                            this.animOffsets.set('singRIGHTmiss', [-30, 21]);

                            this.flipX = true;
                            this.icon = 'bf';
                            break;

                        case 'gf-christmas':
                            this.anims.create({key: 'danceLeft', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Dancing Beat', end: 14, zeroPad: 4})});
                            this.anims.create({key: 'danceRight', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Dancing Beat', start: 15, end: 29, zeroPad: 4})});
                            this.anims.create({key: 'sad', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'gf sad', end: 12, zeroPad: 4})})
                            
                            this.animOffsets.set('danceLeft', [0, -9]);
                            this.animOffsets.set('danceRight', [0, -9]);
                            this.animOffsets.set('sad', [2, -21]);
                            break;

                        case 'parents-christmas':
                            this.baseX -= 200;
                            this.camAdd[0] = 100;
                            this.camAdd[1] = -100;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Parent Christmas Idle', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'idle-hold', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Parent Christmas Idle', start: 10, end: 13, zeroPad: 4})});

                            this.animOffsets.set('idle', [0, 0]);
                            this.animOffsets.set('idle-hold', [0, 0]);

                            for (var i=0; i<2; i++)
                            {
                            var start = 0;
                            if (i > 0)
                                start = 4;

                            var postfix = '';
                            if (i > 0)
                                postfix = '-hold';

                            this.anims.create({key: 'singLEFT' + postfix, repeat: -i, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Parent Left Note Dad', start: start, end: 15, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN' + postfix, repeat: -i, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Parent Down Note Dad', start: start, end: 14, zeroPad: 4})});
                            this.anims.create({key: 'singUP' + postfix, repeat: -i, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Parent Up Note Dad', start: start, end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT' + postfix, repeat: -i, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Parent Right Note Dad', start: start, end: 15, zeroPad: 4})});

                            this.animOffsets.set('singLEFT' + postfix, [-30, 16]);
                            this.animOffsets.set('singDOWN' + postfix, [-31, -29]);
                            this.animOffsets.set('singUP' + postfix, [-47, 24]);
                            this.animOffsets.set('singRIGHT' + postfix, [-1, -23]);

                            this.anims.create({key: 'singLEFT-alt' + postfix, repeat: -i, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Parent Left Note Mom', start: start, end: 14, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN-alt' + postfix, repeat: -i, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Parent Down Note Mom', start: start, end: 14, zeroPad: 4})});
                            this.anims.create({key: 'singUP-alt' + postfix, repeat: -i, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Parent Up Note Mom', start: start, end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT-alt' + postfix, repeat: -i, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Parent Right Note Mom', start: start, end: 14, zeroPad: 4})});

                            this.animOffsets.set('singLEFT-alt' + postfix, [-30, 15]);
                            this.animOffsets.set('singDOWN-alt' + postfix, [-30, -27]);
                            this.animOffsets.set('singUP-alt' + postfix, [-47, 24]);
                            this.animOffsets.set('singRIGHT-alt' + postfix, [-1, -24]);
                            }

                            this.icon = 'parents';
                            break;

                        case 'monster-christmas':
                            this.baseY += 100;
                            this.camAdd[0] += 200;
                            this.camAdd[1] -= 100;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'monster idle', end: 14, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Monster Right note', end: 14, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'monster down', end: 29, zeroPad: 4})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'monster up note', end: 23, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Monster left note', end: 19, zeroPad: 4})});

                            this.animOffsets.set('idle', [0, 0]);
                            this.animOffsets.set('singLEFT', [-51, 0]);
                            this.animOffsets.set('singDOWN', [-40, -94]);
                            this.animOffsets.set('singUP', [-20, 50]);
                            this.animOffsets.set('singRIGHT', [-30, 0]);

                            this.icon = 'monster';
                            break;

                        case 'bf-pixel':
                            this.baseX += 100;
                            this.baseY += 350;
                            this.camAdd[0] = -150;
                            this.camAdd[1] = -100;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF IDLE instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF LEFT NOTE instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF DOWN NOTE instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF UP NOTE instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF RIGHT NOTE instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singLEFTmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF LEFT MISS instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singDOWNmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF DOWN MISS instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singUPmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF UP MISS instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHTmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF RIGHT MISS instance 1', end: 13, zeroPad: 4})});

                            this.animOffsets.set('idle', [0, 0]);
                            this.animOffsets.set('singLEFT', [0, 0]);
                            this.animOffsets.set('singDOWN', [0, 0]);
                            this.animOffsets.set('singUP', [0, 0]);
                            this.animOffsets.set('singRIGHT', [0, 0]);
                            this.animOffsets.set('singLEFTmiss', [0, 0]);
                            this.animOffsets.set('singDOWNmiss', [0, 0]);
                            this.animOffsets.set('singUPmiss', [0, 0]);
                            this.animOffsets.set('singRIGHTmiss', [0, 0]);

                            this.flipX = true;
                            break;

                        case 'gf-pixel':
                            this.anims.create({key: 'danceLeft', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF IDLE instance 1', end: 14, zeroPad: 4})});
                            this.anims.create({key: 'danceRight', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF IDLE instance 1', start: 15, end: 29, zeroPad: 4})});
                            
                            this.animOffsets.set('danceLeft', [0, 0]);
                            this.animOffsets.set('danceRight', [0, 0]);
                            break;

                        case 'senpai':
                            this.baseX -= 150;
                            this.baseY -= 110;
                            this.camAdd[0] = 250;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Senpai Idle instance 1', end: 27, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'SENPAI LEFT NOTE instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'SENPAI DOWN NOTE instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'SENPAI UP NOTE instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'SENPAI RIGHT NOTE instance 1', end: 13, zeroPad: 4})});

                            this.animOffsets.set('idle', [1, 0]);
                            this.animOffsets.set('singLEFT', [40, 0]);
                            this.animOffsets.set('singDOWN', [14, 0]);
                            this.animOffsets.set('singUP', [5, 37]);
                            this.animOffsets.set('singRIGHT', [0, 0]);
                            break;

                        case 'senpai-angry':
                            this.baseX -= 150;
                            this.baseY -= 110;
                            this.camAdd[0] = 250;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Angry Senpai Idle instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Angry Senpai LEFT NOTE instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Angry Senpai DOWN NOTE instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Angry Senpai UP NOTE instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Angry Senpai RIGHT NOTE instance 1', end: 13, zeroPad: 4})});

                            this.animOffsets.set('idle', [1, 0]);
                            this.animOffsets.set('singLEFT', [40, 0]);
                            this.animOffsets.set('singDOWN', [14, 0]);
                            this.animOffsets.set('singUP', [5, 37]);
                            this.animOffsets.set('singRIGHT', [0, 0]);

                            this.icon = 'senpai';
                            break;

                        case 'spirit':
                            this.baseX -= 400;
                            this.baseY -= 250;
                            this.camAdd[0] = 500;
                            this.camAdd[1] = 100;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'idle spirit_', end: 19, zeroPad: 0})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'left_', end: 19, zeroPad: 0})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'spirit down_', end: 19, zeroPad: 0})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'up_', end: 19, zeroPad: 0})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'right_', end: 19, zeroPad: 0})});

                            this.animOffsets.set('idle', [-220, -280]);
                            this.animOffsets.set('singLEFT', [-200, -280]);
                            this.animOffsets.set('singDOWN', [170, 110]);
                            this.animOffsets.set('singUP', [-220, -240]);
                            this.animOffsets.set('singRIGHT', [-220, -280]);
                            break;

                        case 'bf-holding-gf':
                            this.baseY += 350;
                            this.camAdd[0] = -200;
                            this.camAdd[1] = -175;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF idle dance w gf', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE LEFT0', end: 14, zeroPad: 3})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE DOWN0', end: 29, zeroPad: 3})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE UP0', end: 14, zeroPad: 3})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE RIGHT0', end: 61, zeroPad: 3})});
                            this.anims.create({key: 'singLEFTmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE LEFT MISS', end: 33, zeroPad: 4})});
                            this.anims.create({key: 'singDOWNmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE DOWN MISS', end: 28, zeroPad: 4})});
                            this.anims.create({key: 'singUPmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE UP MISS', end: 23, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHTmiss', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE RIGHT MISS', end: 45, zeroPad: 4})});
                            this.anims.create({key: 'bfCatch', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'BF NOTE RIGHT MISS', end: 45, zeroPad: 4})});

                            this.animOffsets.set('idle', [0, 0]);
                            this.animOffsets.set('singLEFT', [12, 7]);
                            this.animOffsets.set('singDOWN', [-10, -10]);
                            this.animOffsets.set('singUP', [-29, 10]);
                            this.animOffsets.set('singRIGHT', [-41, 23]);
                            this.animOffsets.set('singLEFTmiss', [12, 7]);
                            this.animOffsets.set('singDOWNmiss', [-10, -10]);
                            this.animOffsets.set('singUPmiss', [-29, 10]);
                            this.animOffsets.set('singRIGHTmiss', [-41, 23]);
                            this.animOffsets.set('bfCatch', [0, 0]);

                            this.flipX = true;
                            this.icon = 'bf';
                            break;

                        case 'gf-tankmen':
                            this.anims.create({key: 'danceLeft', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Dancing at Gunpoint', end: 14, zeroPad: 4})});
                            this.anims.create({key: 'danceRight', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Dancing at Gunpoint', start: 15, end: 29, zeroPad: 4})});
                            this.anims.create({key: 'sad', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'GF Crying at Gunpoint ', end: 12, zeroPad: 4})})
                            
                            this.animOffsets.set('danceLeft', [0, -9]);
                            this.animOffsets.set('danceRight', [0, -9]);
                            this.animOffsets.set('sad', [2, -21]);
                            break;

                        case 'pico-speaker':
                            this.baseX += 125;
                            this.baseY -= 100;

                            this.anims.create({key: 'idle', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico shoot 1', start: 17, end: 25, zeroPad: 4})});

                            this.anims.create({key: 'shoot1', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico shoot 1', end: 25, zeroPad: 4})});
                            this.anims.create({key: 'shoot2', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico shoot 2', end: 59, zeroPad: 4})});
                            this.anims.create({key: 'shoot3', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico shoot 3', end: 52, zeroPad: 4})});
                            this.anims.create({key: 'shoot4', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico shoot 4',  end: 52, zeroPad: 4})});

                            this.anims.create({key: 'shoot1-hold', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico shoot 1', start: 22, end: 25, zeroPad: 4})});
                            this.anims.create({key: 'shoot2-hold', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico shoot 2', start: 56, end: 59, zeroPad: 4})});
                            this.anims.create({key: 'shoot3-hold', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico shoot 3', start: 49, end: 52, zeroPad: 4})});
                            this.anims.create({key: 'shoot4-hold', repeat: -1, frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico shoot 4', start: 49, end: 52, zeroPad: 4})});

                            this.animOffsets.set('idle', [0, 0]);

                            this.animOffsets.set('shoot1', [0, 0]);
                            this.animOffsets.set('shoot2', [-1, -128]);
                            this.animOffsets.set('shoot3', [412, -64]);
                            this.animOffsets.set('shoot4', [439, -19]);

                            this.animOffsets.set('shoot1-hold', [0, 0]);
                            this.animOffsets.set('shoot2-hold', [-1, -128]);
                            this.animOffsets.set('shoot3-hold', [412, -64]);
                            this.animOffsets.set('shoot4-hold', [439, -19]);

                            this.playAnim('idle');
                            break;

                        case 'tankman':
                            this.baseY += 185;
                            this.camAdd[0] += 150;
                            this.camAdd[1] -= 50;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Tankman Idle Dance instance 1', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Tankman Note Left instance 1', end: 7, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Tankman DOWN note instance 1', end: 9, zeroPad: 4})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Tankman UP note instance 1', end: 9, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Tankman Right Note instance 1', end: 9, zeroPad: 4})});
                            this.anims.create({key: 'hehPrettyGood', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'PRETTY GOOD tankman instance 1', end: 61, zeroPad: 4})});
                            this.anims.create({key: 'ugh', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'TANKMAN UGH instance 1', end: 15, zeroPad: 4})});

                            this.animOffsets.set('idle', [0, 0]);
                            this.animOffsets.set('singRIGHT', [-22, -28]);
                            this.animOffsets.set('singDOWN', [63, -105]);
                            this.animOffsets.set('singUP', [48, 54]);
                            this.animOffsets.set('singLEFT', [90, -13]);
                            this.animOffsets.set('hehPrettyGood', [-2, 15]);
                            this.animOffsets.set('ugh', [-16, -9]);
                            break;

                        case 'pico-playable':
                            this.baseY += 315;
                            this.camAdd[0] -= 425;
                            this.camAdd[1] -= 100;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico Idle Dance', end: 13, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico NOTE LEFT0', end: 16, zeroPad: 3})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico Down Note0', end: 10, zeroPad: 3})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'pico Up note0', end: 13, zeroPad: 3})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pico Note Right0', end: 16, zeroPad: 3})});

                            this.animOffsets.set('idle', [0, 0]);
                            this.animOffsets.set('singLEFT', [84, -11]);
                            this.animOffsets.set('singDOWN', [84, -77]);
                            this.animOffsets.set('singUP', [21, 28]);
                            this.animOffsets.set('singRIGHT', [-50, 1]);

                            this.flipX = true;
                            this.icon = 'pico';
                            break;

                        case 'nene':
                            this.camAdd[0] = 100;
                            this.camAdd[1] = 300;

                            this.anims.create({key: 'danceLeft', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Nene Idle', end: 14, zeroPad: 4})});
                            this.anims.create({key: 'danceRight', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Nene Idle', start: 15, end: 29, zeroPad: 4})});
                            this.anims.create({key: 'combo50', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'combo celebration 1 nene', end: 24, zeroPad: 4})});
                            this.anims.create({key: 'combo100', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'fawn nene', frames: [0, 1, 2, 3, 4, 5, 6, 4, 5, 6, 4, 5, 6, 4, 5, 6], zeroPad: 4})});
                            this.anims.create({key: 'drop70', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'laughing nene', frames: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 6, 7, 8, 9, 10, 11, 6, 7, 8, 9, 10, 11], zeroPad: 4})});
                            this.anims.create({key: 'laughCutscene', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'laughing nene', frames: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 7, 8, 9, 10, 11, 7, 8, 9, 10, 11, 7, 8, 9, 10, 11, 7, 8, 9, 10, 11, 7, 8, 9, 10, 11], zeroPad: 4})});
                            this.anims.create({key: 'raiseKnife', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'knife raise', end: 19, zeroPad: 4})});
                            this.anims.create({key: 'idleKnife', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'knife high held', end: 9, zeroPad: 4})});
                            this.anims.create({key: 'lowerKnife', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'knife lower', end: 1, zeroPad: 4})});
                            
                            this.animOffsets.set('danceLeft', [0, 0]);
                            this.animOffsets.set('danceRight', [0, 0]);

                            this.animOffsets.set('combo50', [0, 0]);
                            this.animOffsets.set('combo100', [0, 0]);
                            this.animOffsets.set('drop70', [0, 0]);
                            this.animOffsets.set('laughCutscene', [0, 0]);

                            this.animOffsets.set('raiseKnife', [0, 52]);
                            this.animOffsets.set('idleKnife', [-99, 52]);
                            this.animOffsets.set('lowerKnife', [135, 52]);
                            break;

                        case 'darnell':
                            this.baseY += 250;
                            this.camAdd[0] += 450;

                            this.anims.create({key: 'idle', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Idle', end: 28, zeroPad: 4})});
                            this.anims.create({key: 'singLEFT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pose Left', end: 12, zeroPad: 4})});
                            this.anims.create({key: 'singDOWN', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pose Down', end: 12, zeroPad: 4})});
                            this.anims.create({key: 'singUP', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pose Up', end: 12, zeroPad: 4})});
                            this.anims.create({key: 'singRIGHT', frameRate: 24, frames: this.anims.generateFrameNames(characterFrame, {prefix: 'Pose Right', end: 12, zeroPad: 4})});

                            this.animOffsets.set('idle', [0, 0]);
                            this.animOffsets.set('singLEFT', [1, 0]);
                            this.animOffsets.set('singDOWN', [0, -3]);
                            this.animOffsets.set('singUP', [8, 5]);
                            this.animOffsets.set('singRIGHT', [4, 3]);
                            break;
                    }

                    this.x = this.baseX;
                    this.y = this.baseY;

                    this.danceTimer = 1;
                    this.dance();

                    if (this.isPlayer)
                        this.flipX = !this.flipX;
                }

                initFollow()
                {
                    this.camFollow = [this.getCenter().x+this.camAdd[0], this.getCenter().y+this.camAdd[1]];
                }

                update(elapsed)
                {
                    if (this.anims.getName().startsWith('sing'))
                        this.holdTimer += elapsed / 1.25;
                    else if (this.isPlayer)
                        this.holdTimer = 0;

                    if (!this.isPlayer && this.canIdle)
                    {
                        if (this.holdTimer >= (Conductor.instance.getBeatLengthMs() / 4) * 4 * 0.001)
                        {
                            this.dance();
                            this.holdTimer = 0;
                        }
                    }

                    switch (this.curCharacter)
                    {
                        case "pico-speaker":
                            if (this.animationNotes.length > 0)
                            {
                                if (Conductor.instance.lastTime > this.animationNotes[0][0])
                                {
                                    var shootAnim = ((this.animationNotes[0][1] >= 2) ? 3 : 1) + Math.floor(Math.random());
                                    this.playAnim('shoot' + shootAnim);
                                    this.animationNotes.shift();
                                }
                            }
                        break;
                    }
                }

                dance(force = false)
                {
                    if (!this.specialAnim && this.curCharacter != 'pico-speaker')
                    {
                        if (this.curCharacter == 'nene' && this.knifeRaised)
                            this.playAnim('idleKnife');
                        else
                        {
                            if (this.anims.exists('danceLeft') && this.anims.exists('danceRight'))
                            {
                                this.danceRight = !this.danceRight;
                                this.playAnim('dance' + (this.danceRight ? 'Right' : 'Left'));
                            }
                            else if (Conductor.instance.lastBeat % 2 == 0 || force)
                            this.playAnim('idle');
                        }
                    }
                }

                playAnim(name)
                {
                    if (!this.anims.exists(name))
                        return;

                    this.anims.play(name);
                    
                    if (this.animOffsets.has(name))
                        this.setPosition(this.baseX - this.animOffsets.get(name)[0], this.baseY - this.animOffsets.get(name)[1]);
                    else
                        this.setPosition(this.baseX, this.baseY);

                    if (this.curCharacter == 'gf')
                    {
                        if (name == 'singLEFT')
                            this.danceRight = true;
                        else if (name == 'singRIGHT')
                            this.danceRight = false;
                        else if (name == 'singUP' || name == 'singDOWN')
                            this.danceRight = !this.danceRight;
                    }

                    var script = this;
                    this.on('animationcomplete', script.animCallback);
                }

                animCallback()
                {
                    if (this.isPlayer)
                    {
                        if (this.anims.getName().endsWith('miss'))
                            this.playAnim('idle');

                        if (this.anims.getName() == 'firstDeath' && this.startedDeath)
                            this.playAnim('deathLoop');
                    }

                    if (this.curCharacter == 'gf' && this.anims.getName() == 'hairFall')
                        this.playAnim('danceRight');

                    if (this.specialAnim)
                        this.specialAnim = false;

                    if (this.anims.exists(this.anims.getName() + '-hold'))
                        this.playAnim(this.anims.getName() + '-hold');
                }
            }

            class CountdownStep
            {
                static BEFORE = 'CD_TICK_BEFORE';
                static THREE = 'CD_TICK_THREE';
                static TWO = 'CD_TICK_TWO';
                static ONE = 'CD_TICK_ONE';
                static GO = 'CD_TICK_GO';
                static AFTER = 'CD_TICK_AFTER';
            }

            class Countdown
            {
                tick;
                timer = 0;

                performing = false;
                paused = false;

                sounds = [];
                sprites = [];

                follow = null;

                constructor(scene) { this.follow = scene; }

                static precache(scene)
                {
                    scene.load.image('CD_TICK_TWO', 'https://codehs.com/uploads/da6399373e510097e8f1c721291bd35a');
                    scene.load.image('CD_TICK_ONE', 'https://codehs.com/uploads/4785c229bdc1f41b4c01d06c05076c31');
                    scene.load.image('CD_TICK_GO', 'https://codehs.com/uploads/d30486062ee76d03c7ff74c644aed4b4');

                    scene.load.audio('CD_TICK_THREE', ['https://codehs.com/uploads/abcc8176fbb24b4acbefc42b855472f6?.ogg']);
                    scene.load.audio('CD_TICK_TWO', ['https://codehs.com/uploads/fb17cd9acef339a1fb305b292f667e4c?.ogg']);
                    scene.load.audio('CD_TICK_ONE', ['https://codehs.com/uploads/70826d0d10ef3ae1ee9e0dedc1587def?.ogg']);
                    scene.load.audio('CD_TICK_GO', ['https://codehs.com/uploads/8b934bec4ba067afc896da066e6787e7?.ogg']);

                    scene.load.image('CD_TICK_TWO_PIXEL', 'https://codehs.com/uploads/e8dcd32bea1f677854673cd8565cef4c');
                    scene.load.image('CD_TICK_ONE_PIXEL', 'https://codehs.com/uploads/736298dd1a4c2934abe6e898388098a3');
                    scene.load.image('CD_TICK_GO_PIXEL', 'https://codehs.com/uploads/d08ee10c53f10c04797aa7851825e0fa');

                    scene.load.audio('CD_TICK_THREE_PIXEL', ['https://codehs.com/uploads/079546cc161ce7e43d35d1e58b04dfd9?.ogg']);
                    scene.load.audio('CD_TICK_TWO_PIXEL', ['https://codehs.com/uploads/12db3d5f1b0001d2b169a67932c5c0c9?.ogg']);
                    scene.load.audio('CD_TICK_ONE_PIXEL', ['https://codehs.com/uploads/360af25b5db686a17855a4b0ce245964?.ogg']);
                    scene.load.audio('CD_TICK_GO_PIXEL', ['https://codehs.com/uploads/fb30be919ccd655458b0d52764439a85?.ogg']);
                }

                update(elapsed = 1 / 60)
                {
                    for (var sound of this.sounds)
                    {
                        if (sound != null)
                        {
                            if (this.paused && sound.isPlaying && !sound.isPaused) sound.pause();
                            else if (!this.paused && sound.isPaused) sound.resume();
                        }
                    }

                    if (!this.performing || this.paused || this.timer <= 0)
                        return;

                    if (elapsed == null) elapsed = 1 / 60;

                    this.timer -= elapsed;

                    if (this.timer <= 0)
                    {
                        this.tick = this.decrement(this.tick);
                        this.hitCountdown();
                    }
                }

                start()
                {
                    this.performing = true;
                    this.paused = false;
                    this.tick = CountdownStep.BEFORE;
                    this.hitCountdown();
                }

                end()
                {
                    this.performing = false;
                    this.paused = false;
                    this.tick = CountdownStep.AFTER;
                    this.timer = 0;

                    while (this.sounds.length > 0)
                        this.sounds.shift().stop();
                }

                hitCountdown()
                {
                    if (this.tick == CountdownStep.AFTER)
                    {
                        this.end();
                        return;
                    }

                    this.timer = (Conductor.instance.getBeatLengthMs() / 1000) ?? 0;

                    if (this.follow != null)
                    {
                        if (this.tick == CountdownStep.THREE || this.tick == CountdownStep.TWO || this.tick == CountdownStep.ONE || this.tick == CountdownStep.GO)
                        {
                            var sound = this.follow.sound.add(this.tick + (this.getIsPixel() ? '_PIXEL' : ''), {volume: 1, loop: false});
                            sound.play();

                            this.sounds.push(sound);
                        }

                        if (this.tick == CountdownStep.TWO || this.tick == CountdownStep.ONE || this.tick == CountdownStep.GO)
                        {
                            var sprite = this.follow.createImage(this.tick + (this.getIsPixel() ? '_PIXEL' : ''), 0, 0);
                            sprite.scrollFactorX = sprite.scrollFactorY = 0;
                            this.follow.screenCenter(sprite);
                            this.follow.add.existing(sprite);
                            this.follow.addToCameras(sprite, [this.follow.cameras.main]);

                            var script = this;
                            script.follow.tweens.add
                            ({
                                targets: sprite,
                                y: sprite.y + 100,
                                alpha: 0,
                                ease: Phaser.Math.Easing.Cubic.InOut,
                                duration: Conductor.instance != null ? Conductor.instance.getBeatLengthMs() ?? 0 : 0,
                                onComplete: function() { sprite.destroy(); }
                            });

                            this.sprites.push(sprite);
                        }
                    }
                }

                decrement(step)
                {
                    switch (step)
                    {
                        case CountdownStep.BEFORE:      return CountdownStep.THREE;
                        case CountdownStep.THREE:         return CountdownStep.TWO;
                        case CountdownStep.TWO:           return CountdownStep.ONE;
                        case CountdownStep.ONE:            return CountdownStep.GO;
                        case CountdownStep.GO:          return CountdownStep.AFTER;
                        default:                        return CountdownStep.AFTER;
                    }
                }

                getIsPixel() { return (PlayState.instance != null && PlayState.instance.pixelUI); }
            }

            class DeathType
            {
                static DEFAULT = 'DEATH_DEFAULT';
                static PIXEL = 'DEATH_PIXEL';
                static PICO = 'DEATH_PICO';
            }

            class GameOverState extends MusicBeatState
            {
                static deathType = DeathType.DEFAULT;
            
                preload()
                {
                    super.preload();

                    if (GameOverState.deathType == DeathType.DEFAULT)
                    {
                        this.load.audio('loss-sfx', ['https://codehs.com/uploads/1eb27edbb7d805dd2b69dc416e41d170?.ogg']);
                        this.load.audio('gameover', ['https://codehs.com/uploads/dbb0a9615a388b9b4c14fafef803ad9c?.ogg']);
                        this.load.audio('gameover-end', ['https://codehs.com/uploads/a82d0d4454950aa6f3cff93f2911e06d?.ogg']);
                    }
                    else if (GameOverState.deathType == DeathType.PIXEL)
                    {
                        this.load.audio('loss-sfx', ['https://codehs.com/uploads/d02b4504e78a77234a4e45f566dc67a3?.ogg']);
                        this.load.audio('gameover', ['https://codehs.com/uploads/eec16dc28b829f7a54adafeff0c74380?.ogg']);
                        this.load.audio('gameover-end', ['https://codehs.com/uploads/7b41a412ed83069d3f2b18510e36bd0b?.ogg']);
                    }
                    else if (GameOverState.deathType == DeathType.PICO)
                    {
                        this.load.audio('loss-sfx', ['https://codehs.com/uploads/a07faf6147d2a285779540915232fa2c?.ogg']);
                        this.load.audio('gameover', ['https://codehs.com/uploads/dbb0a9615a388b9b4c14fafef803ad9c?.ogg']);
                        this.load.audio('gameover-end', ['https://codehs.com/uploads/b338655cb93a3b549f453df89a23ac4d?.ogg']);
                    }
                    
                    Character.precache(this);
                }

                plrDead;

                camX = 0;
                camY = 0;

                startedMusic = false;
                music;
                leaving = false;

                create()
                {
                    super.create();

                    var playerPos = PlayState.instance.playerPos;
                    this.plrDead = new Character(this, playerPos[0], playerPos[1], 'bf', true);
                    this.plrDead.initFollow();
                    this.plrDead.startedDeath = true;
                    this.plrDead.playAnim('firstDeath');
                    this.add.existing(this.plrDead);

                    this.sound.add('loss-sfx', {volume: 1, loop: false}).play();

                    this.camX = PlayState.instance.camFollow.lerpX;
                    this.camY = PlayState.instance.camFollow.lerpY;
                    this.cameras.main.zoom = PlayState.instance.defaultZoom;
                }

                update(time)
                {
                    super.update(time);

                    var lerp = Constants.DEFAULT_CAMERA_FOLLOW_RATE;
                    this.camX = TSMath.baseLerp(this.camX, this.plrDead.camFollow[0], lerp);
                    this.camY = TSMath.baseLerp(this.camY, this.plrDead.camFollow[1], lerp);
                    this.cameras.main.centerOn(this.camX, this.camY);

                    for (var key of Controls.list.get('accept'))
                        if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                            this.accept();

                    if (!this.leaving)
                    {
                        if (this.plrDead.anims.getName() == 'deathLoop' && !this.startedMusic)
                        {
                            this.startedMusic = true;
                            this.music = this.sound.add('gameover', {volume: 1, loop: true});
                            this.music.play();
                        }
                    }
                }

                accept()
                {
                    if (this.leaving) return;
                    
                    this.leaving = true;
                    this.plrDead.playAnim('deathConfirm');

                    if (this.music != null) this.music.stop();
                    this.sound.add('gameover-end', {volume: 1, loop: false}).play();

                    var script = this;
                    script.time.addEvent
                    ({
                        delay: 700,
                        callback: function()
                        {
                            script.cameras.main.fade(2000, 0, 0, 0);

                            script.time.addEvent
                            ({
                            delay: 2000,
                            callback: function()
                            {
                                script.switchState("PlayState", PlayState);
                            }
                            })
                        }
                    })
                }
            }

            class ResultsState extends MusicBeatState
            {
                preload()
                {
                    super.preload();
                }

                create()
                {
                    super.create();

                    this.switchState("MainMenuState", MainMenuState);
                }
            }

            class ScoringSystem
            {
                static LEGACY = 'SCORING_LEGACY';
                static WEEK7 = 'SCORING_WEEK7';
                static PBOT1 = 'SCORING_PBOT1';
            }

            class Scoring
            {
                static scoreNote(msTiming, scoringSystem = ScoringSystem.PBOT1)
                {
                    switch (scoringSystem)
                    {
                    case ScoringSystem.LEGACY: return Scoring.scoreNoteLEGACY(msTiming);
                    case ScoringSystem.WEEK7: return Scoring.scoreNoteWEEK7(msTiming);
                    case ScoringSystem.PBOT1: return Scoring.scoreNotePBOT1(msTiming);
                    default: return 0;
                    }
                }

                static judgeNote(msTiming, scoringSystem = ScoringSystem.PBOT1)
                {
                    switch (scoringSystem)
                    {
                    case ScoringSystem.LEGACY: return Scoring.judgeNoteLEGACY(msTiming);
                    case ScoringSystem.WEEK7: return Scoring.judgeNoteWEEK7(msTiming);
                    case ScoringSystem.PBOT1: return Scoring.judgeNotePBOT1(msTiming);
                    default: return '';
                    }
                }

                static PBOT1_MAX_SCORE = 500;
                static PBOT1_SCORING_OFFSET = 54.99;
                static PBOT1_SCORING_SLOPE = 0.080;
                static PBOT1_MIN_SCORE = 9.0;
                static PBOT1_MISS_SCORE = 0;
                static PBOT1_PERFECT_THRESHOLD = 5.0;
                static PBOT1_MISS_THRESHOLD = 160.0;
                static PBOT1_SICK_THRESHOLD = 45.0;
                static PBOT1_GOOD_THRESHOLD = 90.0;
                static PBOT1_BAD_THRESHOLD = 135.0;
                static PBOT1_SHIT_THRESHOLD = 160.0;

                static scoreNotePBOT1(msTiming)
                {
                    var absTiming = Math.abs(msTiming);

                    if (absTiming > Scoring.PBOT1_MISS_THRESHOLD) return Scoring.PBOT1_MISS_SCORE;
                    else if (absTiming < Scoring.PBOT1_PERFECT_THRESHOLD) return Scoring.PBOT1_MAX_SCORE;
                    else
                    {
                    var factor = 1.0 - (1.0 / (1.0 + Math.exp(-Scoring.PBOT1_SCORING_SLOPE * (absTiming - Scoring.PBOT1_SCORING_OFFSET))));
                    return Math.floor(Scoring.PBOT1_MAX_SCORE * factor + Scoring.PBOT1_MIN_SCORE);
                    }
                }

                static judgeNotePBOT1(msTiming)
                {
                    var absTiming = Math.abs(msTiming);

                    if (absTiming < Scoring.PBOT1_SICK_THRESHOLD) return 'sick';
                    else if (absTiming < Scoring.PBOT1_GOOD_THRESHOLD) return 'good';
                    else if (absTiming < Scoring.PBOT1_BAD_THRESHOLD) return 'bad';
                    else if (absTiming < Scoring.PBOT1_SHIT_THRESHOLD) return 'shit';
                    else return 'miss';
                }

                static LEGACY_HIT_WINDOW = (10 / 60) * 1000;
                static LEGACY_SICK_THRESHOLD = 0.2;
                static LEGACY_GOOD_THRESHOLD = 0.75;
                static LEGACY_BAD_THRESHOLD = 0.9;
                static LEGACY_SHIT_THRESHOLD = 1.0;

                static LEGACY_SICK_SCORE = 350;
                static LEGACY_GOOD_SCORE = 200;
                static LEGACY_BAD_SCORE = 100;
                static LEGACY_SHIT_SCORE = 50;

                static scoreNoteLEGACY(msTiming)
                {
                    var absTiming = Math.abs(msTiming);

                    if (absTiming < Scoring.LEGACY_HIT_WINDOW * Scoring.LEGACY_SICK_THRESHOLD) return Scoring.LEGACY_SICK_SCORE;
                    else if (absTiming < Scoring.LEGACY_HIT_WINDOW * Scoring.LEGACY_GOOD_THRESHOLD) return Scoring.LEGACY_GOOD_SCORE;
                    else if (absTiming < Scoring.LEGACY_HIT_WINDOW * Scoring.LEGACY_BAD_THRESHOLD) return Scoring.LEGACY_BAD_SCORE;
                    else if (absTiming < Scoring.LEGACY_HIT_WINDOW * Scoring.LEGACY_SHIT_THRESHOLD) return Scoring.LEGACY_SHIT_SCORE;
                    else return 0;
                }

                static judgeNoteLEGACY(msTiming)
                {
                    var absTiming = Math.abs(msTiming);

                    if (absTiming < Scoring.LEGACY_HIT_WINDOW * Scoring.LEGACY_SICK_THRESHOLD) return 'shit';
                    else if (absTiming < Scoring.LEGACY_HIT_WINDOW * Scoring.LEGACY_GOOD_THRESHOLD) return 'good';
                    else if (absTiming < Scoring.LEGACY_HIT_WINDOW * Scoring.LEGACY_BAD_THRESHOLD) return 'bad';
                    else if (absTiming < Scoring.LEGACY_HIT_WINDOW * Scoring.LEGACY_SHIT_THRESHOLD) return 'shit';
                    else return 'miss';
                }

                static WEEK7_HIT_WINDOW = Scoring.LEGACY_HIT_WINDOW;

                static WEEK7_BAD_THRESHOLD = 0.8;
                static WEEK7_GOOD_THRESHOLD = 0.55;
                static WEEK7_SICK_THRESHOLD = 0.2;
                static WEEK7_SHIT_SCORE = 50;
                static WEEK7_BAD_SCORE = 100;
                static WEEK7_GOOD_SCORE = 200;
                static WEEK7_SICK_SCORE = 350;

                static scoreNoteWEEK7(msTiming)
                {
                    var absTiming = Math.abs(msTiming);

                    if (absTiming < Scoring.WEEK7_HIT_WINDOW * Scoring.WEEK7_SICK_THRESHOLD) return Scoring.WEEK7_SICK_SCORE;
                    else if (absTiming < Scoring.WEEK7_HIT_WINDOW * Scoring.WEEK7_GOOD_THRESHOLD) return Scoring.WEEK7_GOOD_SCORE;
                    else if (absTiming < Scoring.WEEK7_HIT_WINDOW * Scoring.WEEK7_BAD_THRESHOLD) return Scoring.WEEK7_BAD_SCORE;
                    else if (absTiming < Scoring.WEEK7_HIT_WINDOW) return Scoring.WEEK7_SHIT_SCORE;
                    else return 0;
                }

                static judgeNoteWEEK7(msTiming)
                {
                    var absTiming = Math.abs(msTiming);

                    if (absTiming < Scoring.WEEK7_HIT_WINDOW * Scoring.WEEK7_SICK_THRESHOLD) return 'sick';
                    else if (absTiming < Scoring.WEEK7_HIT_WINDOW * Scoring.WEEK7_GOOD_THRESHOLD) return 'good';
                    else if (absTiming < Scoring.WEEK7_HIT_WINDOW * Scoring.WEEK7_BAD_THRESHOLD) return 'bad';
                    else if (absTiming < Scoring.WEEK7_HIT_WINDOW) return 'shit';
                    else return 'miss';
                }
            }

            class PlayStatePlaylist
            {
                isStoryMode;
                songs = [];
                difficulty;

                constructor(isStoryMode = false, songs = [], difficulty = Constants.DEFAULT_DIFFICULTY)
                {
                    this.isStoryMode = isStoryMode ?? false;
                    this.songs = songs ?? [];
                    this.difficulty = difficulty ?? Constants.DEFAULT_DIFFICULTY;
                }
            }

            class PrepPlayState extends MusicBeatState
            {
                create()
                {
                    var script = this;
                    this.time.addEvent
                    ({
                        delay: 100,
                        callback: function()
                        {
                            script.switchState("PlayState", PlayState);
                        }
                    })
                }
            }

            class HealthBar
            {
                static precache(scene)
                {
                    scene.load.image('healthBar', 'https://codehs.com/uploads/6234c1658138a5c67c6e6a31b8fc516b');
                }

                x = 0;
                y = 0;

                barBack;
                barLeft;
                barRight;
                percent = 0;

                healthMax = 2;
                health = 1;

                constructor(scene, x = 0, y = 0)
                {
                    if (scene == null) return;

                    this.barBack = scene.createImage('healthBar', 0, 0);
                    this.barRight = scene.createRect(0, 0, this.barBack.width-8, this.barBack.height-8, 0xff66ff33, 1);
                    this.barLeft = scene.createRect(0, 0, this.barBack.width-8, this.barBack.height-8, 0xffff0000, 1);

                    this.setPosition(x, y);
                }

                update()
                {
                    if (this.health < 0) this.health = 0;
                    else if (this.health > this.healthMax) this.health = this.healthMax;

                    this.percent = ((this.healthMax - this.health) / this.healthMax) * 100;
                    if (this.barLeft != null)
                    this.barLeft.scaleX = this.percent / 100;

                    this.updatePosition();
                }

                draw(scene)
                {
                    if (this.barBack != null) scene.add.existing(this.barBack);
                    if (this.barRight != null) scene.add.existing(this.barRight);
                    if (this.barLeft != null) scene.add.existing(this.barLeft);
                }

                setX(val = 0)
                {
                    this.x = val;
                    this.updatePosition();
                }

                setY(val = 0)
                {
                    this.y = val;
                    this.updatePosition();
                }

                setPosition(x = 0, y = 0)
                {
                    this.x = x;
                    this.y = y;
                    this.updatePosition();
                }

                updatePosition()
                {
                    if (this.barBack != null) this.barBack.setPosition(this.x, this.y);
                    if (this.barLeft != null) this.barLeft.setPosition(this.x + 4, this.y + 4);
                    if (this.barRight != null) this.barRight.setPosition(this.x + 4, this.y + 4);
                }

                setToCams(scene, cams = [])
                {
                    if (this.barBack != null) scene.addToCameras(this.barBack, cams);
                    if (this.barLeft != null) scene.addToCameras(this.barLeft, cams);
                    if (this.barRight != null) scene.addToCameras(this.barRight, cams);
                }

                setVisible(val = false)
                {
                    if (this.barBack != null) this.barBack.visible = val ?? false;
                    if (this.barLeft != null) this.barLeft.visible = val ?? false;
                    if (this.barRight != null) this.barRight.visible = val ?? false;
                }

                setAlpha(val = 1)
                {
                    if (this.barBack != null) this.barBack.alpha = val ?? 1;
                    if (this.barLeft != null) this.barLeft.alpha = val ?? 1;
                    if (this.barRight != null) this.barRight.alpha = val ?? 1;
                }
            }

            class HealthIcon extends Phaser.GameObjects.Sprite
            {
                static POSITION_OFFSET = 26;

                static precache(scene)
                {
                    for (var icon of HealthIconRegistry.icons)
                    {
                        if (icon != null)
                        {
                            if (icon.name != null && icon.name.length > 0)
                                if (icon.png != null && icon.png.length > 0)
                                    scene.load.spritesheet('icon-' + icon.name, icon.png + '?.png', {frameWidth: 150, frameHeight: 150});
                        }
                    }
                }

                curCharacter;

                constructor(scene, character = Constants.DEFAULT_HEALTH_ICON)
                { 
                    var iconFrame = character ?? Constants.DEFAULT_HEALTH_ICON;
                    var foundIcon = false;
                    for (var icon of HealthIconRegistry.icons)
                        if (icon != null)
                            if (icon.name == iconFrame)
                                foundIcon = true;

                    super(scene, 0, 0, 'icon-' + (foundIcon ? iconFrame : Constants.DEFAULT_HEALTH_ICON));
                    this.setup(iconFrame);
                }

                setup(character)
                {
                    this.curCharacter = character;
                    this.setOrigin(0, 0);

                    this.anims.remove('normal');
                    this.anims.remove('dead');

                    this.anims.create({key: "normal", frameRate: 0, frames: this.anims.generateFrameNumbers("icon-" + character, {start: 0, end: 0})});
                    this.anims.create({key: "dead", frameRate: 0, frames: this.anims.generateFrameNumbers("icon-" + character, {start: 1, end: 1})});

                    this.anims.play('normal');
                }
            }

            class PauseUI
            {
                static precache(scene)
                {
                    scene.load.image('desatBG', "https://codehs.com/uploads/17c518129e9a4f26524bf25c3a201036");
                    AtlasText.precache(scene);
                }

                scene;
                cameras = [];
                isOpen;

                background;
                options = [];
                curSelected = 0;

                metadataStatus = [];
                metadata = [];
                tweens = [];

                constructor(scene, cameras = [])
                {
                    this.scene = scene;
                    this.cameras = cameras ?? [];

                    this.background = this.scene.createImage('desatBG', 0, 0);
                    this.background.setTint(0x99000000);
                    this.background.alpha = 0.6;
                    this.scene.add.existing(this.background);
                    this.scene.addToCameras(this.background, this.cameras);

                    var nextY = 20;

                    this.metadataStatus = this.scene.createText(20, nextY, PlayState.playlist.isStoryMode ? 'Story Mode' : 'Freeplay', 32, 'Vcr', '#ffffff', '#000000', 0, 'right');
                    this.scene.add.existing(this.metadataStatus);
                    this.scene.addToCameras(this.metadataStatus, this.cameras);

                    var metadataSong = this.scene.createText(this.scene.getWidth() - 20, nextY, this.scene.chart.getName(), 32, 'Vcr', '#ffffff', '#000000', 0, 'right');
                    metadataSong.x -= metadataSong.width;
                    this.scene.add.existing(metadataSong);
                    this.scene.addToCameras(metadataSong, this.cameras);
                    this.metadata.push(metadataSong);

                    nextY = metadataSong.y + 32;

                    var songArtist = this.scene.chart.getArtist();
                    if (songArtist != null && songArtist.length > 0)
                    {
                        var metadataArtist = this.scene.createText(this.scene.getWidth() - 20, nextY, 'Artist: ' + songArtist, 32, 'Vcr', '#ffffff', '#000000', 0, 'right');
                        metadataArtist.x -= metadataArtist.width;
                        this.scene.add.existing(metadataArtist);
                        this.scene.addToCameras(metadataArtist, this.cameras);
                        this.metadata.push(metadataArtist);

                        nextY = metadataArtist.y + 32;
                    }

                    var songCharter = this.scene.chart.getCharter();
                    if (songCharter != null && songCharter.length > 0)
                    {
                        var metadataCharter = this.scene.createText(this.scene.getWidth() - 20, nextY, 'Charter: ' + songCharter, 32, 'Vcr', '#ffffff', '#000000', 0, 'right');
                        metadataCharter.x -= metadataCharter.width;
                        this.scene.add.existing(metadataCharter);
                        this.scene.addToCameras(metadataCharter, this.cameras);
                        this.metadata.push(metadataCharter);

                        nextY = metadataCharter.y + 32;
                    }

                    var metadataDifficulty = this.scene.createText(this.scene.getWidth() - 20, nextY, 'Difficulty: ' + this.scene.chart.difficulty.toUpperCase(), 32, 'Vcr', '#ffffff', '#000000', 0, 'right');
                    metadataDifficulty.x -= metadataDifficulty.width;
                    this.scene.add.existing(metadataDifficulty);
                    this.scene.addToCameras(metadataDifficulty, this.cameras);
                    this.metadata.push(metadataDifficulty);

                    nextY = metadataDifficulty.y + 32;

                    var metadataDeath = this.scene.createText(this.scene.getWidth() - 20, nextY, this.scene.deathCounter + ' Blue Balls', 32, 'Vcr', '#ffffff', '#000000', 0, 'right');
                    metadataDeath.x -= metadataDeath.width;
                    this.scene.add.existing(metadataDeath);
                    this.scene.addToCameras(metadataDeath, this.cameras);
                    this.metadata.push(metadataDeath);

                    this.regenOptions(['resume', 'restart song', 'exit to menu']);
                    this.changeSelection(0);
                    this.close();
                }

                open()
                {
                    this.isOpen = true;
                    this.scene.camPause.visible = true;

                    /*
                    this.background.alpha = 0;
                    this.scene.tweens.add
                    ({
                        targets: this.background,
                        alpha: 0.6,
                        duration: 800,
                        ease: Phaser.Math.Easing.Quartic.Out
                    });
                    */

                    var delay = 100;
                    var fromY = 15;

                    this.metadataStatus.alpha = 0;
                    this.metadataStatus.y = fromY;

                    this.tweens.push
                    (
                        this.scene.tweens.add
                        ({
                            targets: this.metadataStatus,
                            alpha: 1,
                            y: this.metadataStatus.y + 5,
                            duration: 1800,
                            delay: delay,
                            ease: Phaser.Math.Easing.Quartic.Out
                        })
                    );

                    for (var mem of this.metadata)
                    {
                        if (mem != null)
                        {
                            mem.alpha = 0;
                            mem.y = fromY;

                            this.tweens.push
                            (
                                this.scene.tweens.add
                                ({
                                    targets: mem,
                                    alpha: 1,
                                    y: mem.y + 5,
                                    duration: 1800,
                                    delay: delay,
                                    ease: Phaser.Math.Easing.Quartic.Out
                                })
                            );

                            delay += 100;
                            fromY += 32;
                        }
                    }

                    for (var option of this.options)
                        if (option != null)
                            option.x = option.y = 0;
                }

                close()
                {
                    this.isOpen = false;
                    this.scene.camPause.visible = false;

                    while (this.tweens.length > 0)
                    {
                        var tween = this.tweens.shift();
                        if (tween != null)
                            tween.stop();
                    }
                }

                changeSelection(change = 0)
                {
                    if (this.options.length <= 0)
                        return;

                    var lastSelected = this.curSelected;
                    this.curSelected += change;

                    if (this.curSelected >= this.options.length) this.curSleected = 0;
                    if (this.curSelected < 0) this.curSelected = this.options.length - 1;

                    if (Math.abs(lastSelected - this.curSelected) != 0)
                        this.scene.sound.add('scroll', {volume: 1, loop: false}).play();

                    for (var i=0; i<this.options.length; i++)
                    {
                        this.options[i].targetY = (i - this.curSelected);
                        this.options[i].alpha = (i == this.curSelected ? 1 : 0.6);
                    }
                }

                regenOptions(list = [])
                {
                    list = list ?? [];

                    while (this.options.length > 0)
                    {
                        var option = this.options.shift();
                        for (var letter of option.letters)
                        {
                            letter.visible = false;
                            letter.destroy();
                        }
                    }

                    for (var i=0; i<list.length; i++)
                    {
                        var option = new AtlasText(this.scene, 0, 100 + i * 100, list[i], true);
                        option.draw(this.scene);
                        option.isMenuItem = true;
                        option.targetY = i;
                        option.addToCameras(this.scene, this.cameras);
                        this.options.push(option);
                    }
                }

                update(elapsed)
                {
                    if (this.isOpen)
                    {
                        for (var option of this.options)
                            if (option != null)
                                option.update(elapsed);
                    }
                }

                onUnPause()
                {
                    if (this.options.length <= 0)
                        this.scene.unpause();
                    else
                    {
                        switch (this.options[this.curSelected].text.toLowerCase())
                        {
                            case 'restart song':
                                this.scene.restartSong();
                                this.scene.unpause();
                                break;

                            case 'exit to menu':
                                this.scene.exit();
                                break;

                            default:
                            this.scene.unpause();
                                break;
                        }
                    }
                }
            }

            class PopUpStuff
            {
                static precache(scene)
                {
                    scene.load.image('sick', 'https://codehs.com/uploads/82f101fbd120728205d131f55e21b533');
                    scene.load.image('good', 'https://codehs.com/uploads/0db29c78660eee29ef6a1fcc360de3b4');
                    scene.load.image('bad', 'https://codehs.com/uploads/69f38256f2cd1720fc32422cb25ceda1');
                    scene.load.image('shit', 'https://codehs.com/uploads/c434ae8b1e5d0b9e64a07e476e418ef8');
                    scene.load.image('combo', 'https://codehs.com/uploads/a52b0ac068402375514183311e86d3bd');
                    scene.load.image('0', 'https://codehs.com/uploads/90582b8f7b94a49e999c81918f47e3e9');
                    scene.load.image('1', 'https://codehs.com/uploads/e2b454cc47c4ca3464aa334a184229bf');
                    scene.load.image('2', 'https://codehs.com/uploads/b8dc447ddab69108dbf245b86a042c6d');
                    scene.load.image('3', 'https://codehs.com/uploads/85a4e59c0d6d9b92ab578258eaec99fc');
                    scene.load.image('4', 'https://codehs.com/uploads/f9df09a10217d5abe596a271fcbc78a3');
                    scene.load.image('5', 'https://codehs.com/uploads/8f3a7bdde9b74c3c400d8a4383ab0735');
                    scene.load.image('6', 'https://codehs.com/uploads/f68c8fc46e0290c4bcd823d030beb7cc');
                    scene.load.image('7', 'https://codehs.com/uploads/ce3b5fb67877a0f1003da5104ccd95f8');
                    scene.load.image('8', 'https://codehs.com/uploads/58dc7755ea33c8f2009a7c487fdfc5e3');
                    scene.load.image('9', 'https://codehs.com/uploads/96ca7c21ca750c1292222ce53d0ab789');

                    scene.load.image('pixelUI/sick', 'https://codehs.com/uploads/007cd450ca588b0822399b18d86a7ee3');
                    scene.load.image('pixelUI/good', 'https://codehs.com/uploads/7f50fdd4f3bfcbe6c2ca37320128b829');
                    scene.load.image('pixelUI/bad', 'https://codehs.com/uploads/f5429a93d674c348aa1b5ab72dd82da7');
                    scene.load.image('pixelUI/shit', 'https://codehs.com/uploads/311d24ba8b92ec522d392db22c5b3ff0');
                    scene.load.image('pixelUI/combo', 'https://codehs.com/uploads/a23cb8b0af98f9c757f8131162a8dc01');
                    scene.load.image('pixelUI/0', 'https://codehs.com/uploads/3235d86605e9731a29da72fe1b5f18c7');
                    scene.load.image('pixelUI/1', 'https://codehs.com/uploads/5d69f85603a8076756cf736213f8a16a');
                    scene.load.image('pixelUI/2', 'https://codehs.com/uploads/8902aaf8de11ed797d9b992e23b8546c');
                    scene.load.image('pixelUI/3', 'https://codehs.com/uploads/16fc65bead2f58c848611778d5ef91f2');
                    scene.load.image('pixelUI/4', 'https://codehs.com/uploads/fa78ae674efad9b8be1b704ccd39450e');
                    scene.load.image('pixelUI/5', 'https://codehs.com/uploads/2d4aac8e81fe64be98b713a00f593ca7');
                    scene.load.image('pixelUI/6', 'https://codehs.com/uploads/5af4714e94acbd1456be1818d4bed17c');
                    scene.load.image('pixelUI/7', 'https://codehs.com/uploads/ededd04f7392f8a9f56ddaccaee5da2c');
                    scene.load.image('pixelUI/8', 'https://codehs.com/uploads/1b3d112b6500dc87a4f2b793f44d24a8');
                    scene.load.image('pixelUI/9', 'https://codehs.com/uploads/9c20ed907db577ba8b07ed172102680f');
                }

                scene;

                constructor(scene)
                {
                    this.scene = scene;
                }

                displayRating(daRating)
                {
                    var ratingPath = daRating ?? 'good';
                    var isPixel = this.getIsPixel();
                    if (isPixel)
                        ratingPath = 'pixelUI/' + ratingPath;

                    var rating = this.scene.physics.add.image(0, 0, ratingPath);
                    this.scene.addToCameras(rating, [this.scene.camHUD]);
                    rating.x = (this.scene.getWidth() * 0.474);
                    rating.y = (this.scene.getHeight() * 0.45 - 60);

                    rating.setAccelerationY(550);
                    rating.setVelocity(-this.getRandomInt(0, 10), -this.getRandomInt(140, 175));

                    rating.scaleX = rating.scaleY = (isPixel ? 0.7 : 0.65);

                    rating.x -= (rating.width * rating.scaleX) / 2;
                    rating.y -= (rating.height * rating.scaleY) / 2;

                    this.scene.tweens.add
                    ({
                        targets: rating,
                        alpha: 0,
                        duration: 200,
                        delay: Conductor.instance.getBeatLengthMs(),
                        onComplete: function() { rating.destroy(); }
                    });
                }

                displayCombo(combo)
                {
                    combo = combo ?? 0;
                    var isPixel = this.getIsPixel();

                    var comboX = (this.scene.getWidth() * 0.507);
                    var comboY = (this.scene.getHeight() * 0.44);

                    /*
                    var comboSpr = this.scene.physics.add.image(0, 0, isPixel ? 'pixelUI/combo' : 'combo');
                    this.scene.addToCameras(comboSpr, [this.scene.camHUD]);
                    comboSpr.x = comboX;
                    comboSpr.y = comboY;

                    comboSpr.setAccelerationY(600);
                    comboSpr.setVelocity(this.getRandomInt(1, 10), -150);

                    comboSpr.scaleX = comboSpr.scaleY = (isPixel ? 0.7 : 0.7);

                    this.scene.tweens.add
                    ({
                        targets: comboSpr,
                        alpha: 0,
                        duration: 200,
                        delay: Conductor.instance.getBeatLengthMs(),
                        onComplete: function() { comboSpr.destroy(); }
                    });
                    */

                    var separatedScore = [];
                    var tempCombo = combo;

                    while (tempCombo != 0)
                    {
                        separatedScore.push(tempCombo % 10);
                        tempCombo = Math.floor(tempCombo / 10);
                    }

                    while (separatedScore.length < 3)
                        separatedScore.push(0);

                    var daLoop = 1;
                    for (var i of separatedScore)
                    {
                        var numScore = this.scene.physics.add.image(0, 0, (isPixel ? 'pixelUI/' : '') + Math.floor(i));
                        this.scene.addToCameras(numScore, [this.scene.camHUD]);

                        numScore.scaleX = numScore.scaleY = (isPixel ? 0.7 : 0.45);

                        numScore.x = comboX - (36 * daLoop) - 65;
                        numScore.y = comboY;

                        numScore.setAccelerationY(this.getRandomInt(250, 300));
                        numScore.setVelocity(this.getRandomFloat(-5, 5), -this.getRandomInt(130, 150));

                        this.scene.tweens.add
                        ({
                            targets: numScore,
                            alpha: 0,
                            duration: 200,
                            delay: Conductor.instance.getBeatLengthMs() * 2,
                            onComplete: function() { numScore.destroy(); }
                        });

                        daLoop++;
                    }

                    return combo;
                }

                getRandomInt(min, max) {return Math.floor(Math.random() * (max - min) + min);}
                getRandomFloat(min, max) {return Math.random() * (max - min) + min;}

                getIsPixel() { return (PlayState.instance != null && PlayState.instance.pixelUI); }
            }

            class PlayState extends MusicBeatState
            {
                static instance = null;
                static playlist = null;

                girlfriendPos = [425, 155];
                opponentPos = [100, 100];
                playerPos = [770, 100];

                countdown;
                songEnded = false;

                deathCounter = 0;
                score = 0;
                scoreText;

                healthBar;
                health = Constants.HEALTH_STARTING;
                healthLerp = this.health;

                iconP1;
                iconP2;

                camFollow = {x: 0, y: 0, lerpX: 0, lerpY: 0};
                stage;

                camHUD;
                camPause;

                aBot;
                player;
                girlfriend;
                opponent;

                song;
                chart;

                playerStrumline;
                opponentStrumline;

                unloadedNotes = [];
                notes = [];
                tailNotes = [];
                noteSplashes = [];
                tailSplashes = [];

                songEvents = [];

                comboPopUps;
                pauseMenu;

                pixelUI = false;

                defaultZoom = 1.05;
                camBopRate = 1;
                camBopIntensity = 1;

                preload()
                {
                    super.preload();

                    this.load.audio('missnote1', ['https://codehs.com/uploads/ccbc16b4622a51ebb41d6c0a8faf7668?.ogg']);
                    this.load.audio('missnote2', ['https://codehs.com/uploads/b8f8ebe091f79926c2e259bf45459478?.ogg']);
                    this.load.audio('missnote3', ['https://codehs.com/uploads/cdbc8642d093b7e5f75569ec708d464b?.ogg']);

                    StageManager.precache(this);
                    Character.precache(this);
                    Song.precache(this);
                    Chart.precache(this);
                    Note.precache(this);
                    TailNote.precache(this);
                    NoteSplash.precache(this);
                    TailNoteHoldSplash.precache(this);
                    PopUpStuff.precache(this);
                    Strumline.precache(this);
                    HealthBar.precache(this);
                    HealthIcon.precache(this);
                    Countdown.precache(this);
                    PauseUI.precache(this);

                    this.load.atlasXML('aBotIdle', 'https://codehs.com/uploads/1a9af6d3ea9bfa15183240c095cb9e7a', 'https://codehs.com/uploads/1fe536322e878d8e91298d0980f06e51');
                }
            
                create()
                {
                    super.create();

                    if (PlayState.playlist == null)
                        PlayState.playlist = new PlayStatePlaylist(false, [SongRegistry.getByName(Constants.DEFAULT_SONG)], Constants.DEFAULT_DIFFICULTY);

                    this.chart = new Chart(this, PlayState.playlist.songs[0].name, PlayState.playlist.difficulty);

                    PlayState.instance = this;

                    if (MusicBeatState.music != null)
                        MusicBeatState.music.stop();

                    this.camHUD = new Phaser.Cameras.Scene2D.Camera(0, 0, this.getWidth(), this.getHeight());
                    this.cameras.addExisting(this.camHUD, false);
                    this.camPause = new Phaser.Cameras.Scene2D.Camera(0, 0, this.getWidth(), this.getHeight());
                    this.cameras.addExisting(this.camPause, false);

                    this.loadStage();
                    this.loadCharacters();
                    this.loadHUD();
                    this.loadSong();

                    if (this.girlfriend != null) this.girlfriend.initFollow();
                    if (this.opponent != null) this.opponent.initFollow();
                    if (this.player != null) this.player.initFollow();

                    if (this.girlfriend != null)
                    {
                        this.camFollow.x = this.camFollow.lerpX = this.girlfriend.camFollow[0];
                        this.camFollow.y = this.camFollow.lerpY = this.girlfriend.camFollow[1];
                    }
                    else if (this.opponent != null)
                    {
                        this.camFollow.x = this.camFollow.lerpX = this.opponent.camFollow[0];
                        this.camFollow.y = this.camFollow.lerpY = this.opponent.camFollow[1];
                    }
                    else if (this.player != null)
                    {
                        this.camFollow.x = this.camFollow.lerpX = this.player.camFollow[0];
                        this.camFollow.y = this.camFollow.lerpY = this.player.camFollow[1];
                    }
                    else
                    {
                        this.camFollow.x = this.camFollow.lerpX = this.getWidth() / 2;
                        this.camFollow.y = this.camFollow.lerpY = this.getHeight() / 2;
                    }

                    // beat n shit
                    for (var event of this.songEvents)
                        if (event.time <= 0)
                            this.triggerEvent(event);

                    this.countdown = new Countdown(this);

                    this.pauseMenu = new PauseUI(this, [this.camPause]); // Give it a custom camera so nothing can display over it=

                    this.stage.onCreatePost();
                    this.startCountdown();
                }

                destroy()
                {
                    PlayState.instance = null;
                }

                loadStage()
                {
                    this.stage = new StageManager(this, this.chart.getStage() ?? 'mainStage');
                    this.stage.onCreate();

                    this.cameras.main.zoom = this.defaultZoom = this.stage.zoom ?? 1.05;
                }

                loadCharacters()
                {
                    var noCharNames = ['nogf', 'nodad', 'nobf', 'none', 'nothing'];

                    if (this.chart.metadata == null || this.chart.metadata != null && this.chart.metadata.playData.characters.girlfriend != null && this.chart.metadata.playData.characters.girlfriend.length > 0)
                    {
                        var gfName = (this.chart.metadata != null ? this.chart.metadata.playData.characters.girlfriend : (this.chart.data.gfVersion ?? 'gf'));
                        if (!noCharNames.includes(gfName))
                        {
                            if (gfName == 'nene')
                            {
                                var frames = 'aBotIdle';
                                this.aBot = this.createSprite(frames, this.girlfriendPos[0] - 115, this.girlfriendPos[1] + 315);
                                this.aBot.anims.create({key: 'idle', frameRate: 24, frames: this.aBot.anims.generateFrameNames(frames, {prefix: 'ABot Idle instance 1', end: 11, zeroPad: 4})});
                                this.aBot.anims.play('idle');
                                this.addToCameras(this.aBot, [this.cameras.main]);
                                this.add.existing(this.aBot);
                            }

                            this.girlfriend = new Character(this, this.girlfriendPos[0], this.girlfriendPos[1], gfName);
                            this.addToCameras(this.girlfriend, [this.cameras.main]);
                            this.add.existing(this.girlfriend);

                            if (this.girlfriend.curCharacter == 'pico-speaker')
                            {
                                var allNotes = this.chart.getNotes('picospeaker');
                                if (allNotes != null)
                                {
                                    if (this.chart.chartType == ChartType.VANILLA)
                                    {
                                    for (var note of allNotes)
                                        this.girlfriend.animationNotes.push([note.t, note.d]);
                                    }
                                    else if (this.chart.chartType == ChartType.LEGACY)
                                    {
                                    for (var section of allNotes)
                                        for (var note of section.sectionNotes ?? [])
                                        this.girlfriend.animationNotes.push(note);
                                    }
                                }
                            }
                        }
                    }

                    this.stage.onCreateGF();

                    if (this.chart.metadata == null || this.chart.metadata != null && this.chart.metadata.playData.characters.opponent != null && this.chart.metadata.playData.characters.opponent.length > 0)
                    {
                        var oppName = (this.chart.metadata != null ? this.chart.metadata.playData.characters.opponent : this.chart.data.player2);
                        if (!noCharNames.includes(oppName))
                        {
                            this.opponent = new Character(this, this.opponentPos[0], this.opponentPos[1], (this.chart.metadata != null ? this.chart.metadata.playData.characters.opponent : this.chart.data.player2));
                            this.addToCameras(this.opponent, [this.cameras.main]);
                            this.add.existing(this.opponent);
                        }
                    }

                    this.stage.onCreateDad();

                    if (this.chart.metadata == null || this.chart.metadata != null && this.chart.metadata.playData.characters.player != null && this.chart.metadata.playData.characters.player.length > 0)
                    {
                        var plrName = (this.chart.metadata != null ? this.chart.metadata.playData.characters.player : this.chart.data.player1);
                        if (!noCharNames.includes(plrName))
                        {
                            this.player = new Character(this, this.playerPos[0], this.playerPos[1], (this.chart.metadata != null ? this.chart.metadata.playData.characters.player : this.chart.data.player1), true);
                            this.addToCameras(this.player, [this.cameras.main]);
                            this.add.existing(this.player);
                        }
                    }

                    this.stage.onCreateBF();
                }

                loadHUD()
                {
                    this.loadHealthbar();
                    this.loadStrums();

                    this.comboPopUps = new PopUpStuff(this);
                }

                loadHealthbar()
                {
                    this.healthBar = new HealthBar(this);
                    this.healthBar.x = (this.camHUD.width - this.healthBar.barBack.width) / 2;
                    this.healthBar.y = (Constants.DOWN_SCROLL ? this.camHUD.height * 0.1 : this.camHUD.height * 0.9);
                    this.healthBar.draw(this);
                    this.healthBar.setToCams(this, [this.camHUD]);

                    this.scoreText = this.createText(this.healthBar.x + this.healthBar.barBack.width - 190, this.healthBar.y + 30, '', 16, 'Vcr', '#ffffff', '#000000', 2, 'right');
                    this.add.existing(this.scoreText);
                    this.addToCameras(this.scoreText, [this.camHUD]);

                    this.iconP2 = new HealthIcon(this, (this.opponent != null ? this.opponent.icon : 'face'));
                    this.iconP2.y = this.healthBar.y - (this.iconP2.height / 2);
                    this.add.existing(this.iconP2);
                    this.addToCameras(this.iconP2, [this.camHUD]);

                    this.iconP1 = new HealthIcon(this, (this.player != null ? this.player.icon : 'face'));
                    this.iconP1.y = this.healthBar.y - (this.iconP1.height / 2);
                    this.iconP1.flipX = true;
                    this.add.existing(this.iconP1);
                    this.addToCameras(this.iconP1, [this.camHUD]);
                }

                loadStrums()
                {
                    var x = Constants.STRUMLINE_X_OFFSET + Strumline.INITIAL_OFFSET;
                    if (Constants.MIDDLE_SCROLL)
                    x = -(Strumline.NOTE_SPACING * 2) + Strumline.INITIAL_OFFSET;

                    var y = Constants.STRUMLINE_Y_OFFSET;
                    if (Constants.DOWN_SCROLL)
                    y = this.getHeight() - (150 + y);

                    this.opponentStrumline = new Strumline(this, Constants.MIDDLE_SCROLL ? -10000 : x, y);
                    this.opponentStrumline.draw(this);
                    this.opponentStrumline.addToCameras(this, [this.camHUD]);

                    this.playerStrumline = new Strumline(this, x + (this.camHUD.width / 2), y);
                    this.playerStrumline.draw(this);
                    this.playerStrumline.addToCameras(this, [this.camHUD]);
                }

                restartSong()
                {
                    this.unloadedNotes = [];
                    this.songEvents = [];

                    while (this.notes.length > 0) { this.notes.shift().kill(); }
                    while (this.tailNotes.length > 0) { this.tailNotes.shift().kill(); }
                    while (this.noteSplashes.length > 0) { this.noteSplashes.shift().kill(); }
                    while (this.tailSplashes.length > 0) { this.tailSplashes.shift().kill(); }

                    Highscore.tallies = new Tallies();

                    this.score = 0;
                    this.health = Constants.HEALTH_STARTING;

                    for (var strum of this.playerStrumline.strums)
                    if (strum != null)
                        strum.playAnim('static');

                    for (var strum of this.opponentStrumline.strums)
                    if (strum != null)
                        strum.playAnim('static');

                    if (this.girlfriend != null) this.girlfriend.dance();
                    if (this.opponent != null) this.opponent.dance();
                    if (this.player != null) this.player.dance();

                    this.songEnded = false;
                    this.startedCountdown = false;

                    this.song.stop();
                    this.loadSong();

                    this.startCountdown();
                }

                startedCountdown = false;
                
                startCountdown()
                {
                    this.countdown.start();
                    Conductor.instance.update(-(Conductor.instance.getBeatLengthMs()) * 5);
                }

                loadSong()
                {
                    this.song = new Song(this, this.chart.songName);

                    var allNotes = this.chart.getNotes();
                    if (allNotes != null)
                    {
                        if (this.chart.chartType == ChartType.VANILLA)
                        {
                            for (var note of allNotes)
                            {
                                var daNote = new Note(this, (note.d < 4), note.d, note.t, note.k ?? '');
                                if (!this.pixelUI) daNote.scaleX = daNote.scaleY = 0.7;

                                if (note.l != null && note.l > 0)
                                {
                                    var tailNote = new TailNote(this, (note.d < 4), daNote, note.d, note.t, note.l);
                                    tailNote.setScale(0.7, 0.7);
                                    tailNote.draw(this);
                                    tailNote.addToCameras(this, [this.camHUD]);
                                    this.unloadedNotes.push(tailNote);
                                }

                                this.add.existing(daNote);
                                this.addToCameras(daNote, [this.camHUD]);
                                this.unloadedNotes.push(daNote);
                            }
                        }
                        else if (this.chart.chartType == ChartType.LEGACY)
                        {
                            for (var section of allNotes)
                            {
                                for (var note of section.sectionNotes ?? [])
                                {
                                    var daNote = new Note(this, (note[1] > 3), note[1], note[0]);
                                    if (!this.pixelUI) daNote.scaleX = daNote.scaleY = 0.7;

                                    if (note[2] != null && note[2] > 0)
                                    {
                                        var tailNote = new TailNote(this, (note[1] > 3), daNote, note[1], note[0], note[2]);
                                        tailNote.setScale(0.7, 0.7);
                                        tailNote.draw(this);
                                        tailNote.addToCameras(this, [this.camHUD]);
                                        this.unloadedNotes.push(tailNote);
                                    }

                                    this.add.existing(daNote);
                                    this.addToCameras(daNote, [this.camHUD]);
                                    this.unloadedNotes.push(daNote);
                                }
                            }
                        }
                    }

                    var events = this.chart.data.events;
                    if (events != null && this.chart.chartType == ChartType.VANILLA)
                    {
                        for (var event of events)
                        {
                            var name = event.e ?? '';
                            var time = event.t ?? 0;
                            var dets = event.v ?? '';

                            if (name == 'FocusCamera')
                                this.songEvents.push({name: 'Move Camera', time: time ?? 0, character: (dets.char ?? dets) ?? 0});
                            else if (name == 'ZoomCamera')
                                this.songEvents.push({name: 'Zoom Camera', time: time ?? 0, zoom: dets.zoom, duration: dets.duration, ease: dets.ease});
                            else if (name == 'SetCameraBop')
                                this.songEvents.push({name: 'Set Camera Bop', time: time ?? 0, rate: dets.rate ?? 1, intensity: dets.intensity ?? 1});
                            else if (name == 'PlayAnimation')
                                this.songEvents.push({name: 'Play Animation', time: time ?? 0, target: dets.target ?? 'bf', anim: dets.anim ?? '', force: dets.force ?? false});
                        }
                    }

                    if (this.chart.chartType == ChartType.VANILLA)
                    {
                        if (this.chart.metadata != null && this.chart.metadata.timeChanges != null)
                            for (var change of this.chart.metadata.timeChanges)
                                this.songEvents.push({name: 'Change BPM', time: change.t ?? 0, bpm: change.bpm ?? Constants.DEFAULT_BPM});
                    }

                    if (!this.pixelUI)
                    {
                        for (var i=0; i<(Strumline.KEY_COUNT * 2); i++)
                        {
                            var strum = (i > 3) ? this.playerStrumline : this.opponentStrumline;
                            var x = (strum != null) ? strum.x : 0;
                            var y = (strum != null) ? strum.y : 0;

                            var tailCover = new TailNoteHoldSplash(this, i, x + (Strumline.NOTE_SPACING * Math.floor(i % Strumline.KEY_COUNT)), y);
                            tailCover.visible = false;
                            this.add.existing(tailCover);
                            this.addToCameras(tailCover, [this.camHUD]);
                            this.tailSplashes.push(tailCover);
                        }
                    }
                }

                easeByName(name)
                {
                    name = name.toLowerCase() ?? '';

                    var method;
                    var check = name;

                    if (check.endsWith('inout')) check.replace('inout', '');
                    else if (check.endsWith('out')) check.replace('out', '');
                    else if (check.endsWith('in')) check.replace('in', '');

                    switch (check)
                    {
                        case 'cube': method = Phaser.Math.Easing.Cubic; break;
                        case 'quart': method = Phaser.Math.Easing.Quartic; break;
                        case 'quint': method = Phaser.Math.Easing.Quintic; break;
                        case 'back': method = Phaser.Math.Easing.Back; break;
                        case 'bounce': method = Phaser.Math.Easing.Bounce; break;
                        case 'circ': method = Phaser.Math.Easing.Circular; break;
                        case 'elastic': method = Phaser.Math.Easing.Elastic; break;
                        case 'sine': method = Phaser.Math.Easing.Sine; break;
                        case 'stepped': method = Phaser.Math.Easing.Stepped; break;
                        case 'quad': method = Phaser.Math.Easing.Quadratic; break;
                        case 'expo': method = Phaser.Math.Easing.Expo; break;
                        default: method = Phaser.Math.Easing.Linear; break;
                    }

                    if (name.endsWith('inout')) return method.InOut;
                    else if (name.endsWith('out')) return method.Out;
                    else if (name.endsWith('in')) return method.In;

                    return method;
                }

                framePaused = false;
                gamePaused = false;

                update(time)
                {
                    super.update(time);

                    if (!this.song.paused && this.song.hasEnded())
                    {
                        this.songEnded = true;
                        this.moveToResultsScreen();
                    }

                    for (var key of Controls.list.get('pause'))
                    {
                        if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                        {
                            if (!this.gamePaused)
                                this.pause();
                            else if (this.pauseMenu.isOpen)
                                this.pauseMenu.onUnPause();
                        }
                    }

                    if (this.pauseMenu.isOpen && this.gamePaused)
                    {
                        for (var key of Controls.list.get('ui_up'))
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                                this.pauseMenu.changeSelection(-1);

                        for (var key of Controls.list.get('ui_down'))
                            if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key)))
                                this.pauseMenu.changeSelection(1);
                    }
                        
                    if (this.gamePaused)
                    {
                        if (this.pauseMenu.isOpen)
                            this.pauseMenu.update(this.elapsed);

                        return;
                    }

                    this.countdown.update(this.elapsed);

                    if (this.countdown.performing || Conductor.instance.lastTime < 0)
                    {
                        var thresh = -(Conductor.instance.getBeatLengthMs()) * 5;
                        if (!this.startedCountdown)
                        {
                            if (Conductor.instance.lastTime == thresh)
                                this.startedCountdown = true;
                            else
                            {
                                Conductor.instance.update(thresh);
                                this.startedCountdown = true;
                            }
                        }
                        else
                        {
                            Conductor.instance.update(Conductor.instance.lastTime + (this.elapsed * 1000));
                            if (Conductor.instance.lastTime >= 0)
                                this.song.play();
                        }
                    }
                    else if (!this.songEnded)
                    {
                        var lastTime = Conductor.instance.lastTime ?? 0;
                        if (this.song.inst != null)
                        {
                            Conductor.instance.update(this.song.getTime() * 1000);
                            if (lastTime == Conductor.instance.lastTime)
                            {
                                if (!this.framePaused)
                                    this.pauseFrames();

                                return;
                            }
                            else
                            {
                                if (!this.gamePaused && this.framePaused)
                                        this.unpauseFrames();
                            }
                        }
                    }

                    this.updateNotes();
                    if (Conductor.instance.lastTime > 0) this.updateInput();

                    if (this.songEvents.length > 0)
                    {
                        for (var event of this.songEvents)
                            if (event.time <= Conductor.instance.lastTime)
                                this.triggerEvent(event);
                    }

                    this.scoreText.text = 'Score:' + this.score;

                    if (this.girlfriend != null) this.girlfriend.update(this.elapsed);
                    if (this.opponent != null) this.opponent.update(this.elapsed);
                    if (this.player != null)
                    {
                        this.player.update(this.elapsed);
                        if (this.player.holdTimer > (Conductor.instance.getBeatLengthMs() / 4) * 0.001 * 4 && !this.playerStrumline.held.includes(true))
                            if (this.player.anims.getName().startsWith('sing') && !this.player.anims.getName().endsWith('miss'))
                                this.player.dance(true);
                    }

                    for (var strum of this.opponentStrumline.strums) if (strum != null) strum.update(this.elapsed);
                    for (var strum of this.playerStrumline.strums) if (strum != null) strum.update(this.elapsed);

                    for (var splash of this.noteSplashes) if (splash != null) splash.update();
                    for (var splash of this.tailSplashes) if (splash != null) splash.update();
                    
                    this.updateHealthbar();
                    this.updateIcons();

                    this.updateCamera(Constants.DEFAULT_CAMERA_FOLLOW_RATE);
                    this.stage.onUpdate(this.elapsed);
                }

                triggerEvent(event)
                {
                    var eventName = event.name.toLowerCase();

                    if (eventName == 'change bpm')
                        Conductor.instance.bpm = event.bpm;
                    else if (eventName == 'move camera')
                        this.switchCamera(event.character ?? 0);
                    else if (eventName == 'zoom camera')
                    {
                        if (event.ease.toLowerCase() == 'instant')
                            this.defaultZoom = event.zoom;
                        else
                        {
                            PlayState.instance.tweens.add
                            ({
                                targets: PlayState.instance,
                                defaultZoom: event.zoom,
                                ease: PlayState.instance.easeByName(event.ease),
                                duration: (((Conductor.instance.getBeatLengthMs() / 4) ?? 0) * event.duration) / 1000
                            });
                        }
                    }
                    else if (eventName == 'set camera bop')
                    {
                        this.camBopIntensity = event.intensity ?? 1;
                        this.camBopRate = event.rate ?? 1;
                    }
                    else if (eventName == 'play animation') // force exists idk
                    {
                        if (event.target.toLowerCase() == 'gf' && this.girlfriend != null)
                        {
                            this.girlfriend.playAnim(event.anim);
                            this.girlfriend.specialAnim = true;
                        }
                        else if (event.target.toLowerCase() == 'dad' && this.opponent != null)
                        {
                            this.opponent.playAnim(event.anim);
                            this.opponent.specialAnim = true;
                        }
                        else if (event.target.toLowerCase() == 'bf' && this.player != null)
                        {
                            this.player.playAnim(event.anim);
                            this.player.specialAnim = true;
                        }
                    }

                    this.songEvents.splice(this.songEvents.indexOf(event), 1);
                }

                pause()
                {
                    this.gamePaused = true;
                    if (!this.framePaused) this.pauseFrames();
                    this.song.pause();

                    for (var sound of this.stage.soundPool)
                        if (sound.isPlaying)
                            sound.pause();

                    this.pauseMenu.open();
                }

                unpause()
                {
                    this.gamePaused = false;
                    if (this.framePaused) this.unpauseFrames();
                    this.song.resume();

                    for (var sound of this.stage.soundPool)
                        if (sound.isPaused)
                            sound.resume();

                    this.pauseMenu.close();
                }

                pauseFrames()
                {
                    this.framePaused = true;

                    for (var obj of this.opponentStrumline.strums) if (obj != null) obj.anims.pause();
                    for (var obj of this.playerStrumline.strums) if (obj != null) obj.anims.pause();
                    for (var obj of this.notes) if (obj != null) obj.anims.pause();
                    for (var obj of this.tailNotes)
                    {
                        if (obj.tailNote != null) obj.tailNote.anims.pause();
                        if (obj.tailNoteEnd != null) obj.tailNoteEnd.anims.pause();
                    }
                    
                    if (this.aBot != null) this.aBot.anims.pause();
                    if (this.girlfriend != null) this.girlfriend.anims.pause();
                    if (this.opponent != null) this.opponent.anims.pause();
                    if (this.player != null) this.player.anims.pause();

                    for (var obj of this.noteSplashes) if (obj != null) obj.anims.pause();
                    for (var obj of this.tailSplashes) if (obj != null) obj.anims.pause();

                    if (this.iconP1 != null) this.iconP1.anims.pause();
                    if (this.iconP2 != null) this.iconP2.anims.pause();

                    for (var obj of this.stage.objectList) if (obj != null) if (obj.anims != null) obj.anims.pause();
                }

                unpauseFrames()
                {
                    this.framePaused = false;

                    for (var obj of this.opponentStrumline.strums) if (obj != null) obj.anims.resume();
                    for (var obj of this.playerStrumline.strums) if (obj != null) obj.anims.resume();
                    for (var obj of this.notes) if (obj != null) obj.anims.resume();
                    for (var obj of this.tailNotes)
                    {
                        if (obj.tailNote != null) obj.tailNote.anims.resume();
                        if (obj.tailNoteEnd != null) obj.tailNoteEnd.anims.resume();
                    }
                    
                    if (this.aBot != null) this.aBot.anims.resume();
                    if (this.girlfriend != null) this.girlfriend.anims.resume();
                    if (this.opponent != null) this.opponent.anims.resume();
                    if (this.player != null) this.player.anims.resume();

                    for (var obj of this.noteSplashes) if (obj != null) obj.anims.resume();
                    for (var obj of this.tailSplashes) if (obj != null) obj.anims.resume();

                    if (this.iconP1 != null) this.iconP1.anims.resume();
                    if (this.iconP2 != null) this.iconP2.anims.resume();

                    for (var obj of this.stage.objectList) if (obj != null) if (obj.anims != null) obj.anims.resume();
                }

                moveToResultsScreen()
                {
                    var song = PlayState.playlist.songs.shift();
                    if (PlayState.playlist.songs.length <= 0)
                        this.exit();
                    else
                    {
                        Highscore.talliesLevel = Highscore.combineTallies(Highscore.tallies, Highscore.talliesLevel);
                        Highscore.tallies = new Tallies();

                        this.switchState("PrepPlayState", PrepPlayState);
                    }
                }

                updateNotes()
                {
                    for (var unloadedNote of this.unloadedNotes)
                    {
                        var currentTime = unloadedNote.time - (Conductor.instance.lastTime ?? 0);
                        var renderDistance = Strumline.get_RENDER_DISTANCE_MS() ?? 0;

                        if (currentTime < renderDistance && currentTime > -renderDistance)
                        {
                            this.unloadedNotes.splice(this.unloadedNotes.indexOf(unloadedNote), 1);
                            if (unloadedNote.constructor == TailNote) this.tailNotes.push(unloadedNote);
                            if (unloadedNote.constructor == Note) this.notes.push(unloadedNote);
                        }
                    }

                    for (var note of this.notes)
                    {
                        if (note == null)
                            continue;

                        var followStrum = (note.mustHit ? this.playerStrumline.strums[note.line] : this.opponentStrumline.strums[note.line]);

                        if (followStrum != null)
                        {
                            note.x = followStrum.x - Strumline.INITIAL_OFFSET - Strumline.NUDGE;
                            note.y = followStrum.y - (Strumline.INITIAL_OFFSET / 1.325);
                        }
                        else
                        {
                            note.x = this.playerStrumline.x + (Strumline.NOTE_SPACING * note.line) - Strumline.INITIAL_OFFSET - Strumline.NUDGE;
                            note.y = this.playerStrumline.y - (Strumline.INITIAL_OFFSET / 1.325);
                        }

                        if (this.pixelUI)
                        {
                            note.x -= (Strumline.NOTE_SPACING * 0.24);
                            note.y -= (Strumline.NOTE_SPACING * 0.24);
                        }
                        
                        note.y += Constants.PIXELS_PER_MS * ((Conductor.instance.lastTime ?? 0) - note.time) * this.chart.getScrollSpeed() * (Constants.DOWN_SCROLL ? 1 : -1);

                        if (!this.pixelUI && followStrum != null && followStrum.anims.getName().startsWith('press'))
                        {
                            note.x -= StrumlineNote.DEFAULT_OFFSET;
                            note.y -= StrumlineNote.DEFAULT_OFFSET;
                        }

                        if (note.time <= Conductor.instance.lastTime && !note.mustHit)
                        {
                            switch (note.type)
                            {
                                case 'mom':
                                    if (this.opponent != null)
                                        if (this.opponent.curCharacter == 'parents-christmas')
                                            this.opponent.playAnim(['singLEFT', 'singDOWN', 'singUP', 'singRIGHT'][note.line] + '-alt');

                                    break;

                                case 'ugh':
                                    if (this.opponent != null)
                                    {
                                        if (this.opponent.curCharacter == 'tankman')
                                        {
                                            this.opponent.playAnim(note.type);
                                            this.opponent.specialAnim = true;
                                        }
                                    }
                                    break;

                                case 'hehPrettyGood':
                                    if (this.opponent != null)
                                    {
                                        if (this.opponent.curCharacter == 'tankman')
                                        {
                                            this.opponent.playAnim(note.type);
                                            this.opponent.specialAnim = true;
                                        }
                                    }
                                    break;
                            
                                default:
                                    if (this.opponent != null)
                                        this.opponent.playAnim(['singLEFT', 'singDOWN', 'singUP', 'singRIGHT'][note.line]);
                                    break;
                            }

                            note.kill();
                            this.notes.splice(this.notes.indexOf(note), 1);

                            if (followStrum != null)
                            {
                                followStrum.playAnim('confirm');
                                followStrum.confirmHoldTimer = 0;
                            }

                            this.song.onOpponentHit();
                        }

                        if (note.hasMissed && !note.handledMiss)
                        {
                            this.onNoteMiss(note, -Constants.HEALTH_MISS_PENALTY);
                            
                            note.handledMiss = true;
                        }

                        if (note.hasMissed && note.time < Conductor.instance.lastTime - Strumline.get_RENDER_DISTANCE_MS())
                        {
                            if (!note.handledMiss)
                            {
                                this.onNoteMiss(note, -Constants.HEALTH_MISS_PENALTY);
                                note.handledMiss = true;
                            }

                            note.kill();
                            this.notes.splice(this.notes.indexOf(note), 1);
                        }

                        if (note.mustHit)
                        {
                            var hitWindowStart = note.time - Constants.HIT_WINDOW_MS;
                            var hitWindowEnd = note.time + Constants.HIT_WINDOW_MS;

                            if (Conductor.instance.lastTime > hitWindowEnd)
                            {
                                note.mayHit = false;
                                note.hasMissed = true;
                            }
                            else if (Conductor.instance.lastTime > hitWindowStart)
                            {
                                note.mayHit = true;
                                note.hasMissed = false;
                            }
                            else
                            {
                                note.mayHit = false;
                                note.hasMissed = false;
                            }
                        }
                    }

                    for (var tail of this.tailNotes)
                    {
                        if (tail == null)
                            continue;

                        var followStrum = (tail.mustHit ? this.playerStrumline.strums[tail.line] : this.opponentStrumline.strums[tail.line]);
                        var scrollMult = (Constants.DOWN_SCROLL ? -1 : 1);

                        if (tail.tailNote != null) tail.tailNote.flipY = Constants.DOWN_SCROLL;
                        if (tail.tailNoteEnd != null) tail.tailNoteEnd.flipY = Constants.DOWN_SCROLL;

                        if (followStrum != null)
                        {
                            tail.setX(followStrum.x - Strumline.INITIAL_OFFSET - Strumline.NUDGE);
                            tail.setY(followStrum.y - (Strumline.INITIAL_OFFSET / 1.325));
                        }
                        else
                        {
                            tail.setX(this.playerStrumline.x + (Strumline.NOTE_SPACING * tail.line) - Strumline.INITIAL_OFFSET - Strumline.NUDGE);
                            tail.setY(this.playerStrumline.y - (Strumline.INITIAL_OFFSET / 1.325));
                        }

                        if (tail.tailNote != null)
                        {
                            tail.tailNote.scaleY = (tail.length * Constants.PIXELS_PER_MS * this.chart.getScrollSpeed()) / tail.tailNote.height;
                            tail.setY(tail.y + ((tail.tailNote.displayHeight / 2) * scrollMult));
                        }

                        if (this.pixelUI)
                        {
                            tail.setX(tail.x - (Strumline.NOTE_SPACING * 0.24));
                            tail.setY(tail.y - (Strumline.NOTE_SPACING * 0.24));
                        }
                        
                        tail.setY(tail.y + Constants.PIXELS_PER_MS * ((Conductor.instance.lastTime ?? 0) - tail.time) * this.chart.getScrollSpeed() * (scrollMult * -1));

                        if (!this.pixelUI && followStrum != null && followStrum.anims.getName().startsWith('press'))
                        {
                            tail.setX(tail.x - StrumlineNote.DEFAULT_OFFSET);
                            tail.setY(tail.y - StrumlineNote.DEFAULT_OFFSET);
                        }

                        if (!tail.mustHit)
                        {
                            var tailHold = this.tailSplashes[tail.line];
                            if (tailHold != null)
                            {
                                if (tail.holding)
                                {
                                    tailHold.visible = true;
                                    if (tailHold.anims.getName() != 'hold')
                                    tailHold.playAnim('hold');
                                }
                                else
                                    tailHold.visible = false;
                            }
                        }

                        if (tail.mustHit && tail.holding || !tail.mustHit)
                        {
                            if (tail.mustHit)
                            {
                                this.health += Constants.HEALTH_HOLD_BONUS_PER_SECOND * this.elapsed;
                                this.score += Math.floor(Constants.SCORE_HOLD_BONUS_PER_SECOND * this.elapsed);
                            }

                            if (tail.tailNote != null)
                            {
                                var clipHeight = ((tail.length - ((Conductor.instance.lastTime ?? 0) - tail.time)) * Constants.PIXELS_PER_MS * this.chart.getScrollSpeed());
                                if (clipHeight == null || clipHeight < 0) clipHeight = 0;
                                if (clipHeight > tail.tailNote.displayHeight) clipHeight = tail.tailNote.displayHeight;

                                if (clipHeight <= 0.1)
                                {
                                    if (followStrum != null)
                                        followStrum.canIdle = true;

                                    if (this.opponent != null)
                                        this.opponent.canIdle = true;

                                    var tailSplash = this.tailSplashes[tail.line + Strumline.KEY_COUNT];
                                    if (tailSplash != null)
                                    {
                                        tailSplash.visible = tail.mustHit;
                                        tailSplash.playAnim('splash');
                                    }

                                    tail.kill();
                                    this.tailNotes.splice(this.tailNotes.indexOf(tail), 1);
                                }
                                else if (clipHeight < tail.tailNote.displayHeight)
                                {
                                    if (followStrum != null)
                                        followStrum.canIdle = false;

                                    if (this.opponent != null)
                                        this.opponent.canIdle = false;

                                    if (!Constants.DOWN_SCROLL)
                                    {
                                        tail.tailNote.setCrop // V3 with correct clipping
                                        (
                                            0,
                                            ((followStrum != null ? followStrum.displayHeight / 2.75 : 0) + (this.pixelUI ? (Strumline.NOTE_SPACING * 0.24) : 0) + (tail.tailNote.displayHeight / 2) - tail.tailNote.y) / tail.tailNote.scaleY,
                                            tail.tailNote.width,
                                            clipHeight
                                        );
                                    }
                                    else
                                    {
                                        tail.tailNote.setCrop
                                        (
                                            0,
                                            ((followStrum != null ? followStrum.displayHeight / 2.75 : 0) - (tail.tailNote.displayHeight / 2) - tail.tailNote.y) / tail.tailNote.scaleY,
                                            tail.tailNote.width,
                                            clipHeight
                                        );
                                    }

                                    var tailHold = this.tailSplashes[tail.line + (tail.mustHit ? Strumline.KEY_COUNT : 0)];
                                    if (tailHold != null)
                                    {
                                        tailHold.visible = true;
                                        if (tailHold.anims.getName() != 'hold')
                                            tailHold.playAnim('hold');
                                    }
                                }
                            }
                        }

                        if (tail.hasMissed)
                        {
                            this.health -= Constants.HEALTH_HOLD_DROP_PENALTY * this.elapsed;

                            if (tail.time < Conductor.instance.lastTime - Strumline.get_RENDER_DISTANCE_MS())
                            {
                                tail.kill();
                                this.tailNotes.splice(this.tailNotes.indexOf(tail), 1);
                            }
                        }

                        var followNote = tail.followNote;

                        if (followNote != null)
                        {
                            tail.setX(tail.x + (followNote.displayWidth / 2));
                            tail.setY(tail.y + (followNote.displayHeight / 2));
                        }
                    }
                }

                updateInput()
                {
                    for (var key of Controls.list.get('note_left'))
                    {
                        if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key))) this.onKeyDown(0);
                        else if (Phaser.Input.Keyboard.JustUp(this.input.keyboard.addKey(key))) this.onKeyUp(0);
                    }

                    for (var key of Controls.list.get('note_down'))
                    {
                        if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key))) this.onKeyDown(1);
                        else if (Phaser.Input.Keyboard.JustUp(this.input.keyboard.addKey(key))) this.onKeyUp(1);
                    }

                    for (var key of Controls.list.get('note_up'))
                    {
                        if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key))) this.onKeyDown(2);
                        else if (Phaser.Input.Keyboard.JustUp(this.input.keyboard.addKey(key))) this.onKeyUp(2);
                    }

                    for (var key of Controls.list.get('note_right'))
                    {
                        if (Phaser.Input.Keyboard.JustDown(this.input.keyboard.addKey(key))) this.onKeyDown(3);
                        else if (Phaser.Input.Keyboard.JustUp(this.input.keyboard.addKey(key))) this.onKeyUp(3);
                    }
                }

                onKeyDown(line)
                {
                    if (this.playerStrumline.strums[line] != null)
                    {
                        this.playerStrumline.held[line] = true;

                        var lineNotes = [];
                        for (var note of this.notes)
                            if (note.mayHit && !note.hasMissed && note.line == line)
                                lineNotes.push(note);

                        if (!Constants.GHOST_TAPPING && lineNotes.length == 0)
                        {
                            this.ghostNoteMiss(line);
                        }
                        else if (lineNotes.length > 0)
                        {
                            var targetNote = lineNotes[0];
                            for (var note of lineNotes)
                                if (Math.abs(Conductor.instance.lastTime - note.time) < Math.abs(Conductor.instance.lastTime - targetNote.time))
                                    targetNote = note;

                            this.goodNoteHit(targetNote);

                            for (var tail of this.tailNotes)
                                if (tail.followNote == targetNote)
                                    tail.holding = true;

                            targetNote.kill();
                            this.notes.splice(this.notes.indexOf(targetNote), 1);

                            this.playerStrumline.strums[line].playAnim('confirm');
                            return;
                        }

                        this.playerStrumline.strums[line].playAnim('press');
                    }
                }

                ghostNoteMiss(line)
                {
                    this.health -= Constants.HEALTH_MISS_PENALTY;
                    this.score -= 10;

                    this.song.onPlayerMiss();
                    this.sound.add('missnote' + Math.floor(Math.random() * (3 - 1) + 1), {volume: Math.random() * (0.2 - 0.1) + 0.1, loop: false}).play();
                }

                onNoteMiss(note, healthChange)
                {
                    if (Highscore.tallies.combo != 0) if (Highscore.tallies.combo >= 10) this.comboPopUps.displayCombo(0);

                    for (var tail of this.tailNotes)
                        if (tail.followNote == note)
                            tail.hasMissed = true;

                    this.applyScore(-10, 'miss', healthChange, true);

                    this.song.onPlayerMiss();
                    this.sound.add('missnote' + Math.floor(Math.random() * (3 - 1) + 1), {volume: Math.random() * (0.6 - 0.5) + 0.5, loop: false}).play();
                }

                goodNoteHit(note)
                {
                    var noteDiff = Math.floor(Conductor.instance.lastTime - note.time);

                    var noteScore = Scoring.scoreNote(noteDiff, ScoringSystem.PBOT1);
                    var daRating = Scoring.judgeNote(noteDiff, ScoringSystem.PBOT1);

                    var healthChange = 0.0;
                    var isComboBreak = false;

                    switch (daRating)
                    {
                        case 'sick':
                            healthChange = Constants.HEALTH_SICK_BONUS;
                            isComboBreak = Constants.JUDGEMENT_SICK_COMBO_BREAK;
                            break;
                        case 'good':
                            healthChange = Constants.HEALTH_GOOD_BONUS;
                            isComboBreak = Constants.JUDGEMENT_GOOD_COMBO_BREAK;
                            break;
                        case 'bad':
                            healthChange = Constants.HEALTH_BAD_BONUS;
                            isComboBreak = Constants.JUDGEMENT_BAD_COMBO_BREAK;
                            break;
                        case 'shit':
                            isComboBreak = Constants.JUDGEMENT_SHIT_COMBO_BREAK;
                            healthChange = Constants.HEALTH_SHIT_BONUS;
                            break;
                    }

                    Highscore.tallies.totalNotesHit++;

                    if (this.player != null) this.player.playAnim(['singLEFT', 'singDOWN', 'singUP', 'singRIGHT'][note.line]);

                    if (daRating == 'sick')
                    {
                        var foundSplash = false;
                        if (this.noteSplashes.length > 0)
                        {
                            for (var splash of this.noteSplashes)
                            {
                                if (splash.animFinished && !foundSplash)
                                {
                                    splash.revive(note);
                                    foundSplash = true;
                                }
                            }
                        }
                        
                        if (!foundSplash)
                            this.createNoteSplash(note);
                    }

                    this.song.onPlayerHit();

                    this.applyScore(noteScore, daRating, healthChange, isComboBreak);
                    this.popUpScore(daRating);
                }

                createNoteSplash(note)
                {
                    if (this.pixelUI)
                        return;

                    var splash = new NoteSplash(this, note);
                    this.add.existing(splash);
                    this.addToCameras(splash, [this.camHUD]);
                    this.noteSplashes.push(splash);
                }

                popUpScore(daRating, combo)
                {
                    if (daRating == 'miss')
                    {
                        console.log('popUpScore judged a note as a miss!');
                        return;
                    }

                    combo = combo ?? Highscore.tallies.combo;

                    this.comboPopUps.displayRating(daRating);
                    if (combo >= 10 || combo == 0) this.comboPopUps.displayCombo(combo);

                    this.song.onPlayerHit();
                }

                applyScore(noteScore, daRating, healthChange, isComboBreak)
                {
                    switch (daRating)
                    {
                        case 'sick':
                            Highscore.tallies.sick += 1;
                            break;
                        case 'good':
                            Highscore.tallies.good += 1;
                            break;
                        case 'bad':
                            Highscore.tallies.bad += 1;
                            break;
                        case 'shit':
                            Highscore.tallies.shit += 1;
                            break;
                        case 'miss':
                            Highscore.tallies.missed += 1;
                            break;
                    }

                    this.health += healthChange;

                    if (isComboBreak)
                    {
                        if (Highscore.tallies.combo >= 10) this.comboPopUps.displayCombo(0);
                        Highscore.tallies.combo = 0;
                    }
                    else
                    {
                        Highscore.tallies.combo++;
                        if (Highscore.tallies.combo > Highscore.tallies.maxCombo) Highscore.tallies.maxCombo = Highscore.tallies.combo;
                    }

                    this.score += noteScore;
                }

                onKeyUp(line)
                {
                    if (this.playerStrumline.held[line] != null)
                    {
                        this.playerStrumline.strums[line].playAnim('static');
                        this.playerStrumline.held[line] = false;
                    }

                    for (var tail of this.tailNotes)
                    {
                        if (tail.line == line && tail.holding)
                        {
                            tail.holding = false;

                            var tailHold = this.tailSplashes[tail.line + (tail.mustHit ? Strumline.KEY_COUNT : 0)];
                            if (tailHold != null)
                            {
                                tailHold.visible = false;
                                tailHold.playAnim('hold');
                            }

                            tail.kill();
                            this.tailNotes.splice(this.tailNotes.indexOf(tail), 1);
                        }
                    }
                }

                updateHealthbar()
                {
                    var maxHealth = (this.healthBar != null ? this.healthBar.healthMax : Constants.HEALTH_MAX);
                    if (this.health > maxHealth) this.health = maxHealth;
                    if (this.health < 0) this.health = 0;

                    this.healthLerp = TSMath.baseLerp(this.healthLerp, this.health, 0.15);
                    if (this.healthBar != null)
                    {
                        this.healthBar.health = this.healthLerp;
                        this.healthBar.update();
                    }

                    var healthPercent = ((maxHealth - this.health) / maxHealth) * 100;
                    var focusedAnim = 'normal';
                    if (healthPercent <= 20)
                        focusedAnim = 'dead';

                    if (this.iconP2 != null)
                        if (this.iconP2.anims.getName() != focusedAnim)
                            this.iconP2.anims.play(focusedAnim);

                    focusedAnim = 'normal';
                    if (healthPercent >= 80)
                    {
                        focusedAnim = 'dead';

                        if (this.girlfriend != null)
                        {
                            if (this.girlfriend.curCharacter == 'nene' && !this.girlfriend.knifeRaised)
                            {
                                this.girlfriend.knifeRaised = true;
                                this.girlfriend.playAnim('raiseKnife');
                                this.girlfriend.specialAnim = true;
                            }
                        }
                    }
                    else if (this.girlfriend != null)
                    {
                        if (this.girlfriend.curCharacter == 'nene' && this.girlfriend.knifeRaised)
                        {
                            this.girlfriend.knifeRaised = false;
                            this.girlfriend.playAnim('lowerKnife');
                            this.girlfriend.specialAnim = true;
                        }
                    }

                    if (this.iconP1 != null)
                        if (this.iconP1.anims.getName() != focusedAnim)
                            this.iconP1.anims.play(focusedAnim);

                    if (this.health <= 0)
                    {
                        this.song.stop();
                        // DeathType.DEFAULT, DeathType.PIXEL, DeathType.PICO
                        this.switchState("GameOverState", GameOverState);
                    }
                }

                updateIcons()
                {
                    if (this.healthBar != null)
                    {
                        var width = (this.healthBar.barBack != null ? this.healthBar.barBack.width : 0);

                        if (this.iconP1 != null)
                        {
                            this.iconP1.x = this.healthBar.x + (width * (TSMath.remapToRange(this.healthLerp, 0, 2, 100, 0) * 0.01) - HealthIcon.POSITION_OFFSET);
                            this.iconP1.y = this.healthBar.y - (this.iconP1.height / 2);
                        }
                        
                        if (this.iconP2 != null)
                        {
                            this.iconP2.x = this.healthBar.x + (width * (TSMath.remapToRange(this.healthLerp, 0, 2, 100, 0) * 0.01)) - ((this.iconP2.width * this.iconP2.scaleX) - HealthIcon.POSITION_OFFSET);
                            this.iconP2.y = this.healthBar.y - (this.iconP2.height / 2);
                        }
                    }

                    if (this.iconP1 != null) this.iconP1.scaleX = this.iconP1.scaleY = TSMath.fpsLerp(this.iconP1.scaleX, 1, 0.15, this.elapsed);
                    if (this.iconP2 != null) this.iconP2.scaleX = this.iconP2.scaleY = TSMath.fpsLerp(this.iconP2.scaleX, 1, 0.15, this.elapsed);
                }

                updateCamera(lerp)
                {
                    this.camFollow.lerpX = TSMath.baseLerp(this.camFollow.lerpX, this.camFollow.x, lerp);
                    this.camFollow.lerpY = TSMath.baseLerp(this.camFollow.lerpY, this.camFollow.y, lerp);
                    this.cameras.main.centerOn(this.camFollow.lerpX, this.camFollow.lerpY);

                    this.cameras.main.zoom = TSMath.baseLerp(this.defaultZoom, this.cameras.main.zoom, 0.95);
                    this.camHUD.zoom = TSMath.baseLerp(1, this.camHUD.zoom, 0.95);
                }

                switchCamera(character)
                {
                    if (character == 0 && this.player != null)
                    {
                        this.camFollow.x = this.player.camFollow[0];
                        this.camFollow.y = this.player.camFollow[1];
                    }
                    else if (character == 1 && this.opponent != null)
                    {
                        this.camFollow.x = this.opponent.camFollow[0];
                        this.camFollow.y = this.opponent.camFollow[1];
                    }
                    else if (character == 2 && this.girlfriend != null)
                    {
                        this.camFollow.x = this.girlfriend.camFollow[0];
                        this.camFollow.y = this.girlfriend.camFollow[1];
                    }
                }

                addToCameras(item, cameras = [])
                {
                    var allCameras = [this.cameras.main, this.camHUD, this.camPause];
                    for (var cam of allCameras)
                        if (!cameras.includes(cam))
                            cam.ignore(item);
                }

                stepHit(step)
                {
                    this.stage.onStepHit(step);

                    if (step % Math.floor(16 / this.camBopRate) == 0 && Constants.CAMERA_ZOOMING)
                    {
                        this.cameras.main.zoom += 0.015 * this.camBopIntensity;
                        this.camHUD.zoom += 0.03 * this.camBopIntensity;
                    }
                }

                beatHit(beat)
                {
                    this.stage.onBeatHit(beat);

                    if (this.aBot != null) this.aBot.anims.play('idle');
                    if (this.girlfriend != null && !this.girlfriend.anims.getName().startsWith("sing") && (this.girlfriend.anims.exists('danceLeft') && this.girlfriend.anims.exists('danceRight') && (this.girlfriend.curCharacter != 'nene' || !this.girlfriend.knifeRaised) || beat % 2 == 0)) this.girlfriend.dance();
                    if (this.opponent != null && !this.opponent.anims.getName().startsWith("sing") && (this.opponent.anims.exists('danceLeft') && this.opponent.anims.exists('danceRight') || beat % 2 == 0)) this.opponent.dance();
                    if (this.player != null && !this.player.anims.getName().startsWith("sing") && (this.player.anims.exists('danceLeft') && this.player.anims.exists('danceRight') || beat % 2 == 0)) this.player.dance();

                    this.iconP1.scaleX = this.iconP1.scaleY = 1.2;
                    this.iconP2.scaleX = this.iconP2.scaleY = 1.2;
                }

                sectionHit(section)
                {
                    this.stage.onSectionHit(section);

                    if (this.chart.chartType == ChartType.LEGACY)
                    {
                        var notes = this.chart.getNotes();
                        if (notes[section] != null)
                        {
                            this.switchCamera((notes[section].mustHitSection ?? false) ? 0 : 1);
                            if (notes[section].changeBPM ?? false)
                                Conductor.instance.bpm = notes[section].bpm ?? Constants.DEFAULT_BPM;
                        }
                    }
                }

                exit()
                {
                    this.endedSong = true;
                    this.song.stop();

                    var finalTallies = (PlayState.playlist.isStoryMode ? Highscore.talliesLevel : Highscore.tallies);
                    Highscore.tallies = new Tallies();
                    Highscore.talliesLevel = new Tallies();

                    MusicBeatState.music = this.sound.add('freakyMenu', {volume: 0.7, loop: true});
                    MusicBeatState.music.play();

                    if (PlayState.playlist.isStoryMode) this.switchState("StoryMenuState", StoryMenuState);
                    else
                    {
                        MainMenuState.openFreeplayOnReady = true;
                        this.switchState("MainMenuState", MainMenuState);
                    }

                    PlayState.playlist = null;
                }
            }

            class Main
            {
                static app;

                static initialize(scene = null, width = 1280, height = 720, title = null)
                {
                    Controls.initialize();
                    
                    SongRegistry.initialize();
                    ChartRegistry.initialize();
                    CharacterRegistry.initialize();
                    HealthIconRegistry.initialize();
                    PreferenceRegistry.initialize();
                    LevelRegistry.initialize(); // HAS to come after SongRegistry because it uses it

                    Conductor.instance = new Conductor(0);

                    var header = title ?? 'Funkin';
                    document.title = header;

                    this.app = new Phaser.Game
                    ({
                        title: header,
                        width: width ?? 1280,
                        height: height ?? 720,
                        parent: 'app',
                        scene: scene ?? [],
                        backgroundColor: '#000000',
                        physics:
                        {
                        default: "arcade",
                        arcade: { debug: false }
                        },
                        autoFocus: false,
                        autoCenter: Phaser.Scale.CENTER_BOTH
                    });
                }
            }

            Main.initialize(TitleState, Constants.SCREEN_WIDTH, Constants.SCREEN_HEIGHT, Constants.TITLE);
        </script>
    </body>
</html>
